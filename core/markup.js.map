{"version":3,"sources":["core/markup.js"],"names":[],"mappings":"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","file":"core/markup.js","sourcesContent":["import _ from 'underscore';\nvar Highlight = require(\"highlight.js\");\nvar HTTP = require(\"q-io/http\");\nvar MathJax = require(\"mathjax-node/lib/mj-single.js\");\nvar URL = require(\"url\");\nvar XRegExp = require(\"xregexp\");\n\nimport Board from '../boards/board';\nvar config = require(\"../helpers/config\");\nvar Database = require(\"../helpers/database\");\nvar Permissions = require(\"../helpers/permissions\");\nvar Tools = require(\"../helpers/tools\");\n\nimport * as Renderer from './renderer';\nimport * as MiscModel from '../models/misc';\nimport Logger from '../helpers/logger';\n\nMathJax.config({ MathJax: {} });\nMathJax.start();\n\nvar SkipTypes = {\n    NoSkip: \"NO_SKIP\",\n    HtmlSkip: \"HTML_SKIP\",\n    CodeSkip: \"CODE_SKIP\"\n};\n\nvar MarkupModes = {\n    ExtendedWakabaMark: \"EXTENDED_WAKABA_MARK\",\n    BBCode: \"BB_CODE\"\n};\n\nvar MarkupTags = {\n    \"---\": {\n        op: \"<s>\",\n        cl: \"</s>\"\n    },\n    \"***\": {\n        op: \"<u>\",\n        cl: \"</u>\"\n    },\n    \"**\": {\n        op: \"<strong>\",\n        cl: \"</strong>\"\n    },\n    \"*\": {\n        op: \"<em>\",\n        cl: \"</em>\"\n    },\n    \"___\": {\n        op: \"<u>\",\n        cl: \"</u>\"\n    },\n    \"__\": {\n        op: \"<strong>\",\n        cl: \"</strong>\"\n    },\n    \"_\": {\n        op: \"<em>\",\n        cl: \"</em>\"\n    },\n    \"///\": {\n        op: \"<em>\",\n        cl: \"</em>\"\n    },\n    \"%%\": {\n        op: \"<span class=\\\"spoiler\\\">\",\n        cl: \"</span>\"\n    },\n    \"[b]\": {\n        op: \"<strong>\",\n        cl: \"</strong>\"\n    },\n    \"[i]\": {\n        op: \"<em>\",\n        cl: \"</em>\"\n    },\n    \"[s]\": {\n        op: \"<s>\",\n        cl: \"</s>\"\n    },\n    \"[u]\": {\n        op: \"<u>\",\n        cl: \"</u>\"\n    },\n    \"[sub]\": {\n        op: \"<sub>\",\n        cl: \"</sub>\"\n    },\n    \"[sup]\": {\n        op: \"<sup>\",\n        cl: \"</sup>\"\n    },\n    \"[spoiler]\": {\n        op: \"<span class=\\\"spoiler\\\">\",\n        cl: \"</span>\"\n    },\n};\n\nvar ListTypes = {\n    d: \"disc\",\n    c: \"circle\",\n    s: \"square\"\n};\n\nasync function markupLaTeX(text, inline) {\n  return await new Promise(function(resolve, reject) {\n    MathJax.typeset({\n      math: text,\n      format: inline ? 'inline-TeX' : 'TeX',\n      svg: true\n    }, (data) => {\n      if (data.errors) {\n        return reject(data.errors[0] || data.errors);\n      }\n      let tagName = inline ? 'span' : 'div';\n      resolve(`<${tagName} class='latex-${inline ? 'inline' : 'block'}'>${data.svg}</${tagName}>`);\n    });\n  });\n}\n\nvar isEscaped = function(s, pos) {\n    if (pos <= 0 || pos >= s.length)\n        return false;\n    var n = 0;\n    var i = pos - 1;\n    while (i >= 0 && s[i] == \"\\\\\") {\n        ++n;\n        --i;\n    }\n    return (n % 2);\n};\n\nvar withoutEscaped = function(text) {\n    var rx = /``|''/gi;\n    var ind = text.lastIndexOf(rx);\n    while (ind >= 0) {\n        if (isEscaped(text, ind)) {\n            text.remove(ind - 1, 1);\n            ind = text.lastIndexOf(rx, ind - text.length - 3);\n            continue;\n        }\n        ind = text.lastIndexOf(rx, ind - text.length - 2);\n    }\n    return text;\n};\n\nvar matchTwitterLink = function(href) {\n    return config(\"site.twitter.integrationEnabled\", true)\n        && href.match(/^https?\\:\\/\\/twitter\\.com\\/[^\\/]+\\/status\\/\\d+\\/?$/);\n};\n\nvar matchYoutubeLink = function(href) {\n    return href.match(/^https?\\:\\/\\/(m\\.|www\\.)?youtube\\.com\\/.*v\\=[^\\/]+.*$/)\n        || href.match(/^https?\\:\\/\\/youtu\\.be\\/[^\\/]+.*$/);\n};\n\nvar matchCoubLink = function(href) {\n    return href.match(/^https?:\\/\\/coub\\.com\\/view\\/[^\\/\\?]+.*$/);\n};\n\nvar matchVocarooLink = function(href) {\n    return href.match(/^https?:\\/\\/vocaroo\\.com\\/i\\/[a-zA-Z0-9]+$/);\n};\n\nvar getTwitterEmbeddedHtml = function(href, defaultHtml) {\n    return HTTP.request({\n        method: \"GET\",\n        url: `https://api.twitter.com/1/statuses/oembed.json?url=${href}`,\n        timeout: Tools.MINUTE //TODO: magic numbers\n    }).then(function(response) {\n        if (response.status != 200)\n            return Promise.reject(new Error(Tools.translate(\"Failed to get Twitter embedded HTML\")));\n        return response.body.read();\n    }).then(function(data) {\n        try {\n            return Promise.resolve(JSON.parse(data.toString()).html);\n        } catch (err) {\n            return Promise.reject(err);\n        }\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n        return Promise.resolve(defaultHtml);\n    }).then(function(html) {\n        return Promise.resolve(html);\n    });\n};\n\nvar youtubeVideoStartTime = function(href) {\n    if (!href)\n        return null;\n    var t = URL.parse(href, true).query.t;\n    if (!t)\n        return null;\n    var match = t.match(/((\\d+)h)?((\\d+)m)?((\\d+)s)?/);\n    if (!match)\n        return null;\n    var start = 0;\n    if (match[2])\n        start += +match[2] * 3600;\n    if (match[4])\n        start += +match[4] * 60;\n    if (match[6])\n        start += +match[6];\n    if (isNaN(start) || start <= 0)\n        return null;\n    return start;\n};\n\nvar getYoutubeEmbeddedHtml = function(href, defaultHtml) {\n    var match = href.match(/^https?\\:\\/\\/.*youtube\\.com\\/.*v\\=([^\\/#\\?&]+).*$/);\n    var videoId = match ? match[1] : null;\n    if (!videoId) {\n        match = href.match(/^https?\\:\\/\\/youtu\\.be\\/([^\\/#\\?]+).*$/);\n        videoId = match ? match[1] : null;\n    }\n    var apiKey = config(\"server.youtubeApiKey\", \"\");\n    if (!videoId || !apiKey)\n        return Promise.resolve(defaultHtml);\n    return HTTP.request({\n        method: \"GET\",\n        url: `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&key=${apiKey}&part=snippet`,\n        timeout: Tools.MINUTE //TODO: magic numbers\n    }).then(function(response) {\n        if (response.status != 200)\n            return Promise.reject(new Error(Tools.translate(\"Failed to get YouTube embedded HTML\")));\n        return response.body.read();\n    }).then(function(data) {\n        try {\n            var response = JSON.parse(data.toString());\n            if (!response.items || response.items.length < 1)\n                return Promise.reject(new Error(Tools.translate(\"Failed to get YouTube video info\")));\n            var info = response.items[0].snippet;\n            info.id = videoId;\n            info.href = href;\n            info.start = youtubeVideoStartTime(href);\n            let html = Renderer.render('markup/youtubeVideoLink', { info: info });\n            if (!html)\n                return Promise.reject(new Error(Tools.translate(\"Failed to create YouTube video link\")));\n            return Promise.resolve(html);\n        } catch (err) {\n            return Promise.reject(err);\n        }\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n        return Promise.resolve(defaultHtml);\n    }).then(function(html) {\n        return Promise.resolve(html);\n    });\n};\n\nvar getCoubEmbeddedHtml = function(href, defaultHtml) {\n    var match = href.match(/^https?:\\/\\/coub\\.com\\/view\\/([^\\/\\?#]+).*$/);\n    var videoId = match ? match[1] : null;\n    if (!videoId)\n        return Promise.resolve(defaultHtml);\n    return HTTP.request({\n        method: \"GET\",\n        url: `https://coub.com/api/oembed.json?url=http://coub.com/view/${videoId}`,\n        timeout: Tools.MINUTE //TODO: magic numbers\n    }).then(function(response) {\n        if (response.status != 200)\n            return Promise.reject(new Error(Tools.translate(\"Failed to get Coub embedded HTML\")));\n        return response.body.read();\n    }).then(function(data) {\n        try {\n            var response = JSON.parse(data.toString());\n            if (!response)\n                return Promise.reject(new Error(Tools.translate(\"Failed to get Coub video info\")));\n            var info = {\n                href: href,\n                videoTitle: response.title,\n                authorName: response.author_name,\n                thumbnail: response.thumbnail_url ? {\n                    url: response.thumbnail_url,\n                    width: response.thumbnail_width,\n                    height: response.thumbnail_height\n                } : null,\n                id: videoId\n            };\n            let html = Renderer.render('markup/coubVideoLink', { info: info });\n            if (!html)\n                return Promise.reject(new Error(Tools.translate(\"Failed to create Coub video link\")));\n            return Promise.resolve(html);\n        } catch (err) {\n            return Promise.reject(err);\n        }\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n        return Promise.resolve(defaultHtml);\n    }).then(function(html) {\n        return Promise.resolve(html);\n    });\n};\n\nvar getVocarooEmbeddedHtml = function(href, defaultHtml) {\n    var match = href.match(/^https?:\\/\\/vocaroo\\.com\\/i\\/([a-zA-Z0-9]+)$/);\n    var audioId = match ? match[1] : null;\n    if (!audioId)\n        return Promise.resolve(defaultHtml);\n    let html = Renderer.render('markup/vocarooAudioLink', { info: { id: audioId } });\n    if (!html)\n        return Promise.reject(new Error(Tools.translate(\"Failed to create Vocaroo audio embedded container\")));\n    return Promise.resolve(html);\n};\n\nvar ProcessingInfo = function(text, boardName, referencedPosts, deletedPost, referencesToReplace) {\n    this.boardName = boardName;\n    this.deletedPost = deletedPost;\n    this.referencedPosts = referencedPosts;\n    this.referencesToReplace = referencesToReplace;\n    this.text = text;\n    this.skipList = [];\n};\n\nProcessingInfo.prototype.find = function(rx, from, escapable) {\n    from = (+from > 0) ? from : 0;\n    if (typeof rx == \"string\") {\n        var ind = this.text.indexOf(rx, from);\n        while (ind >= 0) {\n            var isIn = false;\n            for (var i = 0; i < this.skipList.length; ++i) {\n                var inf = this.skipList[i];\n                if (ind >= inf.from && ind < (inf.from + inf.length)) {\n                    ind = this.text.indexOf(rx, inf.from + inf.length);\n                    isIn = true;\n                    break;\n                }\n            }\n            if (!isIn) {\n                if (escapable && isEscaped(this.text, ind)) {\n                    ind = this.text.indexOf(rx, ind + 1);\n                } else {\n                    return {\n                        0: rx,\n                        index: ind\n                    };\n                }\n            }\n        }\n    } else {\n        rx.lastIndex = from;\n        var match = rx.exec(this.text);\n        while (match) {\n            var isIn = false;\n            for (var i = 0; i < this.skipList.length; ++i) {\n                var inf = this.skipList[i];\n                if (match && match.index >= inf.from && match.index < (inf.from + inf.length)) {\n                    rx.lastIndex = inf.from + inf.length;\n                    match = rx.exec(this.text);\n                    isIn = true;\n                    break;\n                }\n            }\n            if (!isIn && match) {\n                if (escapable && isEscaped(this.text, match.index)) {\n                    rx.lastIndex = match.index + 1;\n                    match = rx.exec(this.text);\n                } else {\n                    return match;\n                }\n            }\n        }\n    }\n    return null;\n};\n\nProcessingInfo.prototype.isIn = function(start, length, type) {\n    if (start < 0 || length <= 0 || (start + length) > this.text.length || SkipTypes.NoSkip == type)\n        return false;\n    type = type || SkipTypes.CodeSkip;\n    for (var i = 0; i < this.skipList.length; ++i) {\n        var inf = this.skipList[i];\n        if (inf.type != type)\n            continue;\n        var x = start;\n        while (x < start + length) {\n            if (x >= inf.from && x <= (inf.from + inf.length))\n                return true;\n            ++x;\n        }\n    }\n    return false;\n};\n\nProcessingInfo.prototype.insert = function(from, txt, type) {\n    if (from < 0 || txt.length <= 0 || from > this.text.length)\n        return;\n    type = type || SkipTypes.HtmlSkip;\n    var info = {\n        from: from,\n        length: txt.length,\n        type: type\n    };\n    var found = false;\n    for (var i = this.skipList.length - 1; i >= 0; --i) {\n        var inf = this.skipList[i];\n        if (from > inf.from) {\n            if (SkipTypes.NoSkip != type)\n                this.skipList.splice(i + 1, 0, info);\n            found = true;\n            break;\n        }\n        inf.from += txt.length;\n    }\n    if (!found && SkipTypes.NoSkip != type)\n        this.skipList.unshift(info);\n    this.text = this.text.substr(0, from) + txt + this.text.substr(from);\n};\n\nProcessingInfo.prototype.replace = function(from, length, txt, correction, type) {\n    if (from < 0 || length <= 0 || (txt.length < 1) || (length + from) > this.text.length)\n        return;\n    type = type || SkipTypes.HtmlSkip;\n    var info = {\n        from: from,\n        length: txt.length,\n        type: type\n    };\n    var dlength = txt.length - length;\n    var found = false;\n    for (var i = this.skipList.length - 1; i >= 0; --i) {\n        var inf = this.skipList[i];\n        if (from >= inf.from) {\n            if (SkipTypes.NoSkip != type)\n                this.skipList.splice(i + 1, 0, info);\n            found = true;\n            break;\n        }\n        if (inf.from < (from + length))\n            inf.from -= correction;\n        else\n            inf.from += dlength;\n    }\n    if (!found && SkipTypes.NoSkip != type)\n        this.skipList.unshift(info);\n    this.text = this.text.substr(0, from) + txt + this.text.substr(from + length);\n};\n\nProcessingInfo.prototype.toHtml = function() {\n    var s = \"\";\n    var last = 0;\n    for (var i = 0; i < this.skipList.length; ++i) {\n        var inf = this.skipList[i];\n        s += Tools.toHtml(withoutEscaped(this.text.substr(last, inf.from - last)));\n        s += this.text.substr(inf.from, inf.length);\n        last = inf.from + inf.length;\n    }\n    s += Tools.toHtml(this.text.substr(last));\n    s = s.replace(/<\\/li>(\\s|&nbsp;|<br \\/>)+<li/g, \"</li><li\");\n    s = s.replace(/<\\/li>(\\s|&nbsp;|<br \\/>)+<\\/ul/g, \"</li></ul\");\n    s = s.replace(/<\\/li>(\\s|&nbsp;|<br \\/>)+<\\/ol/g, \"</li></ol\");\n    s = s.replace(/<ol>(\\s|&nbsp;|<br \\/>)+<li/g, \"<ol><li\");\n    var rx = /<ul type\\=\"(disc|circle|square)\">(\\s|&nbsp;|<br \\/>)+<li/g;\n    var match = rx.exec(s);\n    while (match) {\n        var ns = \"<ul type=\\\"\" + match[1] + \"\\\"><li\";\n        s = s.substr(0, match.index) + ns + s.substr(match.index + match[0].length);\n        rx.lastIndex = ns.length;\n        match = rx.exec(s);\n    }\n    return s;\n};\n\nvar getIndE = function(info, rxOp, matchs, rxCl, inds, nestable, escapable, nested) {\n    nested.nested = false;\n    if (!nestable)\n        return (inds >= 0) ? info.find(rxCl, inds + matchs[0].length, escapable) : -1;\n    if (inds >= 0) {\n        var matchst = info.find(rxOp, inds + matchs[0].length, escapable);\n        var matchet = info.find(rxCl, inds + matchs[0].length, escapable);\n        var depth = 1;\n        while (matchst || matchet) {\n            var tmp = (matchst && (!matchet || matchst.index < matchet.index)) ? matchst : matchet;\n            var offs = (matchst && (!matchet || matchst.index < matchet.index)) ? matchst[0].length : matchet[0].length;\n            depth += (tmp.index == (matchst ? matchst.index : -1)) ? 1 : -1;\n            if (depth > 1)\n                nested.nested = true;\n            if (!depth)\n                return tmp;\n            matchst = info.find(rxOp, tmp.index + offs, escapable);\n            matchet = info.find(rxCl, tmp.index + offs, escapable);\n        }\n    }\n    return null;\n};\n\nvar process = function(info, conversionFunction, regexps, options) {\n    var rxOp = regexps.op;\n    var rxCl = regexps.hasOwnProperty(\"cl\") ? regexps.cl : rxOp;\n    var nestable = options && options.nestable;\n    var escapable = options && options.escapable;\n    var checkFunction = options ? options.checkFunction : undefined;\n    var nested = {\n        nested: false\n    };\n    var matchs = info.find(rxOp, 0, escapable);\n    var matche = rxCl ? getIndE(info, rxOp, matchs, rxCl, matchs ? matchs.index : -1, nestable, escapable, nested)\n        : null;\n    var rerun = false;\n    var f = function() {\n        if (!matchs || (rxCl && (!matche || matche.index <= matchs.index)))\n            return Promise.resolve();\n        if (checkFunction && !checkFunction(info, matchs, matche)) {\n            if (rxCl && matche)\n                matchs = info.find(rxOp, matche.index + matche[0].length, escapable);\n            else\n                matchs = info.find(rxOp, matchs.index + matchs[0].length, escapable);\n            matche = rxCl ? getIndE(info, rxOp, matchs, rxCl, matchs ? matchs.index : -1, nestable, escapable, nested)\n                : null;\n            return f();\n        }\n        var options = {\n            op: \"\",\n            cl: \"\",\n            type: SkipTypes.NoSkip\n        };\n        var start = matche ? (matchs.index + matchs[0].length) : matchs.index;\n        var end = matche ? (matche.index - matchs.index - matchs[0].length) : (matchs.index + matchs[0].length);\n        var txt = info.text.substr(start, end);\n        return conversionFunction(info, txt, matchs, matche, options).then(function(ntxt) {\n            txt = ntxt;\n            if (txt) {\n                if (options.cl)\n                    info.insert(rxCl ? (matche.index + matche[0].length) : matchs.index + matchs[0].length, options.cl);\n                if (rxCl) {\n                    info.replace(matchs.index, matche.index - matchs.index + matche[0].length, txt, matchs[0].length,\n                        options.type);\n                } else {\n                    info.replace(matchs.index, matchs[0].length, txt, matchs[0].length, options.type);\n                }\n                if (options.op)\n                    info.insert(matchs.index, options.op);\n                matchs = info.find(rxOp, matchs.index + txt.length + options.op.length + options.cl.length, escapable);\n            } else {\n                if (rxCl) {\n                    matchs = info.find(rxOp, matche ? (matche.index + matche[0].length)\n                        : (matchs.index + matchs[0].length), escapable);\n                } else {\n                    matchs = info.find(rxOp, matchs.index + matchs[0].index, escapable);\n                }\n            }\n            if (nestable && nested.nested)\n                rerun = true;\n            matche = rxCl ? getIndE(info, rxOp, matchs, rxCl, matchs ? matchs.index : -1, nestable, escapable, nested)\n                : null;\n            return f();\n        });\n    };\n    return f().then(function() {\n        if (rerun)\n            return process(info, conversionFunction, {\n                op: rxOp,\n                cl: rxCl\n            }, {\n                nestable: nestable,\n                escapable: escapable,\n                checkFunction: checkFunction\n            });\n        return Promise.resolve();\n    })\n};\n\nvar processStrikedOutShitty = function(info) {\n    var rx = /(\\^H)+/gi;\n    var match = info.find(rx);\n    while (match) {\n        var s = match.index - (match[0].length / 2);\n        if (s < 0) {\n            match = info.find(rx, match.index + match[0].length);\n            continue;\n        }\n        info.replace(match.index, match[0].length, \"</s>\", 0);\n        info.insert(s, \"<s>\");\n        match = info.find(rx, match.index + 7);\n    }\n    return Promise.resolve();\n};\n\nvar processStrikedOutShittyWord = function(info) {\n    var rx = /(\\^W)+/gi;\n    var match = info.find(rx);\n    var txt = info.text;\n    while (match) {\n        var count = match[0].length / 2;\n        var pcount = count;\n        var s = match.index - 1;\n        while (count > 0) {\n            while (s >= 0 && /\\s/.test(txt[s]))\n                --s;\n            while (s >= 0 && !/\\s/.test(txt[s]))\n                --s;\n            --count;\n        }\n        info.replace(match.index, match[0].length, \"</s>\", 0);\n        info.insert(s + 1, \"<s>\");\n        match = info.find(rx, match.index + (7 * pcount));\n    }\n    return Promise.resolve();\n};\n\nvar checkLangsMatch = function(info, matchs, matche) {\n    return matchs && matche && matchs[1] && matchs[1] == matche[1];\n};\n\nvar checkExternalLink = function(info, matchs) {\n    if (matchs.index > 0 && [\"@\", \"#\"].indexOf(info.text[matchs.index - 1]) >= 0)\n        return false;\n    return /^\\d+\\.\\d+\\.\\d+\\.\\d+$/.test(matchs[2]) || Tools.externalLinkRootZoneExists(matchs[4]);\n};\n\nvar checkQuotationNotInterrupted = function(info, matchs, matche) {\n    if (info.isIn(matchs.index, matche.index - matchs.index))\n        return false;\n    if (0 == matchs.index)\n        return true;\n    if (\"\\n\" == info.text.substr(matchs.index - 1, 1))\n        return true;\n    return (info.isIn(matchs.index - 6, 6, SkipTypes.HtmlSkip) && info.text.substr(matchs.index - 6, 6) == \"<br />\");\n};\n\nvar convertMonospace = function(_, text, __, ___, options) {\n    options.op = \"<font face=\\\"monospace\\\">\";\n    options.cl = \"</font>\";\n    options.type = SkipTypes.CodeSkip;\n    return Promise.resolve(Tools.toHtml(withoutEscaped(text)));\n};\n\nvar convertNomarkup = function(_, text, __, ___, options) {\n    options.type = SkipTypes.CodeSkip;\n    return Promise.resolve(Tools.toHtml(withoutEscaped(text)));\n};\n\nvar convertPre = function(_, text, __, ___, options) {\n    options.op = \"<pre>\";\n    options.cl = \"</pre>\";\n    options.type = SkipTypes.CodeSkip;\n    text = withoutEscaped(text).split(\"&\").join(\"&amp;\").split(\"<\").join(\"&lt;\").split(\">\").join(\"&gt;\");\n    text = text.split(\"\\\"\").join(\"&quot;\");\n    return Promise.resolve(text);\n};\n\nfunction markupCode(text, lang) {\n  if (lang) {\n    lang = lang.replace('++', 'pp').replace('#', 's'); //TODO: You know, this is not OK.\n  }\n  Highlight.configure({\n    tabReplace: '    ',\n    useBR: true\n  });\n  let result = lang ? Highlight.highlight(lang, text, true) : Highlight.highlightAuto(text);\n  text = result.value;\n  lang = result.language || lang;\n  let langClass = lang ? ` ${lang}` : '';\n  let langNames = MiscModel.codeLangNames();\n  let langName = langNames.hasOwnProperty(lang) ? langNames[lang] : lang;\n  return {\n    op: `<div class=\"code-block${langClass} hljs js-with-tooltip\" title=\"${langName || ''}\">`,\n    cl: '</div>',\n    text: Highlight.fixMarkup(text)\n  };\n}\n\nvar convertCode = function(_, text, matchs, __, options) {\n  options.type = SkipTypes.CodeSkip;\n  let result = markupCode(text, matchs[1]);\n  options.op = result.op;\n  options.cl = result.cl;\n  return Promise.resolve(result.text);\n};\n\nvar convertVkontaktePost = function(_, __, matchs, ___, options) {\n    options.type = SkipTypes.HtmlSkip;\n    return Promise.resolve(\"<div class=\\\"overflow-x-container\\\">\" + matchs[0] + \"</div>\");\n};\n\nvar convertExternalLink = function(info, text, matchs, __, options) {\n    if (!text)\n        return Promise.resolve(\"\");\n    options.type = SkipTypes.HtmlSkip;\n    if (info.isIn(matchs.index, matchs[0].length, SkipTypes.HtmlSkip))\n        return Promise.resolve(text);\n    var href = matchs[0];\n    if (href.lastIndexOf(\"http\", 0) && href.lastIndexOf(\"ftp\", 0))\n        href = \"http://\" + href;\n    var def = \"<a href=\\\"\" + href + \"\\\">\" + Tools.toHtml(matchs[0]) + \"</a>\";\n    if (matchTwitterLink(href))\n        return getTwitterEmbeddedHtml(href, def);\n    if (matchYoutubeLink(href))\n        return getYoutubeEmbeddedHtml(href, def);\n    if (matchCoubLink(href))\n        return getCoubEmbeddedHtml(href, def);\n    if (matchVocarooLink(href))\n        return getVocarooEmbeddedHtml(href, def);\n    return Promise.resolve(def);\n};\n\nvar convertProtocol = function(_, __, matchs, ___, options) {\n    options.type = SkipTypes.HtmlSkip;\n    return Promise.resolve(\"<a href=\\\"\" + matchs[0] + \"\\\">\" + Tools.toHtml(matchs[2]) + \"</a>\");\n};\n\nvar convertTooltipShitty = function(_, __, matchs, ___, options) {\n    options.type = SkipTypes.NoSkip;\n    var tooltip = matchs[2];\n    options.op = \"<span class=\\\"tooltip js-with-tooltip\\\" title=\\\"\" + tooltip + \"\\\">\";\n    options.cl = \"</span>\";\n    return Promise.resolve(matchs[1]);\n};\n\nvar convertPostLink = function(info, _, matchs, __, options) {\n    options.type = SkipTypes.HtmlSkip;\n    var boardName = (matchs.length > 2) ? matchs[1] : info.boardName;\n    var postNumber = +matchs[(matchs.length > 2) ? 2 : 1];\n    var escaped = matchs[0].split(\">\").join(\"&gt;\");\n    if (postNumber && (postNumber != info.deletedPost)) {\n        return Database.db.hget(\"posts\", boardName + \":\" + postNumber).then(function(post) {\n            if (!post)\n                return escaped;\n            post = JSON.parse(post);\n            if (info.referencedPosts) {\n                var key = boardName + \":\" + postNumber;\n                if (!info.referencedPosts[key]) {\n                    info.referencedPosts[key] = {\n                        boardName: boardName,\n                        postNumber: postNumber,\n                        threadNumber: post.threadNumber,\n                        createdAt: Tools.now()\n                    };\n                }\n            }\n            var href = \"href=\\\"/\" + config(\"site.pathPrefix\", \"\") + boardName + \"/res/\" + post.threadNumber + \".html\";\n            if (postNumber != post.threadNumber)\n                href += \"#\" + postNumber;\n            href += \"\\\"\";\n            var result = \"<a \" + href;\n            if (postNumber === post.threadNumber) {\n              result += ' class=\"op-post-link\"';\n            }\n            result += \" data-board-name=\\\"\" + boardName + \"\\\" data-post-number=\\\"\" + postNumber\n                + \"\\\" data-thread-number=\\\"\" + post.threadNumber + \"\\\">\" + escaped + \"</a>\";\n            return result;\n        });\n    } else {\n        return Promise.resolve(escaped);\n    }\n};\n\nvar convertHtml = function(_, text, __, ___, options) {\n    options.type = SkipTypes.HtmlSkip;\n    return Promise.resolve(text);\n};\n\nvar convertMarkup = function(_, text, matchs, __, options) {\n    options.type = SkipTypes.NoSkip;\n    if (\"----\" == matchs[0])\n        return Promise.resolve(\"\\u2014\");\n    else if (\"--\" == matchs[0])\n        return Promise.resolve(\"\\u2013\");\n    var tag = MarkupTags[matchs[0]];\n    if (!tag)\n        return Promise.resolve(\"\");\n    options.op = tag.op;\n    options.cl = tag.cl;\n    return Promise.resolve(text);\n};\n\nvar convertLatex = function(inline, _, text, matchs, __, options) {\n    options.type = SkipTypes.HtmlSkip;\n    return markupLaTeX(text, inline);\n};\n\nvar convertUrl = function(info, text, matchs, matche, options) {\n    if (!text)\n        return Promise.resolve(\"\");\n    options.type = SkipTypes.HtmlSkip;\n    if (info.isIn(matchs.index, matchs[0].length, SkipTypes.HtmlSkip))\n        return Promise.resolve(text);\n    var href = text;\n    if (href.lastIndexOf(\"http\", 0) && href.lastIndexOf(\"ftp\", 0))\n        href = \"http://\" + href;\n    var def = \"<a href=\\\"\" + href + \"\\\">\" + Tools.toHtml(text) + \"</a>\"\n    if (matchTwitterLink(href))\n        return getTwitterEmbeddedHtml(href, def);\n    if (matchYoutubeLink(href))\n        return getYoutubeEmbeddedHtml(href, def);\n    if (matchCoubLink(href))\n        return getCoubEmbeddedHtml(href, def);\n    if (matchVocarooLink(href))\n        return getVocarooEmbeddedHtml(href, def);\n    return Promise.resolve(def);\n};\n\nvar convertCSpoiler = function(_, text, matchs, __, options) {\n    var title = matchs[1];\n    if (!title)\n        title = \"Spoiler\";\n    options.type = SkipTypes.NoSkip;\n    options.op = \"<span class=\\\"collapsible-spoiler\\\"><span class=\\\"collapsible-spoiler-title\\\" title=\\\"Spoiler\\\" \"\n        + \"onclick=\\\"lord.expandCollapseSpoiler(this);\\\">\" + title\n        + \"</span><span class=\\\"collapsible-spoiler-body\\\" style=\\\"display: none;\\\">\";\n    options.cl = \"</span></span>\";\n    return Promise.resolve(text);\n};\n\nvar convertTooltip = function(_, text, matchs, __, options) {\n    var tooltip = matchs[1];\n    options.type = SkipTypes.NoSkip;\n    options.op = \"<span class=\\\"tooltip js-with-tooltip\\\" title=\\\"\" + tooltip + \"\\\">\";\n    options.cl = \"</span>\";\n    return Promise.resolve(text);\n};\n\nvar convertUnorderedList = function(_, text, matchs, __, options) {\n    var t = matchs[2];\n    if (!t)\n        t = \"disc\";\n    else if (t.length == 1)\n        t = ListTypes[t];\n    if (!t)\n        return Promise.resolve(\"\");\n    options.type = SkipTypes.NoSkip;\n    options.op = `<ul type=\"${t}\">`;\n    options.cl = \"</ul>\";\n    return Promise.resolve(text);\n};\n\nvar convertOrderedList = function(_, text, matchs, __, options) {\n    var t = matchs[2];\n    if (!t)\n        t = \"1\";\n    options.type = SkipTypes.NoSkip;\n    options.op = `<ol type=\"${t}\">`;\n    options.cl = \"</ol>\";\n    return Promise.resolve(text);\n};\n\nvar convertListItem = function(_, text, matchs, __, options) {\n    options.type = SkipTypes.NoSkip;\n    options.op = \"<li\";\n    if (matchs[2])\n        op += \" value=\\\"\" + matchs[2] + \"\\\"\";\n    options.op += \">\";\n    options.cl = \"</li>\";\n    return Promise.resolve(text);\n};\n\nvar convertCitation = function(_, text, matchs, matche, options) {\n    options.type = SkipTypes.NoSkip;\n    if (matchs[1] == \"\\n\")\n        options.op = \"<br />\";\n    options.op += \"<span class=\\\"quotation\\\">&gt;\";\n    options.cl = \"</span>\";\n    if (matche[0] == \"\\n\")\n        options.cl += \"<br />\";\n    return Promise.resolve(text);\n};\n\nvar processPostText = function(boardName, text, options) {\n    if (!text)\n        return Promise.resolve(null);\n    var deletedPost = (options && +(options.deletedPost) > 0) ? options.deletedPost : 0;\n    var markupModes = (options && options.markupModes) ? options.markupModes : [\n        MarkupModes.ExtendedWakabaMark,\n        MarkupModes.BBCode\n    ];\n    var accessLevel = (options && options.accessLevel) || null;\n    var c = {};\n    var langs = [];\n    Highlight.listLanguages().forEach(function(lang) {\n        langs.push(lang);\n        var aliases = Highlight.getLanguage(lang).aliases;\n        if (aliases) {\n            aliases.forEach(function(alias) {\n                langs.push(alias);\n            });\n        }\n    });\n    langs.splice(langs.indexOf(\"cpp\") + 1, 0, \"c++\");\n    langs.splice(langs.indexOf(\"cs\") + 1, 0, \"c#\");\n    langs.splice(langs.indexOf(\"fsharp\") + 1, 0, \"f#\");\n    langs = langs.join(\"|\").split(\"+\").join(\"\\\\+\").split(\"-\").join(\"\\\\-\").split(\".\").join(\"\\\\.\");\n    text = text.replace(/\\r+\\n/g, \"\\n\").replace(/\\r/g, \"\\n\");\n    var info = new ProcessingInfo(text, boardName, options ? options.referencedPosts : null, deletedPost,\n        options ? options.referencesToReplace : null);\n    var p = Promise.resolve();\n    if (markupModes.indexOf(MarkupModes.ExtendedWakabaMark) >= 0) {\n        p = p.then(function() {\n            return process(info, convertMonospace, { op: \"``\" }, { escapable: true });\n        }).then(function() {\n            return process(info, convertNomarkup, { op: \"''\" }, { escapable: true });\n        }).then(function() {\n            return process(info, convertPre, {\n                op: /\\/\\\\-\\\\-pre\\s+/g,\n                cl: /\\s+\\\\\\\\\\\\-\\\\-/g\n            });\n        }).then(function() {\n            return process(info, convertCode, {\n                op: new RegExp(\"/\\\\-\\\\-code\\\\s+(\" + langs + \")\\\\s+\", \"gi\"),\n                cl: /\\s+\\\\\\\\\\\\-\\\\-/g\n            });\n        }).then(function() {\n            return process(info, convertLatex.bind(null, false), { op: \"$$$\" });\n        }).then(function() {\n            return process(info, convertLatex.bind(null, true), { op: \"$$\" });\n        });\n    }\n    if (markupModes.indexOf(MarkupModes.BBCode) >= 0) {\n        if (Tools.compareRegisteredUserLevels(accessLevel, Permissions.useRawHTMLMarkup()) >= 0) {\n            p = p.then(function() {\n                return process(info, convertHtml, {\n                    op: \"[raw-html]\",\n                    cl: \"[/raw-html]\"\n                });\n            });\n        }\n        p = p.then(function() {\n            return process(info, convertPre, {\n                op: \"[pre]\",\n                cl:\"[/pre]\"\n            });\n        }).then(function() {\n            return process(info, convertCode, {\n                op: \"[code]\",\n                cl: \"[/code]\"\n            });\n        }).then(function() {\n            return process(info, convertCode, {\n                op: new RegExp(\"\\\\[code\\\\s+lang\\\\=\\\"?(\" + langs + \")\\\"?\\\\s*\\\\]\", \"gi\"),\n                cl: \"[/code]\"\n            });\n        }).then(function() {\n            return process(info, convertCode, {\n                op: new RegExp(\"\\\\[(\" + langs + \")\\\\]\", \"gi\"),\n                cl: new RegExp(\"\\\\[/(\" + langs + \")\\\\]\", \"gi\")\n            }, { checkFunction: checkLangsMatch });\n        }).then(function() {\n            return process(info, convertMonospace, {\n                op: \"[m]\",\n                cl: \"[/m]\"\n            });\n        }).then(function() {\n            return process(info, convertNomarkup, {\n                op: \"[n]\",\n                cl: \"[/n]\"\n            });\n        }).then(function() {\n            return process(info, convertLatex.bind(null, false), {\n                op: \"[latex]\",\n                cl: \"[/latex]\"\n            });\n        }).then(function() {\n            return process(info, convertLatex.bind(null, true), {\n                op: \"[l]\",\n                cl: \"[/l]\"\n            });\n        });\n    }\n    if (markupModes.indexOf(MarkupModes.ExtendedWakabaMark) >= 0 || markupModes.indexOf(MarkupModes.BBCode) >= 0) {\n        p = p.then(function() {\n            if (!config(\"site.vkontakte.integrationEnabled\", false))\n                return Promise.resolve();\n            return process(info, convertVkontaktePost, {\n                op: /<div id\\=\"vk_post_\\-?\\d+_\\d+\"><\\/div><script type=\"text\\/javascript\">  \\(function\\(d\\, s\\, id\\) \\{ var js\\, fjs \\= d\\.getElementsByTagName\\(s\\)\\[0\\]; if \\(d\\.getElementById\\(id\\)\\) return; js \\= d\\.createElement\\(s\\); js\\.id \\= id; js\\.src \\= \"\\/\\/vk\\.com\\/js\\/api\\/openapi\\.js\\?121\"; fjs\\.parentNode\\.insertBefore\\(js\\, fjs\\); \\}\\(document\\, 'script'\\, 'vk_openapi_js'\\)\\);  \\(function\\(\\) \\{    if \\(\\!window\\.VK \\|\\| \\!VK\\.Widgets \\|\\| \\!VK\\.Widgets\\.Post \\|\\| \\!VK\\.Widgets\\.Post\\(\"vk_post_\\-?\\d+_\\d+\"\\, (\\-?\\d+)\\, (\\d+)\\, '([a-zA-Z0-9_\\-]+)'\\, \\{width\\: 500\\}\\)\\) setTimeout\\(arguments\\.callee\\, 50\\);  \\}\\(\\)\\);<\\/script>/g,\n                cl: null\n            });\n        }).then(function() {\n            return process(info, convertUrl, {\n                op: \"[url]\",\n                cl: \"[/url]\"\n            });\n        }).then(function() {\n            return process(info, convertExternalLink, {\n                op: new XRegExp(Tools.EXTERNAL_LINK_REGEXP_PATTERN, \"gi\"),\n                cl: null\n            }, { checkFunction: checkExternalLink });\n        }).then(function() {\n            return process(info, convertProtocol, {\n                op: /(mailto|irc|news)\\:(\\S+)/gi,\n                cl: null\n            });\n        }).then(function() {\n            return processStrikedOutShitty(info);\n        }).then(function() {\n            return processStrikedOutShittyWord(info);\n        }).then(function() {\n            return process(info, convertTooltipShitty, {\n                op: /([^\\?\\s]+)\\?{3}\"([^\"]+)\"/gi,\n                cl: null\n            });\n        }).then(function() {\n            return process(info, convertPostLink, {\n                op: />>([1-9][0-9]*)/gi,\n                cl: null\n            });\n        }).then(function() {\n            var boards = Board.boardNames().join(\"|\");\n            return process(info, convertPostLink, {\n                op: new RegExp(\">>/(\" + boards + \")/([1-9][0-9]*)\", \"gi\"),\n                cl: null\n            });\n        }).then(function() {\n            return process(info, convertMarkup, {\n                op: \"----\",\n                cl: null\n            });\n        });\n    }\n    if (markupModes.indexOf(MarkupModes.ExtendedWakabaMark) >= 0) {\n        p = p.then(function() {\n            return process(info, convertMarkup, { op: \"---\" });\n        });\n    }\n    if (markupModes.indexOf(MarkupModes.ExtendedWakabaMark) >= 0 || markupModes.indexOf(MarkupModes.BBCode) >= 0) {\n        p = p.then(function() {\n            return process(info, convertMarkup, {\n                op: \"--\",\n                cl: null\n            });\n        });\n    }\n    if (markupModes.indexOf(MarkupModes.ExtendedWakabaMark) >= 0) {\n        p = p.then(function() {\n            return process(info, convertMarkup, { op: \"***\" });\n        }).then(function() {\n            return process(info, convertMarkup, { op: \"**\" });\n        }).then(function() {\n            return process(info, convertMarkup, { op: \"*\" });\n        }).then(function() {\n            return process(info, convertMarkup, { op: \"___\" });\n        }).then(function() {\n            return process(info, convertMarkup, { op: \"__\" });\n        }).then(function() {\n            return process(info, convertMarkup, { op: \"_\" });\n        }).then(function() {\n            return process(info, convertMarkup, { op: \"///\" });\n        }).then(function() {\n            return process(info, convertCSpoiler, { op: \"%%%\" });\n        }).then(function() {\n            return process(info, convertMarkup, { op: \"%%\" });\n        });\n    }\n    if (markupModes.indexOf(MarkupModes.BBCode) >= 0) {\n        p = p.then(function() {\n            return process(info, convertMarkup, {\n                op: \"[b]\",\n                cl: \"[/b]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertMarkup, {\n                op: \"[i]\",\n                cl: \"[/i]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertMarkup, {\n                op: \"[s]\",\n                cl: \"[/s]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertMarkup, {\n                op: \"[u]\",\n                cl: \"[/u]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertMarkup, {\n                op: \"[sub]\",\n                cl: \"[/sub]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertMarkup, {\n                op: \"[sup]\",\n                cl: \"[/sup]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertMarkup, {\n                op: \"[spoiler]\",\n                cl: \"[/spoiler]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertCSpoiler, {\n                op: \"[cspoiler]\",\n                cl: \"[/cspoiler]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertCSpoiler, {\n                op: /\\[cspoiler\\s+title\\=\"([^\"]*)\"\\s*\\]/gi,\n                cl: \"[/cspoiler]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertTooltip, {\n                op: /\\[tooltip\\s+value\\=\"([^\"]*)\"\\s*\\]/gi,\n                cl: \"[/tooltip]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertUnorderedList, {\n                op: /\\[ul(\\s+type\\=\"?(disc|circle|square|d|c|s)\"?)?\\s*\\]/gi,\n                cl: \"[/ul]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertOrderedList, {\n                op: /\\[ol(\\s+type\\=\"?(A|a|I|i|1)\"?)?\\s*\\]/gi,\n                cl: \"[/ol]\"\n            }, { nestable: true });\n        }).then(function() {\n            return process(info, convertListItem, {\n                op: /\\[li(\\s+value\\=\"?(\\d+)\"?\\s*)?\\]/gi,\n                cl: \"[/li]\"\n            }, { nestable: true });\n        });\n    }\n    if (markupModes.indexOf(MarkupModes.ExtendedWakabaMark) >= 0 || markupModes.indexOf(MarkupModes.BBCode) >= 0) {\n        p = p.then(function() {\n            return process(info, convertCitation, {\n                op: \">\",\n                cl: /\\n|$/gi\n            }, { checkFunction: checkQuotationNotInterrupted });\n        });\n    }\n    return p.then(function() {\n        return info.toHtml();\n    });\n};\n\nObject.defineProperty(processPostText, \"MarkupModes\", { value: MarkupModes });\nObject.defineProperty(processPostText, \"markupCode\", { value: markupCode });\n\nprocessPostText.markupModes = function(string) {\n  if (typeof string !== 'string') {\n    string = '';\n  }\n  return _(MarkupModes).filter((mode) => { return string.indexOf(mode) >= 0; });\n};\n\nprocessPostText.latex = markupLaTeX;\n\nmodule.exports = processPostText;\n"],"sourceRoot":"/source/"}