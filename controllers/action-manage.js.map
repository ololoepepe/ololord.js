{"version":3,"sources":["controllers/action-manage.js"],"names":[],"mappings":"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","file":"controllers/action-manage.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport FS from 'q-io/fs';\nimport HTTP from 'q-io/http';\nimport merge from 'merge';\nvar moment = require(\"moment\");\nimport UUID from 'uuid';\n\nimport Board from '../boards/board';\nvar Captcha = require(\"../captchas\");\nvar Chat = require(\"../helpers/chat\");\nvar config = require(\"../helpers/config\");\nvar Database = require(\"../helpers/database\");\nvar markup = require(\"../core/markup\");\n\nimport * as FilesModel from '../models/files';\nimport * as PostsModel from '../models/posts';\nimport * as UsersModel from '../models/users';\nimport PostCreationTransaction from '../storage/post-creation-transaction';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport * as Files from '../storage/files';\nimport geolocation from '../storage/geolocation';\n\nlet router = express.Router();\n\nfunction getRegisteredUserData(fields) {\n  let ips = Tools.ipList(fields.ips);\n  if (typeof ips === 'string') {\n    return Promise.reject(new Error(ips));\n  }\n  let levels = _(fields).reduce((acc, value, name) => {\n    let match = name.match(/^accessLevelBoard_(\\S+)$/);\n    if (match && 'NONE' !== value) {\n      acc[match[1]] = value;\n    }\n    return acc;\n  });\n  return {\n    levels: levels,\n    ips: ips\n  };\n}\n\nrouter.post('/action/registerUser', async function(req, res, next) {\n  try {\n    if (!req.isSuperuser()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields } = await Tools.parseForm(req);\n    let { password } = fields;\n    if (!password) {\n      throw new Error(Tools.translate('Invalid password'));\n    }\n    let { levels, ips } = getRegisteredUserData(fields);\n    let hashpass = Tools.mayBeHashpass(password) ? password : Tools.toHashpass(password);\n    await UsersModel.registerUser(hashpass, levels, ips);\n    res.json({ hashpass: hashpass });\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/updateRegisteredUser', async function(req, res, next) {\n  try {\n    if (!req.isSuperuser()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields } = await Tools.parseForm(req);\n    let { hashpass } = fields;\n    if (!hashpass || !Tools.mayBeHashpass(hashpass)) {\n      throw new Error(Tools.translate('Invalid hashpass'));\n    }\n    let { levels, ips } = getRegisteredUserData(fields);\n    await UsersModel.updateRegisterUser(hashpass, levels, ips);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/unregisterUser', async function(req, res, next) {\n  try {\n    if (!req.isSuperuser()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields: { hashpass } } = await Tools.parseForm(req);\n    if (!hashpass || !Tools.mayBeHashpass(hashpass)) {\n      throw new Error(Tools.translate('Invalid hashpass'));\n    }\n    await UsersModel.unregisterUser(hashpass);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/superuserAddFile', async function(req, res, next) {\n  try {\n    if (!req.isSuperuser()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields: { dir, fileName, isDir }, files } = await Tools.parseForm(req);\n    if (!dir || typeof dir !== 'string') {\n      throw new Error(Tools.translate('Invalid dir'));\n    }\n    if (!fileName || typeof fileName !== 'string') {\n      throw new Error(Tools.translate('Invalid file name'));\n    }\n    await Files.createFile(dir, fileName, {\n      isDir: ('true' === isDir),\n      file: _(files).toArray()[0]\n    });\n    res.json({});\n  } catch (err) {\n    next(Tools.processError(err, true));\n  }\n});\n\nrouter.post('/action/superuserEditFile', async function(req, res, next) {\n  try {\n    if (!req.isSuperuser()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields: { fileName, content } } = await Tools.parseForm(req);\n    if (!fileName || typeof fileName !== 'string') {\n      throw new Error(Tools.translate('Invalid file name'));\n    }\n    await Files.editFile(fileName, content);\n    res.json({});\n  } catch (err) {\n    next(Tools.processError(err, false));\n  }\n});\n\nrouter.post('/action/superuserRenameFile', async function(req, res, next) {\n  try {\n    if (!req.isSuperuser()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields: { oldFileName, fileName } } = await Tools.parseForm(req);\n    if (!oldFileName || typeof oldFileName !== 'string' || !fileName || typeof fileName !== 'string') {\n      throw new Error(Tools.translate('Invalid file name'));\n    }\n    await Files.renameFile(oldFileName, fileName);\n    res.json({});\n  } catch (err) {\n    next(Tools.processError(err));\n  }\n});\n\nrouter.post('/action/superuserDeleteFile', async function(req, res, next) {\n  try {\n    if (!req.isSuperuser()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields: { fileName } } = await Tools.parseForm(req);\n    if (!fileName || typeof fileName !== 'string') {\n      throw new Error(Tools.translate('Invalid file name'));\n    }\n    await Files.deleteFile(fileName);\n    res.json({});\n  } catch (err) {\n    next(Tools.processError(err));\n  }\n});\n\nrouter.post(\"/action/superuserRerenderCache\", function(req, res, next) {\n    if (!req.isSuperuser())\n        return next(Tools.translate(\"Not enough rights\"));\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.rerenderArchive = (\"true\" == result.fields.rerenderArchive);\n        return IPC.send('stop');\n    }).then(function() {\n        return IPC.send('rerenderCache', c.rerenderArchive); //TODO\n    }).then(function() {\n        return IPC.send('start');\n    }).then(function() {\n        res.json({});\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post('/action/superuserRerenderPosts', async function(req, res, next) {\n  try {\n    if (!req.isSuperuser()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields: { targets } } = await Tools.parseForm(req);\n    if (typeof targets !== 'string') {\n      throw new Error(Tools.translate('Invalid targets'));\n    }\n    await PostsModel.rerenderPosts(Tools.rerenderPostsTargetsFromString(targets));\n    //TODO: Rerender corresponding pages?\n    res.json({});\n  } catch (err) {\n    next(Tools.processError(err));\n  }\n});\n\nrouter.post(\"/action/superuserRebuildSearchIndex\", function(req, res, next) {\n    if (!req.isSuperuser())\n        return next(Tools.translate(\"Not enough rights\"));\n    IPC.send('stop').then(function() {\n        return Database.rebuildSearchIndex();\n    }).then(function() {\n        return IPC.send('start');\n    }).then(function() {\n        res.json({});\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/superuserReload\", function(req, res, next) {\n    if (!req.isSuperuser())\n        return next(Tools.translate(\"Not enough rights\"));\n    var c = { list: [] };\n    Tools.parseForm(req).then(function(result) {\n        if (\"true\" == result.fields.boards)\n            c.list.push(\"boards\");\n        if (\"true\" == result.fields.config)\n            c.list.push(\"config\");\n        if (\"true\" == result.fields.templates)\n            c.list.push(\"templates\");\n        if (c.list.length < 1)\n            return Promise.resolve();\n        return IPC.send('stop');\n    }).then(function() {\n        return Tools.series(c.list, function(action) {\n            switch (action) {\n            case \"boards\":\n                return IPC.send('reloadBoards');\n            case \"config\":\n                return IPC.send('reloadConfig');\n            case \"templates\":\n                return IPC.send('reloadTemplates');\n            default:\n                return Promise.resolve();\n            }\n        });\n    }).then(function() {\n        if (c.list.length < 1)\n            return Promise.resolve();\n        return IPC.send('start');\n    }).then(function() {\n        res.json({});\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nexport default router;\n"],"sourceRoot":"/source/"}