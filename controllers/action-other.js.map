{"version":3,"sources":["controllers/action-other.js"],"names":[],"mappings":"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","file":"controllers/action-other.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport FS from 'q-io/fs';\nimport HTTP from 'q-io/http';\nimport merge from 'merge';\nvar moment = require(\"moment\");\nimport UUID from 'uuid';\n\nimport Board from '../boards/board';\nimport Captcha from '../captchas/captcha';\nvar Chat = require(\"../helpers/chat\");\nvar config = require(\"../helpers/config\");\nvar markup = require(\"../core/markup\");\n\nimport * as FilesModel from '../models/files';\nimport * as PostsModel from '../models/posts';\nimport * as UsersModel from '../models/users';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport * as Files from '../storage/files';\nimport geolocation from '../storage/geolocation';\nimport PostCreationTransaction from '../storage/post-creation-transaction';\n\nlet router = express.Router();\n\nrouter.post(\"/action/sendChatMessage\", function(req, res, next) {\n    Tools.parseForm(req).then(function(result) {\n        var fields = result.fields;\n        return Chat.sendMessage({\n            ip: req.ip,\n            hashpass: req.hashpass\n        }, fields.boardName, +fields.postNumber, fields.text);\n    }).then(function(result) {\n        res.send({});\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/deleteChatMessages\", function(req, res, next) {\n    Tools.parseForm(req).then(function(result) {\n        var fields = result.fields;\n        return Chat.deleteMessages({\n            ip: req.ip,\n            hashpass: req.hashpass\n        }, fields.boardName, fields.postNumber);\n    }).then(function(result) {\n        res.send(result);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/synchronize\", function(req, res, next) {\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.key = result.fields.key;\n        if (!c.key)\n            return Promise.reject(Tools.translate(\"No key specified\"));\n        var data = result.fields.data;\n        try {\n            data = JSON.parse(data);\n        } catch (err) {\n            return Promise.reject(err);\n        }\n        return Database.db.set(\"synchronizationData:\" + c.key, JSON.stringify(data));\n    }).then(function() {\n        return Database.db.expire(\"synchronizationData:\" + c.key, 300); //NOTE: 5 minutes\n    }).then(function() {\n        res.send({});\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/search\", function(req, res, next) {\n    var c = { model: {} };\n    Tools.parseForm(req).then(function(result) {\n        var fields = result.fields;\n        c.query = fields.query || \"\";\n        if (!c.query)\n            return Promise.reject(Tools.translate(\"Search query is empty\"));\n        if (c.query.length > config(\"site.maxSearchQueryLength\", 50))\n            return Promise.reject(Tools.translate(\"Search query is too long\"));\n        var boardName = fields.boardName || \"\";\n        if (\"*\" == boardName)\n            boardName = \"\";\n        var page = fields.page || 0;\n        c.model.searchQuery = c.query;\n        c.model.searchBoard = boardName;\n        c.phrases = Tools.splitCommand(c.query);\n        if (!c.phrases || !c.phrases.command)\n            return Promise.reject(Tools.translate(\"Invalid search query\"));\n        c.phrases = [c.phrases.command].concat(c.phrases.arguments);\n        c.query = {\n            requiredPhrases: [],\n            excludedPhrases: [],\n            possiblePhrases: []\n        };\n        c.phrases.forEach(function(phrase) {\n            if (phrase.substr(0, 1) == \"+\")\n                c.query.requiredPhrases.push(phrase.substr(1).toLowerCase());\n            else if (phrase.substr(0, 1) == \"-\")\n                c.query.excludedPhrases.push(phrase.substr(1).toLowerCase());\n            else\n                c.query.possiblePhrases.push(phrase.toLowerCase());\n        });\n        c.model.phrases = c.query.requiredPhrases.concat(c.query.excludedPhrases).concat(c.query.possiblePhrases);\n        c.model.phrases = Tools.withoutDuplicates(c.model.phrases);\n        return Database.findPosts(c.query, boardName, page);\n    }).then(function(result) {\n        var posts = result.posts;\n        c.model.searchResults = posts.map(function(post) {\n            var text = post.plainText || \"\";\n            text = text.replace(/\\r*\\n+/g, \" \");\n            if (text.length > 300)\n                text = text.substr(0, 297) + \"...\";\n            var subject = post.subject || text;\n            if (subject.length > 100)\n                subject = subject.substr(0, 97) + \"...\";\n            return {\n                boardName: post.boardName,\n                postNumber: post.number,\n                threadNumber: post.threadNumber,\n                archived: post.archived,\n                subject: subject,\n                text: text\n            };\n        });\n        c.model.total = result.total;\n        c.model.max = result.max;\n        res.send(c.model);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nCaptcha.captchaIds().forEach(function(id) {\n    Captcha.captcha(id).actionRoutes().forEach(function(route) {\n        router[route.method](\"/action\" + route.path, route.handler);\n    });\n});\n\nBoard.boardNames().forEach(function(name) {\n    Board.board(name).actionRoutes().forEach(function(route) {\n        router[route.method](\"/action\" + route.path, route.handler);\n    });\n});\n\nmodule.exports = router;\n"],"sourceRoot":"/source/"}