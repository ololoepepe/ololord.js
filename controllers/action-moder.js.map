{"version":3,"sources":["controllers/action-moder.js"],"names":[],"mappings":"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","file":"controllers/action-moder.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport FS from 'q-io/fs';\nimport HTTP from 'q-io/http';\nimport merge from 'merge';\nvar moment = require(\"moment\");\nimport UUID from 'uuid';\n\nimport Board from '../boards/board';\nvar Captcha = require(\"../captchas/captcha\");\nvar Chat = require(\"../helpers/chat\");\nvar config = require(\"../helpers/config\");\nvar Database = require(\"../helpers/database\");\nvar markup = require(\"../core/markup\");\n\nimport * as FilesModel from '../models/files';\nimport * as PostsModel from '../models/posts';\nimport * as UsersModel from '../models/users';\nimport PostCreationTransaction from '../storage/post-creation-transaction';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport geolocation from '../storage/geolocation';\n\nlet router = express.Router();\n\nfunction getBans(fields) {\n  let { timeOffset } = fields;\n  let bans = _(fields).pick((value, name) => {\n    return /^banBoard_\\S+$/.test(name) && 'NONE' !== fields[`banLevel_${value}`];\n  });\n  timeOffset = Tools.option(timeOffset, 'number', config('site.timeOffset'), {\n    test: (o) => { return (o >= -720) && (o <= 840); } //TODO: magic numbers\n  });\n  bans = _(bans).reduce((acc, value, name) => {\n    let expiresAt = fields[`banExpires_${value}`];\n    if (expiresAt) {\n      let hours = Math.floor(timeOffset / 60);\n      let minutes = Math.abs(timeOffset) % 60;\n      let tz = ((timeOffset > 0) ? '+' : '') + ((Math.abs(hours) < 10) ? '0' : '') + hours + ':'\n        + ((minutes < 10) ? '0' : '') + minutes; //TODO: use pad function\n      expiresAt = +moment(`${expiresAt} ${tz}`, 'YYYY/MM/DD HH:mm ZZ'); //TODO: magic numbers\n      if (expiresAt < (_.now() + Tools.Second)) {\n        expiresAt = null;\n      }\n    } else {\n      expiresAt = null;\n    }\n    acc[boardName] = {\n      boardName: value,\n      expiresAt: expiresAt,\n      level: fields[`banLevel_${value}`],\n      reason: fields[`banReason_${value}`],\n      postNumber: Tools.option(fields[`banPostNumber_${value}`], 'number', null, { test: Tools.testPostNumber })\n    };\n    return acc;\n  }, {});\n}\n\nrouter.post('/action/banUser', async function(req, res, next) {\n  try {\n    if (!req.isModer()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields } = await Tools.parseForm(req);\n    let { userIp } = fields;\n    userIp = Tools.correctAddress(userIp);\n    if (!ip) {\n      throw new Error(Tools.translate('Invalid IP address'));\n    }\n    if (userIp === req.ip) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let bans = getBans(fields);\n    let banLevels = Tools.BAN_LEVELS.slice(1);\n    bans.each((ban) => {\n      if (!Board.board(ban.boardName)) {\n        throw new Error(Tools.translate('Invalid board: $[1]', '', ban.boardName));\n      }\n      if (banLevels.indexOf(ban.level) < 0) {\n        throw new Error(Tools.translate('Invalid ban level: $[1]', '', ban.level));\n      }\n    });\n    let oldBans = await UsersModel.getBannedUserBans(userIp);\n    let date = Tools.now();\n    let modifiedBanBoards = new Set();\n    let newBans = Board.boardNames().reduce((acc, boardName) => {\n      if (req.isModer(boardName)) {\n        if (bans.hasOwnProperty(boardName)) {\n          let ban = bans[boardName];\n          ban.createdAt = date;\n          acc[boardName] = ban;\n          modifiedBanBoards.add(boardName);\n        } else if (oldBans.hasOwnProperty(boardName)) {\n          modifiedBanBoards.add(boardName);\n        }\n      } else if (oldBans.hasOwnProperty(boardName)) {\n        acc[boardName] = oldBans[boardName];\n      }\n      return acc;\n    }, {});\n    let levels = UsersModel.getRegisteredUserLevelsByIp(userIp);\n    modifiedBanBoards.forEach((boardName) => {\n      let level = req.level(boardName);\n      if (!req.isSuperuser(boardName) && Tools.compareRegisteredUserLevels(level, levels[boardName]) <= 0) {\n        throw new Error(Tools.translate('Not enough rights'));\n      }\n    });\n    await UsersModel.banUser(userIp, newBans);\n    res.send({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post(\"/action/delall\", function(req, res, next) {\n    if (!req.isModer())\n        return next(Tools.translate(\"Not enough rights\"));\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        c.boardNames = Tools.toArray(Tools.filterIn(c.fields, function(boardName, key) {\n            return /^board_\\S+$/.test(key);\n        }));\n        if (c.boardNames.length < 1)\n            return Promise.reject(Tools.translate(\"No board specified\"));\n        return UsersModel.checkUserBan(req.ip, c.boardNames, { write: true });\n    }).then(function() {\n        return Database.delall(req, c.fields.userIp, c.boardNames);\n    }).then(function(result) {\n        res.send({});\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post('/action/moveThread', async function(req, res, next) {\n  try {\n    let { fields } = await Tools.parseForm(req);\n    let { boardName, threadNumber, targetBoardName, password } = fields;\n    if (!Board.board(boardName) || !Board.board(targetBoardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    if (sourceBoardName == targetBoardName) {\n      throw new Error(Tools.translate('Source and target boards are the same'));\n    }\n    threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!threadNumber) {\n      throw new Error(Tools.translate('Invalid thread number'));\n    }\n    if (!req.isModer(boardName) || !req.isModer(targetBoardName)) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, [boardName, targetBoardName], {\n      write: true,\n      geolocationInfo: geolocationInfo\n    });\n    await UsersModel.checkUserPermissions(req, boardName, threadNumber, 'moveThread', Tools.sha1(password));\n    let result = await ThreadsModel.moveThread(boardName, threadNumber, targetBoardName);\n    res.send(result);\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post(\"/action/setThreadFixed\", function(req, res, next) {\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        c.boardName = result.fields.boardName;\n        c.threadNumber = +result.fields.threadNumber;\n        return UsersModel.checkUserBan(req.ip, c.boardName, { write: true });\n    }).then(function() {\n        return Database.setThreadFixed(req, c.fields);\n    }).then(function(result) {\n        res.send(result);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/setThreadClosed\", function(req, res, next) {\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        c.boardName = result.fields.boardName;\n        c.threadNumber = +result.fields.threadNumber;\n        return UsersModel.checkUserBan(req.ip, c.boardName, { write: true });\n    }).then(function() {\n        return Database.setThreadClosed(req, c.fields);\n    }).then(function(result) {\n        res.send(result);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/setThreadUnbumpable\", function(req, res, next) {\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        c.boardName = result.fields.boardName;\n        c.threadNumber = +result.fields.threadNumber;\n        return UsersModel.checkUserBan(req.ip, c.boardName, { write: true });\n    }).then(function() {\n        return Database.setThreadUnbumpable(req, c.fields);\n    }).then(function(result) {\n        res.send(result);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nmodule.exports = router;\n"],"sourceRoot":"/source/"}