{"version":3,"sources":["controllers/action-moder.js"],"names":[],"mappings":"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","file":"controllers/action-moder.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport FS from 'q-io/fs';\nimport HTTP from 'q-io/http';\nimport merge from 'merge';\nvar moment = require(\"moment\");\nimport UUID from 'uuid';\n\nimport Board from '../boards/board';\nvar Captcha = require(\"../captchas/captcha\");\nvar Chat = require(\"../helpers/chat\");\nvar config = require(\"../helpers/config\");\nvar Database = require(\"../helpers/database\");\nvar markup = require(\"../core/markup\");\n\nimport * as FilesModel from '../models/files';\nimport * as PostsModel from '../models/posts';\nimport * as UsersModel from '../models/users';\nimport PostCreationTransaction from '../storage/post-creation-transaction';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport * as Files from '../storage/files';\nimport geolocation from '../storage/geolocation';\n\nlet router = express.Router();\n\nrouter.post(\"/action/moveThread\", function(req, res, next) {\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        return UsersModel.checkUserBan(req.ip, c.fields.boardName, { write: true });\n    }).then(function() {\n        return UsersModel.checkUserBan(req.ip, c.fields.targetBoardName, { write: true });\n    }).then(function() {\n        return Database.moveThread(req, c.fields);\n    }).then(function(result) {\n        res.send(result);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/banUser\", function(req, res, next) {\n    if (!req.isModer())\n        return next(Tools.translate(\"Not enough rights\"));\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.bans = [];\n        c.fields = result.fields;\n        c.userIp = result.fields.userIp;\n        Tools.forIn(result.fields, function(value, name) {\n            if (!/^banBoard_\\S+$/.test(name))\n                return;\n            var level = result.fields[\"banLevel_\" + value];\n            if (\"NONE\" == level)\n                return;\n            var expiresAt = result.fields[\"banExpires_\" + value];\n            if (expiresAt) {\n                var timeOffset = +c.fields.timeOffset;\n                if (isNaN(timeOffset) || timeOffset < -720 || timeOffset > 840)\n                    timeOffset = config(\"site.timeOffset\", 0);\n                var hours = Math.floor(timeOffset / 60);\n                var minutes = Math.abs(timeOffset) % 60;\n                var tz = ((timeOffset > 0) ? \"+\" : \"\") + ((Math.abs(hours) < 10) ? \"0\" : \"\") + hours + \":\"\n                    + ((minutes < 10) ? \"0\" : \"\") + minutes;\n                expiresAt = moment(expiresAt + \" \" + tz, \"YYYY/MM/DD HH:mm ZZ\");\n                if (+expiresAt < (+Tools.now() + Tools.Second))\n                    expiresAt = null;\n            } else {\n                expiresAt = null;\n            }\n            c.bans.push({\n                boardName: value,\n                expiresAt: +expiresAt ? expiresAt : null,\n                level: level,\n                reason: result.fields[\"banReason_\" + value],\n                postNumber: +result.fields[\"banPostNumber_\" + value] || null\n            });\n        });\n        return Database.banUser(req, c.fields.userIp, c.bans);\n    }).then(function(result) {\n        res.send({});\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/delall\", function(req, res, next) {\n    if (!req.isModer())\n        return next(Tools.translate(\"Not enough rights\"));\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        c.boardNames = Tools.toArray(Tools.filterIn(c.fields, function(boardName, key) {\n            return /^board_\\S+$/.test(key);\n        }));\n        if (c.boardNames.length < 1)\n            return Promise.reject(Tools.translate(\"No board specified\"));\n        return UsersModel.checkUserBan(req.ip, c.boardNames, { write: true });\n    }).then(function() {\n        return Database.delall(req, c.fields.userIp, c.boardNames);\n    }).then(function(result) {\n        res.send({});\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/setThreadFixed\", function(req, res, next) {\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        c.boardName = result.fields.boardName;\n        c.threadNumber = +result.fields.threadNumber;\n        return UsersModel.checkUserBan(req.ip, c.boardName, { write: true });\n    }).then(function() {\n        return Database.setThreadFixed(req, c.fields);\n    }).then(function(result) {\n        res.send(result);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/setThreadClosed\", function(req, res, next) {\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        c.boardName = result.fields.boardName;\n        c.threadNumber = +result.fields.threadNumber;\n        return UsersModel.checkUserBan(req.ip, c.boardName, { write: true });\n    }).then(function() {\n        return Database.setThreadClosed(req, c.fields);\n    }).then(function(result) {\n        res.send(result);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nrouter.post(\"/action/setThreadUnbumpable\", function(req, res, next) {\n    var c = {};\n    Tools.parseForm(req).then(function(result) {\n        c.fields = result.fields;\n        c.boardName = result.fields.boardName;\n        c.threadNumber = +result.fields.threadNumber;\n        return UsersModel.checkUserBan(req.ip, c.boardName, { write: true });\n    }).then(function() {\n        return Database.setThreadUnbumpable(req, c.fields);\n    }).then(function(result) {\n        res.send(result);\n    }).catch(function(err) {\n        next(err);\n    });\n});\n\nmodule.exports = router;\n"],"sourceRoot":"/source/"}