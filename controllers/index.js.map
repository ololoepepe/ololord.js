{"version":3,"sources":["controllers/index.js"],"names":[],"mappings":"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","file":"controllers/index.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport FS from 'q-io/fs';\nimport FSSync from 'fs';\n\nimport config from '../helpers/config';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\n\nconst EXCLUDED_ROUTERS = new Set(['index.js', 'home.js', 'board.js']);\n\nlet router = express.Router();\nlet routers = [];\n\nrouter.use('/redirect', (req, res, next) => {\n  if (!req.query.source) {\n    return next();\n  }\n  res.redirect(307, `/${config('site.pathPrefix')}${req.query.source.replace(/^\\//, '')}`);\n});\n\nFSSync.readdirSync(__dirname).filter((fileName) => {\n  return !EXCLUDED_ROUTERS.has(fileName) && 'js' === fileName.split('.').pop();\n}).forEach((fileName) => {\n  let r = Tools.requireWrapper(require(`./${fileName.split('.').slice(0, -1).join('.')}`));\n  router.use('/', r);\n  routers.push(r);\n});\n\n['./board', './home'].forEach((id) => {\n  let r = Tools.requireWrapper(require(id));\n  router.use('/', r);\n  routers.push(r);\n});\n\nrouter.use('*', (req, res, next) => {\n  let err = new Error();\n  err.status = 404;\n  err.path = req.baseUrl;\n  next(err);\n});\n\nrouter.use((err, req, res, next) => {\n  Tools.series(req.formFiles, async function(file) {\n    try {\n      let exists = FS.exists(file.path);\n      if (exists) {\n        await FS.remove(file.path);\n      }\n    } catch (err) {\n      Logger.error(err.stack || err);\n    }\n  });\n  switch (err.status) {\n  case 404: {\n    Logger.error(Tools.preferIPv4(req.ip), err.path, 404);\n    res.status(404).sendFile('notFound.html', { root: `${__dirname}/../public` });\n    break;\n  }\n  default: {\n    Logger.error(Tools.preferIPv4(req.ip), req.path, err.stack || err);\n    if (err.ban) {\n      var model = { ban: err.ban };\n    } else {\n      if (_(err).isError()) {\n        var model = {\n          errorMessage: Tools.translate('Internal error'),\n          errorDescription: err.message\n        };\n      } else if (err.error) {\n        var model = {\n          errorMessage: error.description ? err.error : Tools.translate('Error'),\n          errorDescription: err.description || err.error\n        };\n      } else {\n        var model = {\n          errorMessage: Tools.translate('Error'),\n          errorDescription: ((typeof err === 'string') ? err : '')\n        };\n      }\n    }\n    res.json(model);\n    break;\n  }\n  }\n});\n\nrouter.routers = routers;\n\nexport default router;\n"],"sourceRoot":"/source/"}