{"version":3,"sources":["helpers/database.js"],"names":[],"mappings":"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","file":"helpers/database.js","sourcesContent":["var Address4 = require(\"ip-address\").Address4;\nvar Address6 = require(\"ip-address\").Address6;\nvar bigInt = require(\"big-integer\");\nvar cluster = require(\"cluster\");\nvar Crypto = require(\"crypto\");\nvar Elasticsearch = require(\"elasticsearch\");\nvar FS = require(\"q-io/fs\");\nvar FSSync = require(\"fs\");\nvar Path = require(\"path\");\nvar promisify = require(\"promisify-node\");\nvar Redis = require(\"ioredis\");\nvar SQLite3 = require(\"sqlite3\");\nvar Util = require(\"util\");\n\nvar mkpath = promisify(\"mkpath\");\n\nimport Board from '../boards/board';\nvar Cache = require(\"./cache\");\nvar Captcha = require(\"../captchas/captcha\");\nvar config = require(\"./config\");\n//var markup = require(\"./markup\");\nvar Permissions = require(\"./permissions\");\nvar Tools = require(\"./tools\");\n\nimport * as BoardsModel from '../models/boards';\nimport * as PostsModel from '../models/posts';\nimport * as UsersModel from '../models/users';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport client from '../storage/client-factory';\n\nvar Ratings = {};\n\nvar db = client();\nvar es = new Elasticsearch.Client({ host: config(\"system.elasticsearch.host\", \"localhost:9200\") });\n\nmodule.exports.db = db;\nmodule.exports.es = es;\n\nvar hasNewPosts = new Set();\n\nif (!cluster.isMaster) {\n    setInterval(function() {\n        var o = {};\n        for (var key of hasNewPosts)\n            o[key] = 1;\n        hasNewPosts.clear();\n        if (!Tools.hasOwnProperties(o))\n            return;\n        return IPC.send('notifyAboutNewPosts', o).then(function() {\n            //Do nothing\n        }).catch(function(err) {\n            Logger.error(err.stack || err);\n        });\n    }, Tools.Second);\n}\n\ndb.tmp_hmget = db.hmget;\ndb.hmget = function(key, hashes) {\n    if (!hashes || (Util.isArray(hashes) && hashes.length <= 0))\n        return Promise.resolve([]);\n    return db.tmp_hmget.apply(db, arguments);\n};\n\ndb.tmp_sadd = db.sadd;\ndb.sadd = function(key, members) {\n    if (!members || (Util.isArray(members) && members.length <= 0))\n        return Promise.resolve(0);\n    return db.tmp_sadd.apply(db, arguments);\n};\n\ndb.tmp_srem = db.srem;\ndb.srem = function(key, members) {\n    if (!members || (Util.isArray(members) && members.length <= 0))\n        return Promise.resolve(0);\n    return db.tmp_srem.apply(db, arguments);\n};\n\nRatings[\"SafeForWork\"] = \"SFW\";\nRatings[\"Rating15\"] = \"R-15\";\nRatings[\"Rating18\"] = \"R-18\";\nRatings[\"Rating18G\"] = \"R-18G\";\n\nObject.defineProperty(module.exports, \"Ratings\", { value: Ratings });\n\nvar postFileInfoNames = function(boardName, postNumber) {\n    return db.smembers(\"postFileInfoNames:\" + boardName + \":\" + postNumber).then(function(list) {\n        if (!list)\n            return Promise.resolve([]);\n        return Promise.resolve(list.sort(function(a, b) {\n            a = +a.split(\".\").shift();\n            b = +b.split(\".\").shift();\n            if (a < b)\n                return -1;\n            else if (a > b)\n                return 1;\n            else\n                return 0;\n        }));\n    });\n};\n\nvar createFileHash = function(fileInfo) {\n    return {\n        name: fileInfo.name,\n        thumb: { name: fileInfo.thumb.name },\n        size: fileInfo.size,\n        boardName: fileInfo.boardName,\n        mimeType: fileInfo.mimeType,\n        rating: fileInfo.rating\n    };\n};\n\nvar addFileHashes = function(fileInfos) {\n    if (!fileInfos)\n        return Promise.resolve();\n    if (!Util.isArray(fileInfos))\n        fileInfos = [fileInfos];\n    if (fileInfos.length < 1)\n        return Promise.resolve();\n    return Tools.series(fileInfos, function(fileInfo) {\n        return db.sadd(\"fileHashes:\" + fileInfo.hash, JSON.stringify(createFileHash(fileInfo)));\n    });\n};\n\nvar removeFileHashes = function(fileInfos) {\n    if (!fileInfos)\n        return Promise.resolve();\n    if (!Util.isArray(fileInfos))\n        fileInfos = [fileInfos];\n    if (fileInfos.length < 1)\n        return Promise.resolve();\n    return Tools.series(fileInfos, function(fileInfo) {\n        return db.srem(\"fileHashes:\" + fileInfo.hash, JSON.stringify(createFileHash(fileInfo))).then(function() {\n            return db.scard(\"fileHashes:\" + fileInfo.hash);\n        }).then(function(size) {\n            if (size > 0)\n                return Promise.resolve();\n            return db.del(\"fileHashes:\" + fileInfo.hash);\n        });\n    });\n};\n\nvar rerenderReferringPosts = function(post, options) {\n    return db.hgetall(\"referringPosts:\" + post.boardName + \":\" + post.number).then(function(referringPosts) {\n        return Tools.series(referringPosts, function(ref) {\n            ref = JSON.parse(ref);\n            if (options && options.removingThread\n                    && ref.boardName == post.boardName && ref.threadNumber == post.threadNumber) {\n                return Promise.resolve();\n            }\n            return rerenderPost(ref.boardName, ref.postNumber, true);\n        });\n    });\n};\n\nvar removeReferencedPosts = function(post, nogenerate) {\n    var key = post.boardName + \":\" + post.number;\n    var c = {};\n    return db.hgetall(\"referencedPosts:\" + key).then(function(referencedPosts) {\n        c.referencedPosts = {};\n        var promises = [];\n        Tools.forIn(referencedPosts, function(ref, refKey) {\n            promises.push(db.hdel(\"referringPosts:\" + refKey, key));\n            ref = JSON.parse(ref);\n            c.referencedPosts[refKey] = ref;\n        });\n        return Promise.all(promises);\n    }).then(function() {\n        if (!nogenerate) {\n            Tools.forIn(c.referencedPosts, function(ref, refKey) {\n                if (ref.boardName != post.boardName || ref.threadNumber != post.threadNumber)\n                    IPC.render(ref.boardName, ref.threadNumber, ref.postNumber, 'edit');\n            });\n        }\n        return db.del(\"referencedPosts:\" + key);\n    });\n};\n\nvar addReferencedPosts = function(post, referencedPosts, nogenerate) {\n    var key = post.boardName + \":\" + post.number;\n    var promises = [];\n    Tools.forIn(referencedPosts, function(ref, refKey) {\n        promises.push(db.hset(\"referencedPosts:\" + key, refKey, JSON.stringify(ref)));\n    });\n    return Promise.all(promises).then(function() {\n        if (!nogenerate) {\n            Tools.forIn(referencedPosts, function(ref, refKey) {\n                if (ref.boardName != post.boardName || ref.threadNumber != post.threadNumber)\n                    IPC.render(ref.boardName, ref.threadNumber, ref.postNumber, 'edit');\n            });\n        }\n        var promises = [];\n        Tools.forIn(referencedPosts, function(ref, refKey) {\n            promises.push(db.hset(\"referringPosts:\" + refKey, key, JSON.stringify({\n                boardName: post.boardName,\n                postNumber: post.number,\n                threadNumber: post.threadNumber,\n                createdAt: refKey.createdAt\n            })));\n        });\n        return Promise.all(promises);\n    });\n};\n\nvar removePost = function(boardName, postNumber, options) {\n    var board = Board.board(boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    var c = {};\n    return db.sadd(\"postsPlannedForDeletion\", boardName + \":\" + postNumber).then(function() {\n        return PostsModel.getPost(boardName, postNumber, { withReferences: true });\n    }).then(function(post) {\n        c.post = post;\n        return db.srem(\"threadPostNumbers:\" + boardName + \":\" + post.threadNumber, postNumber);\n    }).then(function() {\n        return db.hdel(\"posts\", boardName + \":\" + postNumber);\n    }).then(function() {\n        if (options && options.leaveReferences)\n            return Promise.resolve();\n        return rerenderReferringPosts(c.post, { removingThread: options && options.removingThread });\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n    }).then(function() {\n        if (options && options.leaveReferences)\n            return Promise.resolve();\n        return removeReferencedPosts(c.post);\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n    }).then(function() {\n        return db.srem(\"userPostNumbers:\" + c.post.user.ip + \":\" + board.name, postNumber);\n    }).then(function() {\n        return postFileInfoNames(boardName, postNumber);\n    }).then(function(names) {\n        c.fileInfoNames = names;\n        return Promise.all(names.map(function(name) {\n            return db.hget(\"fileInfos\", name);\n        }));\n    }).then(function(fileInfos) {\n        if (options && options.leaveFileInfos)\n            return Promise.resolve();\n        c.fileInfos = [];\n        c.paths = [];\n        fileInfos.forEach(function(fileInfo) {\n            if (!fileInfo)\n                return;\n            fileInfo = JSON.parse(fileInfo);\n            c.fileInfos.push(fileInfo);\n            c.paths.push(__dirname + \"/../public/\" + boardName + \"/src/\" + fileInfo.name);\n            c.paths.push(__dirname + \"/../public/\" + boardName + \"/thumb/\" + fileInfo.thumb.name);\n        });\n        return db.del(\"postFileInfoNames:\" + boardName + \":\" + postNumber);\n    }).then(function() {\n        if (options && options.leaveFileInfos)\n            return Promise.resolve();\n        return Promise.all(c.fileInfoNames.map(function(name) {\n            return db.hdel(\"fileInfos\", name);\n        }));\n    }).then(function() {\n        if (options && options.leaveFileInfos)\n            return Promise.resolve();\n        return removeFileHashes(c.fileInfos);\n    }).then(function() {\n        return board.removeExtraData(postNumber);\n    }).then(function() {\n        return es.delete({\n            index: \"ololord.js\",\n            type: \"posts\",\n            id: boardName + \":\" + postNumber\n        });\n    }).then(function() {\n        if (!options || !options.leaveFileInfos) {\n            c.paths.forEach(function(path) {\n                return FS.remove(path).catch(function(err) {\n                    Logger.error(err.stack || err);\n                });\n            });\n        }\n        return db.srem(\"postsPlannedForDeletion\", boardName + \":\" + postNumber);\n    });\n};\n\nmodule.exports.removePost = removePost;\n\nvar removeThread = function(boardName, threadNumber, options) {\n    var key = ((options && options.archived) ? \"archivedThreads:\" : \"threads:\") + boardName;\n    return db.sadd(\"threadsPlannedForDeletion\", boardName + \":\" + threadNumber).then(function() {\n        return db.hdel(key, threadNumber);\n    }).then(function() {\n        return db.hdel(\"threadUpdateTimes:\" + boardName, threadNumber);\n    }).then(function() {\n        setTimeout(function() {\n            var c = {};\n            db.smembers(\"threadPostNumbers:\" + boardName + \":\" + threadNumber).then(function(result) {\n                c.postNumbers = result;\n                return db.del(\"threadPostNumbers:\" + boardName + \":\" + threadNumber);\n            }).then(function() {\n                return Tools.series(c.postNumbers, function(postNumber) {\n                    return removePost(boardName, postNumber, {\n                        leaveFileInfos: options && options.leaveFileInfos,\n                        leaveReferences: options && options.leaveReferences,\n                        removingThread: true\n                    });\n                });\n            }).then(function() {\n                return db.srem(\"threadsPlannedForDeletion\", boardName + \":\" + threadNumber);\n            }).catch(function(err) {\n                Logger.error(err.stack || err);\n            });\n        }, 5000);\n        return Promise.resolve();\n    });\n};\n\nmodule.exports.removeThread = removeThread;\n\nvar rerenderPost = function(boardName, postNumber, silent) {\n    var key = boardName + \":\" + postNumber;\n    var c = {};\n    if (!silent)\n        console.log(`Rendering post: [${boardName}] ${postNumber}`);\n    var referencedPosts = {};\n    return PostsModel.getPost(boardName, postNumber).then(function(post) {\n        c.post = post;\n        return markup(c.post.boardName, c.post.rawText, {\n            markupModes: c.post.markup,\n            referencedPosts: referencedPosts,\n            accessLevel: c.post.user.level\n        });\n    }).then(function(text) {\n        c.post.text = text;\n        return db.hset(\"posts\", key, JSON.stringify(c.post));\n    }).then(function() {\n        return removeReferencedPosts(c.post, !silent);\n    }).then(function() {\n        return addReferencedPosts(c.post, referencedPosts, !silent);\n    }).then(function() {\n        if (silent)\n            IPC.render(c.post.boardName, c.post.threadNumber, c.post.number, 'edit');\n        return Promise.resolve();\n    });\n};\n\nmodule.exports.setThreadFixed = function(req, fields) {\n    var board = Board.board(fields.boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (!req.isModer(board.name))\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var date = Tools.now();\n    var c = {};\n    var threadNumber = +fields.threadNumber;\n    if (isNaN(threadNumber) || threadNumber <= 0)\n        return Promise.reject(Tools.translate(\"Invalid thread number\"));\n    return db.hget(\"threads:\" + board.name, threadNumber).then(function(thread) {\n        if (!thread)\n            return Promise.reject(Tools.translate(\"No such thread\"));\n        thread = JSON.parse(thread);\n        var fixed = (\"true\" == fields.fixed);\n        if (thread.fixed == fixed)\n            return Promise.resolve();\n        thread.fixed = fixed;\n        db.hset(\"threads:\" + board.name, threadNumber, JSON.stringify(thread));\n    }).then(function() {\n        return IPC.render(board.name, threadNumber, threadNumber, 'edit');\n    }).then(function() {\n        return Promise.resolve({\n            boardName: board.name,\n            threadNumber: threadNumber\n        });\n    });\n};\n\nmodule.exports.setThreadClosed = function(req, fields) {\n    var board = Board.board(fields.boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (!req.isModer(board.name))\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var date = Tools.now();\n    var c = {};\n    var threadNumber = +fields.threadNumber;\n    if (isNaN(threadNumber) || threadNumber <= 0)\n        return Promise.reject(Tools.translate(\"Invalid thread number\"));\n    return db.hget(\"threads:\" + board.name, threadNumber).then(function(thread) {\n        if (!thread)\n            return Promise.reject(Tools.translate(\"No such thread\"));\n        thread = JSON.parse(thread);\n        var closed = (\"true\" == fields.closed);\n        if (thread.closed == closed)\n            return Promise.resolve();\n        thread.closed = closed;\n        db.hset(\"threads:\" + board.name, threadNumber, JSON.stringify(thread));\n    }).then(function() {\n        return IPC.render(board.name, threadNumber, threadNumber, 'edit');\n    }).then(function() {\n        return Promise.resolve({\n            boardName: board.name,\n            threadNumber: threadNumber\n        });\n    });\n};\n\nmodule.exports.setThreadUnbumpable = function(req, fields) {\n    var board = Board.board(fields.boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (!req.isModer(board.name))\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var date = Tools.now();\n    var c = {};\n    var threadNumber = +fields.threadNumber;\n    if (isNaN(threadNumber) || threadNumber <= 0)\n        return Promise.reject(Tools.translate(\"Invalid thread number\"));\n    return db.hget(\"threads:\" + board.name, threadNumber).then(function(thread) {\n        if (!thread)\n            return Promise.reject(Tools.translate(\"No such thread\"));\n        thread = JSON.parse(thread);\n        var unbumpable = (\"true\" == fields.unbumpable);\n        if (!!thread.unbumpable == unbumpable)\n            return Promise.resolve();\n        thread.unbumpable = unbumpable;\n        db.hset(\"threads:\" + board.name, threadNumber, JSON.stringify(thread));\n    }).then(function() {\n        return IPC.render(board.name, threadNumber, threadNumber, 'edit');\n    }).then(function() {\n        return Promise.resolve({\n            boardName: board.name,\n            threadNumber: threadNumber\n        });\n    });\n};\n\nmodule.exports.delall = function(req, ip, boardNames) {\n    ip = Tools.correctAddress(ip);\n    if (!ip)\n        return Promise.reject(Tools.translate(\"Invalid IP address\"));\n    if (ip == req.ip)\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    if (!boardNames || boardNames.length < 1)\n        return Promise.reject(Tools.translate(\"No board specified\"));\n    var err = boardNames.some(function(boardName) {\n        if (!Board.board(boardName))\n            return true;\n    }, false);\n    if (err)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    err = boardNames.some(function(boardName) {\n        if (!req.isModer(boardName))\n            return true;\n    });\n    if (err)\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var deletedThreads = {};\n    var updatedThreads = {};\n    var deletedPosts = {};\n    return UsersModel.getRegisteredUserLevelsByIp(ip).then(function(levels) {\n        err = boardNames.some(function(boardName) {\n            var level = req.level(boardName);\n            if (!req.isSuperuser(boardName) && Tools.compareRegisteredUserLevels(level, levels[boardName]) <= 0)\n                return true;\n        });\n        if (err)\n            return Promise.reject(Tools.translate(\"Not enough rights\"));\n        return Tools.series(boardNames, function(boardName) {\n            return db.smembers(`userPostNumbers:${ip}:${boardName}`).then(function(postNumbers) {\n                return Tools.series(postNumbers, function(postNumber) {\n                    return PostsModel.getPost(boardName, postNumber);\n                }, true).then(function(posts) {\n                    posts.forEach(function(post) {\n                        if (post.threadNumber == post.number) {\n                            deletedThreads[post.boardName + \":\" + post.threadNumber] = {\n                                boardName: post.boardName,\n                                number: post.threadNumber\n                            };\n                        }\n                    });\n                    posts.forEach(function(post) {\n                        var key = `${post.boardName}:${post.threadNumber}`;\n                        if (deletedThreads.hasOwnProperty(key))\n                            return;\n                        updatedThreads[key] = {\n                            boardName: post.boardName,\n                            number: post.threadNumber\n                        };\n                        deletedPosts[`${post.boardName}:${post.number}`] = {\n                            boardName: post.boardName,\n                            number: post.number\n                        };\n                    });\n                    return Promise.resolve();\n                });\n            });\n        });\n    }).then(function() {\n        return Tools.series(deletedPosts, function(post) {\n            return removePost(post.boardName, post.number);\n        });\n    }).then(function() {\n        return Tools.series(deletedThreads, function(thread) {\n            return removeThread(thread.boardName, thread.number);\n        });\n    }).then(function() {\n        return Tools.series(updatedThreads, function(thread) {\n            return IPC.render(thread.boardName, thread.number, thread.postNumber, 'edit');\n        });\n    }).then(function() {\n        return Tools.series(deletedThreads, function(thread) {\n            return IPC.render(thread.boardName, thread.number, thread.number, 'delete');\n        });\n    }).then(function() {\n        return Promise.resolve();\n    });\n};\n"],"sourceRoot":"/source/"}