{"version":3,"sources":["helpers/database.js"],"names":[],"mappings":"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","file":"helpers/database.js","sourcesContent":["var Address4 = require(\"ip-address\").Address4;\nvar Address6 = require(\"ip-address\").Address6;\nvar bigInt = require(\"big-integer\");\nvar cluster = require(\"cluster\");\nvar Crypto = require(\"crypto\");\nvar Elasticsearch = require(\"elasticsearch\");\nvar FS = require(\"q-io/fs\");\nvar FSSync = require(\"fs\");\nvar Path = require(\"path\");\nvar promisify = require(\"promisify-node\");\nvar Redis = require(\"ioredis\");\nvar SQLite3 = require(\"sqlite3\");\nvar Util = require(\"util\");\n\nvar mkpath = promisify(\"mkpath\");\n\nimport Board from '../boards/board';\nvar Cache = require(\"./cache\");\nvar Captcha = require(\"../captchas\");\nvar config = require(\"./config\");\n//var markup = require(\"./markup\");\nvar Permissions = require(\"./permissions\");\nvar Tools = require(\"./tools\");\n\nimport * as BoardsModel from '../models/board';\nimport * as PostsModel from '../models/posts';\nimport * as UsersModel from '../models/users';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport client from '../storage/client-factory';\n\nvar Ratings = {};\nvar RegisteredUserLevels = {};\nvar BanLevels = {};\n\nvar db = client();\nvar es = new Elasticsearch.Client({ host: config(\"system.elasticsearch.host\", \"localhost:9200\") });\n\nmodule.exports.db = db;\nmodule.exports.es = es;\n\nvar hasNewPosts = new Set();\n\nif (!cluster.isMaster) {\n    setInterval(function() {\n        var o = {};\n        for (var key of hasNewPosts)\n            o[key] = 1;\n        hasNewPosts.clear();\n        if (!Tools.hasOwnProperties(o))\n            return;\n        return IPC.send('notifyAboutNewPosts', o).then(function() {\n            //Do nothing\n        }).catch(function(err) {\n            Logger.error(err.stack || err);\n        });\n    }, Tools.Second);\n}\n\ndb.tmp_hmget = db.hmget;\ndb.hmget = function(key, hashes) {\n    if (!hashes || (Util.isArray(hashes) && hashes.length <= 0))\n        return Promise.resolve([]);\n    return db.tmp_hmget.apply(db, arguments);\n};\n\ndb.tmp_sadd = db.sadd;\ndb.sadd = function(key, members) {\n    if (!members || (Util.isArray(members) && members.length <= 0))\n        return Promise.resolve(0);\n    return db.tmp_sadd.apply(db, arguments);\n};\n\ndb.tmp_srem = db.srem;\ndb.srem = function(key, members) {\n    if (!members || (Util.isArray(members) && members.length <= 0))\n        return Promise.resolve(0);\n    return db.tmp_srem.apply(db, arguments);\n};\n\nRatings[\"SafeForWork\"] = \"SFW\";\nRatings[\"Rating15\"] = \"R-15\";\nRatings[\"Rating18\"] = \"R-18\";\nRatings[\"Rating18G\"] = \"R-18G\";\n\nRegisteredUserLevels[\"Superuser\"] = \"SUPERUSER\";\nRegisteredUserLevels[\"Admin\"] = \"ADMIN\";\nRegisteredUserLevels[\"Moder\"] = \"MODER\";\nRegisteredUserLevels[\"User\"] = \"USER\";\n\nBanLevels[\"ReadOnly\"] = \"READ_ONLY\";\nBanLevels[\"NoAccess\"] = \"NO_ACCESS\";\n\nObject.defineProperty(module.exports, \"Ratings\", { value: Ratings });\nObject.defineProperty(module.exports, \"RegisteredUserLevels\", { value: RegisteredUserLevels });\n\nvar sortedReferensces = function(references) {\n    if (!references)\n        return [];\n    var list = [];\n    Tools.forIn(references, function(ref) {\n        list.push(JSON.parse(ref));\n    });\n    return list.sort(function(a, b) {\n        var da = new Date(a.createdAt);\n        var db = new Date(b.createdAt);\n        if (da < db)\n            return -1;\n        if (da > db)\n            return 1;\n        if (a.boardName < b.boardName)\n            return -1;\n        if (a.boardName > b.boardName)\n            return 1;\n        if (a.postNumber < b.postNumber)\n            return -1;\n        if (a.postNumber > b.postNumber)\n            return 1;\n        return 0;\n    }).map(function(ref) {\n        delete ref.createdAt;\n        return ref;\n    });\n};\n\nvar checkPermissions = function(req, board, post, permission, password) {\n    if (req.isSuperuser())\n        return Promise.resolve(true);\n    if (Tools.compareRegisteredUserLevels(req.level(board.name), Permissions[permission]()) >= 0) {\n        if (Tools.compareRegisteredUserLevels(req.level(board.name), post.user.level) > 0)\n            return Promise.resolve(true);\n        if (req.hashpass && req.hashpass == post.user.hashpass)\n            return Promise.resolve(true);\n        if (password && password == post.user.password)\n            return Promise.resolve(true);\n    }\n    if (!board.opModeration)\n        return Promise.resolve(false);\n    return db.hget(\"threads:\" + board.name, post.threadNumber).then(function(thread) {\n        thread = JSON.parse(thread);\n        if (thread.user.ip != req.ip && (!req.hashpass || req.hashpass != thread.user.hashpass))\n            return Promise.resolve(false);\n        if (Tools.compareRegisteredUserLevels(req.level(board.name), post.user.level) >= 0)\n            return Promise.resolve(true);\n        if (req.hashpass && req.hashpass == post.user.hashpass)\n            return Promise.resolve(true);\n        if (password && password == post.user.password)\n            return Promise.resolve(true);\n        return Promise.resolve(false);\n    });\n};\n\nvar threadPostNumbers = function(boardName, threadNumber) {\n    return db.smembers(\"threadPostNumbers:\" + boardName + \":\" + threadNumber).then(function(list) {\n        if (!list)\n            return Promise.resolve([]);\n        return Promise.resolve(list.map(function(number) {\n            return +number;\n        }).sort(function(a, b) {\n            a = +a;\n            b = +b;\n            if (a < b)\n                return -1;\n            else if (a > b)\n                return 1;\n            else\n                return 0;\n        }));\n    });\n};\n\nmodule.exports.threadPostNumbers = threadPostNumbers;\n\nvar postFileInfoNames = function(boardName, postNumber) {\n    return db.smembers(\"postFileInfoNames:\" + boardName + \":\" + postNumber).then(function(list) {\n        if (!list)\n            return Promise.resolve([]);\n        return Promise.resolve(list.sort(function(a, b) {\n            a = +a.split(\".\").shift();\n            b = +b.split(\".\").shift();\n            if (a < b)\n                return -1;\n            else if (a > b)\n                return 1;\n            else\n                return 0;\n        }));\n    });\n};\n\nvar getThreads = function(boardName, options) {\n    if (!Tools.contains(Board.boardNames(), boardName))\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    var opts = (typeof options == \"object\");\n    var c = {};\n    var key = ((options && options.archived) ? \"archivedThreads\" : \"threads\") + \":\" + boardName;\n    var p = db.hgetall(key).then(function(result) {\n        if (!result)\n            return [];\n        var filter = opts && (typeof options.filterFunction == \"function\");\n        var limit = (opts && !isNaN(options.limit) && options.limit > 0) ? options.limit : 0; //NOTE: 0 means no limit\n        var i = 0;\n        var threads = [];\n        for (var number in result) {\n            if (!result.hasOwnProperty(number))\n                continue;\n            var thread = JSON.parse(result[number]);\n            if (!filter || options.filterFunction(thread))\n                threads.push(thread);\n            if (limit && threads.length >= limit)\n                break;\n        }\n        return threads;\n    }).then(function(threads) {\n        var promises = threads.map(function(thread) {\n            return db.hget(\"threadUpdateTimes:\" + boardName, thread.number).then(function(time) {\n                thread.updatedAt = time;\n                return thread;\n            });\n        });\n        return Promise.all(promises);\n    });\n    if (!opts || !options.withPostNumbers)\n        return p;\n    return p.then(function(threads) {\n        c.threads = threads;\n        var promises = threads.map(function(thread) {\n            return threadPostNumbers(boardName, thread.number);\n        });\n        return Promise.all(promises);\n    }).then(function(results) {\n        results.forEach(function(result, i) {\n            c.threads[i].postNumbers = result;\n        });\n        return c.threads;\n    });\n};\n\nmodule.exports.getThreads = getThreads;\n\nmodule.exports.getThread = function(boardName, threadNumber, archived) {\n    if (!Tools.contains(Board.boardNames(), boardName))\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    var c = {};\n    var key = archived ? \"archivedThreads\" : \"threads\";\n    return db.hget(key + \":\" + boardName, threadNumber).then(function(thread) {\n        if (!thread)\n            return Promise.reject(Tools.translate(\"No such thread\"));\n        c.thread = JSON.parse(thread);\n        return db.hget(\"threadUpdateTimes:\" + boardName, thread.number);\n    }).then(function(time) {\n        c.thread.updatedAt = time;\n        return threadPostNumbers(boardName, c.thread.number);\n    }).then(function(postNumbers) {\n        c.thread.postNumbers = postNumbers;\n        return Promise.resolve(c.thread);\n    });\n};\n\nvar bannedFor = function(boardName, postNumber, userIp) {\n    return db.get(\"userBans:\" + userIp + \":\" + boardName).then(function(ban) {\n        if (!ban)\n            return Promise.resolve(false);\n        return Promise.resolve(JSON.parse(ban).postNumber == postNumber);\n    });\n};\n\nvar getFileInfo = function(file) {\n    var p;\n    if (file.fileName) {\n        p = Promise.resolve(file.fileName);\n    } else {\n        p = db.srandmember(\"fileHashes:\" + file.fileHash).then(function(fileInfo) {\n            if (!fileInfo)\n                return Promise.reject(Tools.translate(\"No such file\"));\n            return Promise.resolve(JSON.parse(fileInfo).name);\n        });\n    }\n    return p.then(function(fileName) {\n        return db.hget(\"fileInfos\", fileName);\n    }).then(function(fileInfo) {\n        if (!fileInfo)\n            return Promise.reject(Tools.translate(\"No such file\"));\n        return Promise.resolve(JSON.parse(fileInfo));\n    });\n};\n\nmodule.exports.getFileInfo = getFileInfo;\n\nvar toHashpass = function(password, notHashpass) {\n    if (notHashpass || !Tools.mayBeHashpass(password))\n        password = Tools.sha1(password);\n    return password;\n};\n\nmodule.exports.addSuperuser = function(password, ips, notHashpass) {\n    if (!password)\n        return Promise.reject(Tools.translate(\"Invalid password\"));\n    var invalidIp;\n    if (Util.isArray(ips)) {\n        invalidIp = ips.some(function(ip, i) {\n            ip = Tools.correctAddress(ip);\n            if (!ip)\n                return true;\n            ips[i] = ip;\n        });\n    }\n    if (invalidIp)\n        return Promise.reject(Tools.translate(\"Invalid IP address\"));\n    var hashpass = toHashpass(password, notHashpass);\n    return db.exists(\"registeredUserLevels:\" + hashpass).then(function(result) {\n        if (result)\n            return Promise.reject(Tools.translate(\"A user with this hashpass is already registered\"));\n        return db.sadd(\"superuserHashes\", hashpass);\n    }).then(function(result) {\n        if (!result)\n            return Promise.reject(Tools.translate(\"A user with this hashpass is already registered\"));\n        return Tools.series(ips, function(ip) {\n            return db.hset(\"registeredUserHashes\", ip, hashpass).then(function() {\n                return db.sadd(\"registeredUserIps:\" + hashpass, ip);\n            });\n        });\n        return Promise.resolve();\n    });\n};\n\nmodule.exports.removeSuperuser = function(password, notHashpass) {\n    if (!password)\n        return Promise.reject(Tools.translate(\"Invalid password\"));\n    var hashpass = toHashpass(password, notHashpass);\n    return db.srem(\"superuserHashes\", hashpass).then(function(result) {\n        if (!result)\n            return Promise.reject(Tools.translate(\"No user with this hashpass\"));\n    }).then(function() {\n        return db.smembers(\"registeredUserIps:\" + hashpass);\n    }).then(function(ips) {\n        if (!ips)\n            return Promise.resolve();\n        return Tools.series(ips, function(ip) {\n            return db.hdel(\"registeredUserHashes\", ip);\n        });\n    }).then(function() {\n        return db.del(\"registeredUserIps:\" + hashpass);\n    }).then(function() {\n        return Promise.resolve();\n    });\n};\n\nvar nextPostNumber = function(boardName, incrby) {\n    var board = Board.board(boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    incrby = +incrby;\n    if (isNaN(incrby) || incrby < 1)\n        incrby = 1;\n    return db.hincrby(\"postCounters\", boardName, incrby).then(function(number) {\n        if (!number)\n            return 0;\n        if (1 == incrby && board.skippedGetOrder > 0 && !(number % Math.pow(10, board.skippedGetOrder)))\n            return nextPostNumber(boardName, incrby);\n        return number;\n    });\n};\n\nmodule.exports.nextPostNumber = nextPostNumber;\n\nvar waitForFile = function(filePath, options) { //TODO: That is not okay\n    var delay = (options && options.delay) || 50;\n    var retry = (options && retry) || 4;\n    var f = function() {\n        return FS.exists(filePath).then(function(exists) {\n            return Tools.promiseIf(exists, function() {\n                return Promise.resolve();\n            }, function() {\n                if (!retry)\n                    return Promise.reject((options && options.error) || \"File not found\");\n                --retry;\n                return (new Promise(function(resolve, reject) {\n                    setTimeout(resolve, delay);\n                })).then(retry);\n            });\n        });\n    };\n    return f();\n};\n\nvar processFile = function(board, file, transaction) {\n    return board.generateFileName(file).then(function(fn) {\n        var targetFilePath = __dirname + \"/../public/\" + board.name + \"/src/\" + fn.name;\n        var targetThumbPath = __dirname + \"/../public/\" + board.name + \"/thumb/\" + fn.thumbName;\n        transaction.filePaths.push(targetFilePath);\n        transaction.filePaths.push(targetThumbPath);\n        if (file.copy) {\n            var sourceFilePath = __dirname + \"/../public/\" + file.boardName + \"/src/\" + file.name;\n            var sourceThumbPath = __dirname + \"/../public/\" + file.boardName + \"/thumb/\" + file.thumbName;\n            return FS.copy(sourceFilePath, targetFilePath).then(function() {\n                return FS.copy(sourceThumbPath, targetThumbPath);\n            }).then(function() {\n                return waitForFile(targetThumbPath, { error: Tools.translate(\"Failed to copy file\") }); //TODO: Fix\n            }).then(function() {\n                return getFileInfo({ fileName: file.name });\n            }).then(function(fileInfo) {\n                return {\n                    dimensions: fileInfo.dimensions,\n                    extraData: fileInfo.extraData,\n                    hash: fileInfo.hash,\n                    ihash: fileInfo.ihash || null,\n                    mimeType: fileInfo.mimeType,\n                    name: fn.name,\n                    rating: file.rating,\n                    size: fileInfo.size,\n                    thumb: {\n                        dimensions: fileInfo.thumb.dimensions,\n                        name: fn.thumbName\n                    }\n                };\n            });\n        } else {\n            var sourceFilePath = file.path;\n            var c = {};\n            return board.processFile(file).then(function() {\n                return FS.move(sourceFilePath, targetFilePath);\n            }).then(function() {\n                transaction.filePaths.push(file.thumbPath);\n                return FS.move(file.thumbPath, targetThumbPath);\n            }).then(function() {\n                return waitForFile(targetThumbPath, { error: Tools.translate(\"Failed to copy file\") }); //TODO: Fix\n            }).then(function() {\n                return {\n                    dimensions: file.dimensions,\n                    extraData: file.extraData,\n                    hash: file.hash,\n                    ihash: file.ihash || null,\n                    mimeType: file.mimeType,\n                    name: fn.name,\n                    rating: file.rating,\n                    size: file.size,\n                    thumb: {\n                        dimensions: file.thumbDimensions,\n                        name: fn.thumbName\n                    }\n                };\n            });\n        }\n    });\n};\n\nvar processFiles = function(req, fields, files, transaction) {\n    var board = Board.board(fields.boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (files.length < 1)\n        return Promise.resolve([]);\n    return mkpath(__dirname + \"/../public/\" + board.name + \"/src\").then(function() {\n        return mkpath(__dirname + \"/../public/\" + board.name + \"/thumb\");\n    }).then(function() {\n        return Tools.series(files, function(file) {\n            return processFile(board, file, transaction);\n        }, true);\n    });\n};\n\nvar createFileHash = function(fileInfo) {\n    return {\n        name: fileInfo.name,\n        thumb: { name: fileInfo.thumb.name },\n        size: fileInfo.size,\n        boardName: fileInfo.boardName,\n        mimeType: fileInfo.mimeType,\n        rating: fileInfo.rating\n    };\n};\n\nvar addFileHashes = function(fileInfos) {\n    if (!fileInfos)\n        return Promise.resolve();\n    if (!Util.isArray(fileInfos))\n        fileInfos = [fileInfos];\n    if (fileInfos.length < 1)\n        return Promise.resolve();\n    return Tools.series(fileInfos, function(fileInfo) {\n        return db.sadd(\"fileHashes:\" + fileInfo.hash, JSON.stringify(createFileHash(fileInfo)));\n    });\n};\n\nvar removeFileHashes = function(fileInfos) {\n    if (!fileInfos)\n        return Promise.resolve();\n    if (!Util.isArray(fileInfos))\n        fileInfos = [fileInfos];\n    if (fileInfos.length < 1)\n        return Promise.resolve();\n    return Tools.series(fileInfos, function(fileInfo) {\n        return db.srem(\"fileHashes:\" + fileInfo.hash, JSON.stringify(createFileHash(fileInfo))).then(function() {\n            return db.scard(\"fileHashes:\" + fileInfo.hash);\n        }).then(function(size) {\n            if (size > 0)\n                return Promise.resolve();\n            return db.del(\"fileHashes:\" + fileInfo.hash);\n        });\n    });\n};\n\nvar rerenderReferringPosts = function(post, options) {\n    return db.hgetall(\"referringPosts:\" + post.boardName + \":\" + post.number).then(function(referringPosts) {\n        return Tools.series(referringPosts, function(ref) {\n            ref = JSON.parse(ref);\n            if (options && options.removingThread\n                    && ref.boardName == post.boardName && ref.threadNumber == post.threadNumber) {\n                return Promise.resolve();\n            }\n            return rerenderPost(ref.boardName, ref.postNumber, true);\n        });\n    });\n};\n\nvar removeReferencedPosts = function(post, nogenerate) {\n    var key = post.boardName + \":\" + post.number;\n    var c = {};\n    return db.hgetall(\"referencedPosts:\" + key).then(function(referencedPosts) {\n        c.referencedPosts = {};\n        var promises = [];\n        Tools.forIn(referencedPosts, function(ref, refKey) {\n            promises.push(db.hdel(\"referringPosts:\" + refKey, key));\n            ref = JSON.parse(ref);\n            c.referencedPosts[refKey] = ref;\n        });\n        return Promise.all(promises);\n    }).then(function() {\n        if (!nogenerate) {\n            Tools.forIn(c.referencedPosts, function(ref, refKey) {\n                if (ref.boardName != post.boardName || ref.threadNumber != post.threadNumber)\n                    IPC.render(ref.boardName, ref.threadNumber, ref.postNumber, 'edit');\n            });\n        }\n        return db.del(\"referencedPosts:\" + key);\n    });\n};\n\nvar addReferencedPosts = function(post, referencedPosts, nogenerate) {\n    var key = post.boardName + \":\" + post.number;\n    var promises = [];\n    Tools.forIn(referencedPosts, function(ref, refKey) {\n        promises.push(db.hset(\"referencedPosts:\" + key, refKey, JSON.stringify(ref)));\n    });\n    return Promise.all(promises).then(function() {\n        if (!nogenerate) {\n            Tools.forIn(referencedPosts, function(ref, refKey) {\n                if (ref.boardName != post.boardName || ref.threadNumber != post.threadNumber)\n                    IPC.render(ref.boardName, ref.threadNumber, ref.postNumber, 'edit');\n            });\n        }\n        var promises = [];\n        Tools.forIn(referencedPosts, function(ref, refKey) {\n            promises.push(db.hset(\"referringPosts:\" + refKey, key, JSON.stringify({\n                boardName: post.boardName,\n                postNumber: post.number,\n                threadNumber: post.threadNumber,\n                createdAt: refKey.createdAt\n            })));\n        });\n        return Promise.all(promises);\n    });\n};\n\nvar removePost = function(boardName, postNumber, options) {\n    var board = Board.board(boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    var c = {};\n    return db.sadd(\"postsPlannedForDeletion\", boardName + \":\" + postNumber).then(function() {\n        return PostsModel.getPost(boardName, postNumber, { withReferences: true });\n    }).then(function(post) {\n        c.post = post;\n        return db.srem(\"threadPostNumbers:\" + boardName + \":\" + post.threadNumber, postNumber);\n    }).then(function() {\n        return db.hdel(\"posts\", boardName + \":\" + postNumber);\n    }).then(function() {\n        if (options && options.leaveReferences)\n            return Promise.resolve();\n        return rerenderReferringPosts(c.post, { removingThread: options && options.removingThread });\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n    }).then(function() {\n        if (options && options.leaveReferences)\n            return Promise.resolve();\n        return removeReferencedPosts(c.post);\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n    }).then(function() {\n        return db.srem(\"userPostNumbers:\" + c.post.user.ip + \":\" + board.name, postNumber);\n    }).then(function() {\n        return postFileInfoNames(boardName, postNumber);\n    }).then(function(names) {\n        c.fileInfoNames = names;\n        return Promise.all(names.map(function(name) {\n            return db.hget(\"fileInfos\", name);\n        }));\n    }).then(function(fileInfos) {\n        if (options && options.leaveFileInfos)\n            return Promise.resolve();\n        c.fileInfos = [];\n        c.paths = [];\n        fileInfos.forEach(function(fileInfo) {\n            if (!fileInfo)\n                return;\n            fileInfo = JSON.parse(fileInfo);\n            c.fileInfos.push(fileInfo);\n            c.paths.push(__dirname + \"/../public/\" + boardName + \"/src/\" + fileInfo.name);\n            c.paths.push(__dirname + \"/../public/\" + boardName + \"/thumb/\" + fileInfo.thumb.name);\n        });\n        return db.del(\"postFileInfoNames:\" + boardName + \":\" + postNumber);\n    }).then(function() {\n        if (options && options.leaveFileInfos)\n            return Promise.resolve();\n        return Promise.all(c.fileInfoNames.map(function(name) {\n            return db.hdel(\"fileInfos\", name);\n        }));\n    }).then(function() {\n        if (options && options.leaveFileInfos)\n            return Promise.resolve();\n        return removeFileHashes(c.fileInfos);\n    }).then(function() {\n        return board.removeExtraData(postNumber);\n    }).then(function() {\n        return es.delete({\n            index: \"ololord.js\",\n            type: \"posts\",\n            id: boardName + \":\" + postNumber\n        });\n    }).then(function() {\n        if (!options || !options.leaveFileInfos) {\n            c.paths.forEach(function(path) {\n                return FS.remove(path).catch(function(err) {\n                    Logger.error(err.stack || err);\n                });\n            });\n        }\n        return db.srem(\"postsPlannedForDeletion\", boardName + \":\" + postNumber);\n    });\n};\n\nmodule.exports.removePost = removePost;\n\nvar removeThread = function(boardName, threadNumber, options) {\n    var key = ((options && options.archived) ? \"archivedThreads:\" : \"threads:\") + boardName;\n    return db.sadd(\"threadsPlannedForDeletion\", boardName + \":\" + threadNumber).then(function() {\n        return db.hdel(key, threadNumber);\n    }).then(function() {\n        return db.hdel(\"threadUpdateTimes:\" + boardName, threadNumber);\n    }).then(function() {\n        setTimeout(function() {\n            var c = {};\n            db.smembers(\"threadPostNumbers:\" + boardName + \":\" + threadNumber).then(function(result) {\n                c.postNumbers = result;\n                return db.del(\"threadPostNumbers:\" + boardName + \":\" + threadNumber);\n            }).then(function() {\n                return Tools.series(c.postNumbers, function(postNumber) {\n                    return removePost(boardName, postNumber, {\n                        leaveFileInfos: options && options.leaveFileInfos,\n                        leaveReferences: options && options.leaveReferences,\n                        removingThread: true\n                    });\n                });\n            }).then(function() {\n                return db.srem(\"threadsPlannedForDeletion\", boardName + \":\" + threadNumber);\n            }).catch(function(err) {\n                Logger.error(err.stack || err);\n            });\n        }, 5000);\n        return Promise.resolve();\n    });\n};\n\nmodule.exports.removeThread = removeThread;\n\nvar userLevels = [\n    \"USER\",\n    \"MODER\",\n    \"ADMIN\",\n    \"SUPERUSER\"\n];\n\nvar Transaction = function() {\n    this.filePaths = [];\n    this.board = null;\n    this.postNumber = 0;\n    this.threadNumber = 0;\n};\n\nTransaction.prototype.rollback = function() {\n    var _this = this;\n    Tools.series(_this.filePaths, function(path) {\n        return FS.exists(path).then(function(exists) {\n            if (!exists)\n                return Promise.resolve();\n            return FS.remove(path).catch(function(err) {\n                Logger.error(err.stack || err);\n            });\n        });\n    }).then(function() {\n        if (_this.threadNumber <= 0)\n            return Promise.resolve();\n        return removeThread(_this.board.name, _this.threadNumber).catch(function(err) {\n            Logger.error(err.stack || err);\n        });\n    }).then(function() {\n        if (_this.postNumber <= 0)\n            return Promise.resolve();\n        return removePost(_this.board.name, _this.postNumber).catch(function(err) {\n            Logger.error(err.stack || err);\n        });\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n    });\n};\n\nmodule.exports.Transaction = Transaction;\n\nvar mapPhrase = function(phrase) {\n    return {\n        bool: {\n            should: [\n                { match_phrase: { plainText: phrase } },\n                { match_phrase: { subject: phrase } }\n            ]\n        }\n    };\n};\n\nmodule.exports.findPosts = function(query, boardName, page) {\n    page = +page;\n    if (!page || page < 0)\n        page = 0;\n    var startFrom = page * config(\"system.searchLimit\", 100);\n    var q = { bool: {} };\n    if (query.requiredPhrases && query.requiredPhrases.length > 0)\n        q.bool.must = query.requiredPhrases.map(mapPhrase);\n    if (boardName)\n        q.bool.must = (q.bool.must || []).concat({ match_phrase: { boardName: boardName } });\n    if (query.excludedPhrases && query.excludedPhrases.length > 0)\n        q.bool.must_not = query.excludedPhrases.map(mapPhrase);\n    if (query.possiblePhrases && query.possiblePhrases.length > 0) {\n        if (query.requiredPhrases && query.requiredPhrases.length > 0)\n            q.bool.should = query.possiblePhrases.map(mapPhrase);\n        else\n            q.bool.must = (q.bool.must || []).concat({ bool: { should: query.possiblePhrases.map(mapPhrase) } });\n    }\n    return es.search({\n        index: \"ololord.js\",\n        type: \"posts\",\n        from: startFrom,\n        size: config(\"system.searchLimit\", 100),\n        body: { query: q }\n    }).then(function(result) {\n        return {\n            posts: result.hits.hits.map(function(hit) {\n                return {\n                    boardName: hit._id.split(\":\").shift(),\n                    number: +hit._id.split(\":\").pop(),\n                    threadNumber: +hit._source.threadNumber,\n                    plainText: hit._source.plainText,\n                    subject: hit._source.subject,\n                    archived: !!hit._source.archived\n                };\n            }),\n            total: result.hits.total,\n            max: config(\"system.searchLimit\", 100)\n        };\n    });\n};\n\nvar captchaSolved = function(boardName, userIp) {\n    var board = Board.board(boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    var quota = board.captchaQuota;\n    if (quota < 1)\n        return Promise.resolve(0);\n    return db.hincrby(\"captchaQuotas\", boardName + \":\" + userIp, quota);\n};\n\nmodule.exports.captchaSolved = captchaSolved;\n\nvar captchaUsed = function(boardName, userIp) {\n    var board = Board.board(boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (board.captchaQuota < 1)\n        return Promise.resolve(0);\n    return db.hincrby(\"captchaQuotas\", boardName + \":\" + userIp, -1).then(function(quota) {\n        if (+quota < 0)\n            return db.hset(\"captchaQuotas\", boardName + \":\" + userIp, 0);\n        return (quota < 0) ? 0 : quota;\n    });\n};\n\nvar rerenderPost = function(boardName, postNumber, silent) {\n    var key = boardName + \":\" + postNumber;\n    var c = {};\n    if (!silent)\n        console.log(`Rendering post: [${boardName}] ${postNumber}`);\n    var referencedPosts = {};\n    return PostsModel.getPost(boardName, postNumber).then(function(post) {\n        c.post = post;\n        return markup(c.post.boardName, c.post.rawText, {\n            markupModes: c.post.markup,\n            referencedPosts: referencedPosts,\n            accessLevel: c.post.user.level\n        });\n    }).then(function(text) {\n        c.post.text = text;\n        return db.hset(\"posts\", key, JSON.stringify(c.post));\n    }).then(function() {\n        return removeReferencedPosts(c.post, !silent);\n    }).then(function() {\n        return addReferencedPosts(c.post, referencedPosts, !silent);\n    }).then(function() {\n        if (silent)\n            IPC.render(c.post.boardName, c.post.threadNumber, c.post.number, 'edit');\n        return Promise.resolve();\n    });\n};\n\nvar rerenderBoardPosts = function(boardName, posts) {\n    return Tools.series(posts, function(post) {\n        return rerenderPost(boardName, post);\n    });\n};\n\nvar rebuildPostSearchIndex = function(boardName, postNumber, threads) {\n    var key = boardName + \":\" + postNumber;\n    if (!boardName || !postNumber)\n        return Promise.resolve();\n    console.log(`Rebuilding post search index: >>/${boardName}/${postNumber}`);\n    threads = threads || {};\n    var c = {};\n    return PostsModel.getPost(boardName, postNumber).then(function(post) {\n        c.post = post;\n        return Tools.promiseIf(threads.hasOwnProperty(c.post.threadNumber), function() {\n            return Promise.resolve(threads[c.post.threadNumber]);\n        }, function() {\n            return db.hget(\"threads:\" + boardName, c.post.threadNumber).then(function(thread) {\n                if (thread)\n                    return Promise.resolve(thread);\n                return db.hget(\"archivedThreads:\" + boardName, c.post.threadNumber);\n            }).then(function(thread) {\n                if (!thread)\n                    return Promise.reject(Tools.translate(\"No such thread\"));\n                thread = JSON.parse(thread);\n                threads[thread.number] = thread;\n                return Promise.resolve(thread);\n            });\n        });\n    }).then(function(thread) {\n        return es.index({\n            index: \"ololord.js\",\n            type: \"posts\",\n            id: boardName + \":\" + postNumber,\n            body: {\n                plainText: c.post.plainText,\n                subject: c.post.subject,\n                boardName: boardName,\n                threadNumber: c.post.threadNumber,\n                archived: !!thread.archived\n            }\n        });\n    }).catch(function(err) {\n        Logger.error(err.stack || err);\n        return Promise.resolve();\n    }).then(function() {\n        return Promise.resolve();\n    });\n};\n\nvar rebuildBoardSearchIndex = function(boardName, postNumbers) {\n    var threads = {};\n    return Tools.series(postNumbers, function(postNumber) {\n        return rebuildPostSearchIndex(boardName, postNumber, threads);\n    });\n};\n\nmodule.exports.rerenderPosts = function(boardNames) {\n    var postNumbers = {};\n    return db.hkeys(\"posts\").then(function(keys) {\n        keys.forEach(function(key) {\n            var boardName = key.split(\":\").shift();\n            var postNumber = +key.split(\":\").pop();\n            if (!postNumbers.hasOwnProperty(boardName))\n                postNumbers[boardName] = [];\n            postNumbers[boardName].push(postNumber);\n        });\n        var postList = boardNames.map(function(boardName) {\n            return {\n                boardName: boardName,\n                postNumbers: (postNumbers.hasOwnProperty(boardName) ? postNumbers[boardName] : [])\n            };\n        });\n        return Tools.series(postList, function(item) {\n            return rerenderBoardPosts(item.boardName, item.postNumbers);\n        });\n    });\n};\n\nmodule.exports.rebuildSearchIndex = function() {\n    var posts = {};\n    return db.hkeys(\"posts\").then(function(keys) {\n        keys.forEach(function(key) {\n            var boardName = key.split(\":\").shift();\n            var postNumber = +key.split(\":\").pop();\n            if (!posts.hasOwnProperty(boardName))\n                posts[boardName] = [];\n            posts[boardName].push(postNumber);\n        });\n        var postList = Board.boardNames().map(function(boardName) {\n            return {\n                boardName: boardName,\n                posts: (posts.hasOwnProperty(boardName) ? posts[boardName] : [])\n            };\n        });\n        return Tools.series(postList, function(item) {\n            return rebuildBoardSearchIndex(item.boardName, item.posts);\n        });\n    });\n};\n\nmodule.exports.setThreadFixed = function(req, fields) {\n    var board = Board.board(fields.boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (!req.isModer(board.name))\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var date = Tools.now();\n    var c = {};\n    var threadNumber = +fields.threadNumber;\n    if (isNaN(threadNumber) || threadNumber <= 0)\n        return Promise.reject(Tools.translate(\"Invalid thread number\"));\n    return db.hget(\"threads:\" + board.name, threadNumber).then(function(thread) {\n        if (!thread)\n            return Promise.reject(Tools.translate(\"No such thread\"));\n        thread = JSON.parse(thread);\n        var fixed = (\"true\" == fields.fixed);\n        if (thread.fixed == fixed)\n            return Promise.resolve();\n        thread.fixed = fixed;\n        db.hset(\"threads:\" + board.name, threadNumber, JSON.stringify(thread));\n    }).then(function() {\n        return IPC.render(board.name, threadNumber, threadNumber, 'edit');\n    }).then(function() {\n        return Promise.resolve({\n            boardName: board.name,\n            threadNumber: threadNumber\n        });\n    });\n};\n\nmodule.exports.setThreadClosed = function(req, fields) {\n    var board = Board.board(fields.boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (!req.isModer(board.name))\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var date = Tools.now();\n    var c = {};\n    var threadNumber = +fields.threadNumber;\n    if (isNaN(threadNumber) || threadNumber <= 0)\n        return Promise.reject(Tools.translate(\"Invalid thread number\"));\n    return db.hget(\"threads:\" + board.name, threadNumber).then(function(thread) {\n        if (!thread)\n            return Promise.reject(Tools.translate(\"No such thread\"));\n        thread = JSON.parse(thread);\n        var closed = (\"true\" == fields.closed);\n        if (thread.closed == closed)\n            return Promise.resolve();\n        thread.closed = closed;\n        db.hset(\"threads:\" + board.name, threadNumber, JSON.stringify(thread));\n    }).then(function() {\n        return IPC.render(board.name, threadNumber, threadNumber, 'edit');\n    }).then(function() {\n        return Promise.resolve({\n            boardName: board.name,\n            threadNumber: threadNumber\n        });\n    });\n};\n\nmodule.exports.setThreadUnbumpable = function(req, fields) {\n    var board = Board.board(fields.boardName);\n    if (!board)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (!req.isModer(board.name))\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var date = Tools.now();\n    var c = {};\n    var threadNumber = +fields.threadNumber;\n    if (isNaN(threadNumber) || threadNumber <= 0)\n        return Promise.reject(Tools.translate(\"Invalid thread number\"));\n    return db.hget(\"threads:\" + board.name, threadNumber).then(function(thread) {\n        if (!thread)\n            return Promise.reject(Tools.translate(\"No such thread\"));\n        thread = JSON.parse(thread);\n        var unbumpable = (\"true\" == fields.unbumpable);\n        if (!!thread.unbumpable == unbumpable)\n            return Promise.resolve();\n        thread.unbumpable = unbumpable;\n        db.hset(\"threads:\" + board.name, threadNumber, JSON.stringify(thread));\n    }).then(function() {\n        return IPC.render(board.name, threadNumber, threadNumber, 'edit');\n    }).then(function() {\n        return Promise.resolve({\n            boardName: board.name,\n            threadNumber: threadNumber\n        });\n    });\n};\n\nmodule.exports.moveThread = function(req, fields) {\n    var sourceBoard = Board.board(fields.boardName);\n    var targetBoard = Board.board(fields.targetBoardName);\n    if (!sourceBoard || !targetBoard)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    if (sourceBoard.name == targetBoard.name)\n        return Promise.reject(Tools.translate(\"Source and target boards are the same\"));\n    var threadNumber = +fields.threadNumber;\n    if (isNaN(threadNumber) || threadNumber <= 0)\n        return Promise.reject(Tools.translate(\"Invalid thread number\"));\n    if (!req.isModer(sourceBoard.name) || !req.isModer(targetBoard.name))\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var password = Tools.sha1(fields.password);\n    var c = {};\n    var sourcePath = __dirname + \"/../public/\" + sourceBoard.name + \"/src\"\n    var sourceThumbPath = __dirname + \"/../public/\" + sourceBoard.name + \"/thumb\";\n    var targetPath = __dirname + \"/../public/\" + targetBoard.name + \"/src\"\n    var targetThumbPath = __dirname + \"/../public/\" + targetBoard.name + \"/thumb\";\n    return getThreads(sourceBoard.name, {\n        withPostNumbers: true,\n        filterFunction: function(thread) {\n            return thread && threadNumber == thread.number;\n        }\n    }).then(function(thread) {\n        if (!thread || thread.length != 1)\n            return Promise.reject(Tools.translate(\"No such thread\"));\n        c.thread = thread[0];\n        if ((!password || password != c.thread.user.password)\n            && (!req.hashpass || req.hashpass != c.thread.user.hashpass)\n            && !req.isSuperuser()\n            && (Tools.compareRegisteredUserLevels(req.level(sourceBoard.name), c.thread.user.level) <= 0)) {\n            return Promise.reject(Tools.translate(\"Not enough rights\"));\n        }\n        delete c.thread.updatedAt;\n        c.postNumbers = c.thread.postNumbers;\n        delete c.thread.postNumbers;\n        var promises = c.postNumbers.map(function(postNumber) {\n            return PostsModel.getPost(sourceBoard.name, postNumber, {\n                withFileInfos: true,\n                withReferences: true,\n                withExtraData: true\n            });\n        });\n        return Promise.all(promises);\n    }).then(function(posts) {\n        c.posts = posts;\n        return nextPostNumber(targetBoard.name, c.posts.length);\n    }).then(function(lastPostNumber) {\n        lastPostNumber = lastPostNumber - c.posts.length + 1;\n        c.thread.number = lastPostNumber;\n        c.postNumberMap = {};\n        c.posts.forEach(function(post, i) {\n            c.postNumberMap[post.number] = lastPostNumber;\n            ++lastPostNumber;\n        });\n        return mkpath(targetPath);\n    }).then(function() {\n        return mkpath(targetThumbPath);\n    }).then(function() {\n        return Tools.series(c.posts, function(post) {\n            var oldPostNumber = post.number;\n            post.number = c.postNumberMap[post.number];\n            post.threadNumber = c.thread.number;\n            post.boardName = targetBoard.name;\n            var referencedPosts = post.referencedPosts;\n            delete post.referencedPosts;\n            var extraData = post.extraData;\n            delete post.extraData;\n            var referringPosts = post.referringPosts;\n            delete post.referringPosts;\n            var fileInfos = post.fileInfos;\n            fileInfos.forEach(function(fileInfo) {\n                fileInfo.boardName = targetBoard.name;\n                fileInfo.postNumber = post.number;\n            });\n            delete post.fileInfos;\n            c.toRerender = {};\n            c.toUpdate = {};\n            if (post.rawText) {\n                Tools.forIn(c.postNumberMap, function(newPostNumber, previousPostNumber) {\n                    var rx = new RegExp(`>>/${sourceBoard.name}/${previousPostNumber}`, \"g\");\n                    post.rawText = post.rawText.replace(rx, `>>/${targetBoard.name}/${newPostNumber}`);\n                    rx = new RegExp(`>>${previousPostNumber}`, \"g\");\n                    post.rawText = post.rawText.replace(rx, `>>${newPostNumber}`);\n                });\n                referencedPosts.forEach(function(ref) {\n                    if (ref.boardName != sourceBoard.name)\n                        return;\n                    var rx = new RegExp(`>>${ref.postNumber}`, \"g\");\n                    post.rawText = post.rawText.replace(rx, `>>/${sourceBoard.name}/${ref.postNumber}`);\n                });\n            }\n            return db.hset(\"posts\", targetBoard.name + \":\" + post.number, JSON.stringify(post)).then(function() {\n                return targetBoard.storeExtraData(post.number, extraData);\n            }).then(function() {\n                return Tools.series(referencedPosts, function(ref) {\n                    var nref;\n                    if (ref.boardName == sourceBoard.name && ref.threadNumber == threadNumber) {\n                        nref = {\n                            boardName: targetBoard.name,\n                            threadNumber: post.threadNumber,\n                            postNumber: c.postNumberMap[ref.postNumber]\n                        };\n                    } else {\n                        c.toUpdate[ref.boardName + \":\" + ref.threadNumber] = {\n                            boardName: ref.boardName,\n                            threadNumber: ref.threadNumber\n                        };\n                        nref = ref;\n                    }\n                    return db.hdel(`referencedPosts:${sourceBoard.name}:${oldPostNumber}`,\n                            `${ref.boardName}:${ref.postNumber}`).then(function() {\n                        return db.hset(`referencedPosts:${targetBoard.name}:${post.number}`,\n                                `${nref.boardName}:${nref.postNumber}`, JSON.stringify(nref));\n                    });\n                });\n            }).then(function() {\n                return Tools.series(referringPosts, function(ref) {\n                    var nref;\n                    if (ref.boardName == sourceBoard.name && ref.threadNumber == threadNumber) {\n                        nref = {\n                            boardName: targetBoard.name,\n                            threadNumber: post.threadNumber,\n                            postNumber: c.postNumberMap[ref.postNumber]\n                        };\n                    } else {\n                        c.toRerender[ref.boardName + \":\" + ref.postNumber] = {\n                            boardName: ref.boardName,\n                            postNumber: ref.postNumber\n                        };\n                        c.toUpdate[ref.boardName + \":\" + ref.threadNumber] = {\n                            boardName: ref.boardName,\n                            threadNumber: ref.threadNumber\n                        };\n                        nref = ref;\n                    }\n                    return db.hdel(`referringPosts:${sourceBoard.name}:${oldPostNumber}`,\n                            `${ref.boardName}:${ref.postNumber}`).then(function() {\n                        return db.hset(`referringPosts:${targetBoard.name}:${post.number}`,\n                                `${nref.boardName}:${nref.postNumber}`, JSON.stringify(nref));\n                    });\n                });\n            }).then(function() {\n                return db.sadd(\"userPostNumbers:\" + post.user.ip + \":\" + targetBoard.name, post.number);\n            }).then(function() {\n                return Tools.series(fileInfos, function(fileInfo) {\n                    return db.hset(\"fileInfos\", fileInfo.name, JSON.stringify(fileInfo)).then(function() {\n                        return db.sadd(\"postFileInfoNames:\" + targetBoard.name + \":\" + post.number, fileInfo.name);\n                    }).then(function() {\n                        return FS.move(sourcePath + \"/\" + fileInfo.name, targetPath + \"/\" + fileInfo.name);\n                    }).then(function() {\n                        return FS.move(sourceThumbPath + \"/\" + fileInfo.thumb.name,\n                            targetThumbPath + \"/\" + fileInfo.thumb.name);\n                    });\n                });\n            }).then(function() {\n                return addFileHashes(fileInfos);\n            }).then(function() {\n                return es.index({\n                    index: \"ololord.js\",\n                    type: \"posts\",\n                    id: targetBoard.name + \":\" + post.number,\n                    body: {\n                        plainText: post.plainText,\n                        subject: post.subject,\n                        boardName: targetBoard.name,\n                        threadNumber: post.threadNumber\n                    }\n                })\n            });\n        });\n    }).then(function() {\n        return db.hset(\"threads:\" + targetBoard.name, c.thread.number, JSON.stringify(c.thread));\n    }).then(function() {\n        return db.hset(\"threadUpdateTimes:\" + targetBoard.name, c.thread.number, Tools.now().toISOString());\n    }).then(function() {\n        return db.sadd(\"threadPostNumbers:\" + targetBoard.name + \":\" + c.thread.number,\n            Tools.toArray(c.postNumberMap));\n    }).then(function() {\n        return Tools.series(c.posts, function(post) {\n            return markup(post.boardName, post.rawText, {\n                markupModes: post.markup,\n                referencedPosts: {},\n                accessLevel: post.user.level\n            }).then(function(text) {\n                post.text = text;\n                return db.hset(\"posts\", post.boardName + \":\" + post.postNumber, JSON.stringify(post));\n            });\n        });\n    }).then(function() {\n        return Tools.series(c.toRerender, function(o) {\n            return PostsModel.getPost(o.boardName, o.postNumber).then(function(p) {\n                if (!p.rawText)\n                    return Promise.resolve();\n                Tools.forIn(c.postNumberMap, function(newPostNumber, previousPostNumber) {\n                    var rx = new RegExp(`>>/${sourceBoard.name}/${previousPostNumber}`, \"g\");\n                    p.rawText = p.rawText.replace(rx, `>>/${targetBoard.name}/${newPostNumber}`);\n                    if (o.boardName == sourceBoard.name) {\n                        rx = new RegExp(`>>${previousPostNumber}`, \"g\");\n                        p.rawText = p.rawText.replace(rx, `>>/${targetBoard.name}/${newPostNumber}`);\n                    }\n                });\n                return markup(p.boardName, p.rawText, {\n                    markupModes: p.markup,\n                    referencedPosts: {},\n                    accessLevel: p.user.level\n                }).then(function(text) {\n                    p.text = text;\n                    return db.hset(\"posts\", p.boardName + \":\" + p.number, JSON.stringify(p));\n                });\n            });\n        });\n    }).then(function() {\n        return Tools.series(c.toUpdate, function(o) {\n            return IPC.render(o.boardName, o.threadNumber, o.threadNumber, 'create');\n        });\n    }).then(function() {\n        return removeThread(sourceBoard.name, threadNumber, {\n            leaveFileInfos: true,\n            leaveReferences: true\n        });\n    }).then(function() {\n        IPC.render(sourceBoard.name, threadNumber, threadNumber, 'delete')\n        return IPC.render(targetBoard.name, c.thread.number, c.thread.number, 'create');\n    }).then(function() {\n        return {\n            boardName: targetBoard.name,\n            threadNumber: c.thread.number\n        };\n    });\n};\n\nvar updatePostBanInfo = function(boardName, postNumber) {\n    if (!Board.board(boardName))\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    postNumber = +postNumber;\n    if (isNaN(postNumber) || postNumber <= 0)\n        return Promise.resolve();\n    return db.hget(\"posts\", boardName + \":\" + postNumber).then(function(post) {\n        if (!post)\n            return Promise.resolve();\n        return IPC.render(boardName, JSON.parse(post).threadNumber, postNumber, 'edit');\n    });\n};\n\nvar updateBan = function(ip, boardName, postNumber) {\n    ip = Tools.correctAddress(ip);\n    if (!ip)\n        return Promise.reject(Tools.translate(\"Invalid IP address\"));\n    if (!Board.board(boardName))\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    return db.keys(`userBans:${ip}:*`).then(function(keys) {\n        if (keys && keys.length > 0)\n            return Promise.resolve();\n        return db.srem(\"bannedUserIps\", ip);\n    }).then(function() {\n        return updatePostBanInfo(boardName, postNumber);\n    });\n};\n\nmodule.exports.banUser = function(req, ip, bans) {\n    ip = Tools.correctAddress(ip);\n    if (!ip)\n        return Promise.reject(Tools.translate(\"Invalid IP address\"));\n    if (ip == req.ip)\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var err;\n    var banLevels = Tools.toArray(BanLevels).reduce(function(acc, level) {\n        acc[level] = {};\n        return acc;\n    }, {});\n    bans.some(function(ban) {\n        if (!Board.board(ban.boardName)) {\n            err = Tools.translate(\"Invalid board\");\n            return true;\n        }\n        if (!banLevels.hasOwnProperty(ban.level)) {\n            err = Tools.translate(\"Invalid ban level\");\n            return true;\n        }\n    });\n    if (err)\n        return Promise.reject(err);\n    if (!req.isModer())\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    bans = bans.reduce(function(acc, ban) {\n        acc[ban.boardName] = ban;\n        return acc;\n    }, {});\n    var modified = [];\n    var newBans;\n    var c = {};\n    return UsersModel.getBannedUserBans(ip).then(function(oldBans) {\n        c.oldBans = oldBans;\n        var date = Tools.now();\n        newBans = Board.boardNames().reduce(function(acc, boardName) {\n            if (req.isModer(boardName)) {\n                if (bans.hasOwnProperty(boardName)) {\n                    var ban = bans[boardName];\n                    ban.createdAt = date;\n                    acc[boardName] = ban;\n                    modified.push(boardName);\n                } else if (oldBans.hasOwnProperty(boardName)) {\n                    modified.push(boardName);\n                }\n            } else {\n                if (oldBans.hasOwnProperty(boardName))\n                    acc[boardName] = oldBans[boardName];\n            }\n            return acc;\n        }, {});\n        return UsersModel.getRegisteredUserLevelsByIp(ip);\n    }).then(function(levels) {\n        modified.some(function(boardName) {\n            var level = req.level(boardName);\n            if (!req.isSuperuser(boardName) && Tools.compareRegisteredUserLevels(level, levels[boardName]) <= 0) {\n                err = Promise.reject(Tools.translate(\"Not enough rights\"));\n                return true;\n            }\n        });\n        if (err)\n            return Promise.reject(err);\n        return Tools.series(Board.boardNames(), function(boardName) {\n            var key = `userBans:${ip}:${boardName}`;\n            var ban = newBans[boardName];\n            if (!ban) {\n                ban = c.oldBans[boardName];\n                if (!ban)\n                    return Promise.resolve();\n                return db.del(key).then(function() {\n                    if (!ban.postNumber)\n                        return Promise.resolve();\n                    return db.hdel(\"userBanPostNumbers\", key, ban.postNumber);\n                }).then(function() {\n                    return updatePostBanInfo(boardName, ban.postNumber);\n                });\n            }\n            return db.set(key, JSON.stringify(ban)).then(function() {\n                if (!ban.expiresAt)\n                    return Promise.resolve();\n                return db.expire(key, Math.ceil((+ban.expiresAt - +Tools.now()) / 1000));\n            }).then(function() {\n                if (!ban.postNumber)\n                    return Promise.resolve();\n                return db.hset(\"userBanPostNumbers\", key, ban.postNumber);\n            }).then(function() {\n                if (!ban.postNumber)\n                    return Promise.resolve();\n                return updatePostBanInfo(boardName, ban.postNumber);\n            });\n        });\n    }).then(function() {\n        return db[Tools.hasOwnProperties(newBans) ? \"sadd\" : \"srem\"](\"bannedUserIps\", ip);\n    }).then(function() {\n        return Promise.resolve();\n    });\n};\n\nmodule.exports.delall = function(req, ip, boardNames) {\n    ip = Tools.correctAddress(ip);\n    if (!ip)\n        return Promise.reject(Tools.translate(\"Invalid IP address\"));\n    if (ip == req.ip)\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    if (!boardNames || boardNames.length < 1)\n        return Promise.reject(Tools.translate(\"No board specified\"));\n    var err = boardNames.some(function(boardName) {\n        if (!Board.board(boardName))\n            return true;\n    }, false);\n    if (err)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    err = boardNames.some(function(boardName) {\n        if (!req.isModer(boardName))\n            return true;\n    });\n    if (err)\n        return Promise.reject(Tools.translate(\"Not enough rights\"));\n    var deletedThreads = {};\n    var updatedThreads = {};\n    var deletedPosts = {};\n    return UsersModel.getRegisteredUserLevelsByIp(ip).then(function(levels) {\n        err = boardNames.some(function(boardName) {\n            var level = req.level(boardName);\n            if (!req.isSuperuser(boardName) && Tools.compareRegisteredUserLevels(level, levels[boardName]) <= 0)\n                return true;\n        });\n        if (err)\n            return Promise.reject(Tools.translate(\"Not enough rights\"));\n        return Tools.series(boardNames, function(boardName) {\n            return db.smembers(`userPostNumbers:${ip}:${boardName}`).then(function(postNumbers) {\n                return Tools.series(postNumbers, function(postNumber) {\n                    return PostsModel.getPost(boardName, postNumber);\n                }, true).then(function(posts) {\n                    posts.forEach(function(post) {\n                        if (post.threadNumber == post.number) {\n                            deletedThreads[post.boardName + \":\" + post.threadNumber] = {\n                                boardName: post.boardName,\n                                number: post.threadNumber\n                            };\n                        }\n                    });\n                    posts.forEach(function(post) {\n                        var key = `${post.boardName}:${post.threadNumber}`;\n                        if (deletedThreads.hasOwnProperty(key))\n                            return;\n                        updatedThreads[key] = {\n                            boardName: post.boardName,\n                            number: post.threadNumber\n                        };\n                        deletedPosts[`${post.boardName}:${post.number}`] = {\n                            boardName: post.boardName,\n                            number: post.number\n                        };\n                    });\n                    return Promise.resolve();\n                });\n            });\n        });\n    }).then(function() {\n        return Tools.series(deletedPosts, function(post) {\n            return removePost(post.boardName, post.number);\n        });\n    }).then(function() {\n        return Tools.series(deletedThreads, function(thread) {\n            return removeThread(thread.boardName, thread.number);\n        });\n    }).then(function() {\n        return Tools.series(updatedThreads, function(thread) {\n            return IPC.render(thread.boardName, thread.number, thread.postNumber, 'edit');\n        });\n    }).then(function() {\n        return Tools.series(deletedThreads, function(thread) {\n            return IPC.render(thread.boardName, thread.number, thread.number, 'delete');\n        });\n    }).then(function() {\n        return Promise.resolve();\n    });\n};\n\nmodule.exports.initialize = function() {\n    //NOTE: Enabling \"key expired\" notifications\n    var CHANNEL = `__keyevent@${config(\"system.redis.db\", 0)}__:expired`;\n    var dbs = client(true);\n    var initialized = false;\n    var query = [];\n    var updateBanOnMessage = function(message) {\n        var ip = message.split(\":\").slice(1, -1).join(\":\");\n        var boardName = message.split(\":\").pop();\n        var postNumber = 0;\n        db.hget(\"userBanPostNumbers\", message).then(function(pn) {\n            if (!pn)\n                return Promise.resolve();\n            postNumber = +pn;\n            return db.hdel(\"userBanPostNumbers\", message);\n        }).then(function() {\n            updateBan(ip, boardName, postNumber).catch(function(err) {\n                Logger.error(err.stack || err);\n            });\n        });\n    };\n    dbs.on(\"message\", function(channel, message) {\n        if (CHANNEL != channel)\n            return;\n        if (!initialized) {\n            query.push(message);\n            return;\n        }\n        updateBanOnMessage(message);\n    });\n    return db.config(\"SET\", \"notify-keyspace-events\", \"Ex\").then(function() {\n        dbs.subscribe(CHANNEL).catch(function(err) {\n            Logger.error(err.stack || err);\n        });\n        return Promise.resolve(function() {\n            initialized = true;\n            query.forEach(updateBanOnMessage);\n        });\n    });\n};\n"],"sourceRoot":"/source/"}