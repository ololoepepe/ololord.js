{"version":3,"sources":["helpers/config.js"],"names":[],"mappings":"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","file":"helpers/config.js","sourcesContent":["var equal = require(\"deep-equal\");\nvar FS = require(\"q-io/fs\");\nvar FSSync = require(\"fs\");\nvar Path = require(\"path\");\n\nimport OS from 'os';\n\nimport Program from './program';\n\nconst DEFAULT_VALUES = new Map([\n  ['board.useDefaultBoards', true],\n  ['server.ddosProtection.enabled', true],\n  ['server.ddosProtection.ws.connectionLimit', 10],\n  ['server.ddosProtection.ws.maxMessageLength', 20480],\n  ['server.ddosProtection.ws.maxMessageRate', 6],\n  ['server.rss.enabled', true],\n  ['server.rss.postCount', 500],\n  ['server.rss.ttl', 60],\n  ['server.statistics.enabled', true],\n  ['server.statistics.ttl', 60],\n  ['site.protocol', 'http'],\n  ['site.domain', 'localhost:8080'],\n  ['site.pathPrefix', ''],\n  ['site.locale', 'en'],\n  ['site.dateFormat', 'MM/DD/YYYY hh:mm:ss'],\n  ['site.timeOffset', 0],\n  ['site.vkontakte.accessToken', ''],\n  ['site.vkontakte.appId', ''],\n  ['site.vkontakte.integrationEnabled', false],\n  ['site.twitter.integrationEnabled', true],\n  ['site.ws.transports', ''],\n  ['site.maxSearchQueryLength', 50],\n  ['system.detectRealIp', true],\n  ['system.elasticsearch.host', 'localhost:9200'],\n  ['system.useXRealIp', false],\n  ['system.log.backups', 100],\n  ['system.log.maxSize', 1048576],\n  ['system.log.targets', ['console', 'file']],\n  ['system.phash.enabled', true],\n  ['system.redis.host', '127.0.0.1'],\n  ['system.redis.port', 6379],\n  ['system.redis.family', 4],\n  ['system.redis.password', ''],\n  ['system.redis.db', 0],\n  ['system.redis.enableReadyCheck', false],\n  ['system.redis.maxRedirections', 16],\n  ['system.redis.scaleReads', 'master'],\n  ['system.redis.retryDelayOnFailover', 100],\n  ['system.redis.retryDelayOnClusterDown', 100],\n  ['system.redis.retryDelayOnTryAgain', 100],\n  ['system.rerenderCacheOnStartup', true],\n  ['system.rerenderArchive', false],\n  ['system.searchLimit', 100],\n  ['system.workerCount', OS.cpus().length]\n]);\n\nvar contains = function(s, subs) {\n    if (typeof s == \"string\" && typeof subs == \"string\")\n        return s.replace(subs, \"\") != s;\n    if (!s || !s.length || s.length < 1)\n        return false;\n    for (var i = 0; i < s.length; ++i) {\n        if (equal(s[i], subs))\n            return true;\n    }\n    return false;\n};\n\nvar configFileName = Program.configFile;\nif (!configFileName)\n    configFileName = __dirname + \"/../config.json\";\nconfigFileName = Path.resolve(__dirname + \"/..\", configFileName);\nvar config = {};\nif (FSSync.existsSync(configFileName)) {\n    console.log(\"[\" + process.pid + \"] Using config file: \\\"\" + configFileName + \"\\\"...\");\n    config = JSON.parse(FSSync.readFileSync(configFileName, \"UTF-8\"));\n} else {\n    console.log(\"[\" + process.pid + \"] Using default config...\");\n}\n\nvar setHooks = {};\n\nvar c = function(key, def) {\n  if (typeof def === 'undefined') {\n    def = DEFAULT_VALUES.get(key);\n  }\n    var parts = key.split(\".\");\n    var o = config;\n    while (parts.length > 0) {\n        if (typeof o != \"object\")\n            return def;\n        o = o[parts.shift()];\n    }\n    return (undefined != o) ? o : def;\n};\n\nc.set = function(key, value) {\n    var parts = key.split(\".\");\n    var o = config;\n    while (parts.length > 1) {\n        if (typeof o != \"object\")\n            return;\n        var p = parts.shift();\n        if (!o.hasOwnProperty(p))\n            o[p] = {};\n        o = o[p];\n    }\n    if (parts.length < 1 || typeof o != \"object\")\n        return;\n    var p = parts.shift();\n    var prev = o[p];\n    o[p] = value;\n    var hook = setHooks[key];\n    if (typeof hook == \"function\")\n        hook(value, key);\n    FS.write(configFileName, JSON.stringify(config, null, 4));\n    return prev;\n};\n\nc.remove = function(key) {\n    var parts = key.split(\".\");\n    var o = config;\n    while (parts.length > 1) {\n        if (typeof o != \"object\")\n            return;\n        var p = parts.shift();\n        if (!o.hasOwnProperty(p))\n            o[p] = {};\n        o = o[p];\n    }\n    if (parts.length < 1 || typeof o != \"object\")\n        return;\n    var p = parts.shift();\n    var prev = o[p];\n    delete o[p];\n    FS.write(configFileName, JSON.stringify(config, null, 4), \"utf8\");\n    return prev;\n};\n\nc.installSetHook = function(key, hook) {\n    setHooks[key] = hook;\n};\n\nc.reload = function() {\n    config = {};\n    if (FSSync.existsSync(configFileName)) {\n        console.log(\"[\" + process.pid + \"] Using config file: \\\"\" + configFileName + \"\\\"...\");\n        config = JSON.parse(FSSync.readFileSync(configFileName, \"UTF-8\"));\n    } else {\n        console.log(\"[\" + process.pid + \"] Using default config...\");\n    }\n    for (var key in setHooks) {\n        if (!setHooks.hasOwnProperty(key))\n            return;\n        var hook = setHooks[key];\n        if (typeof hook != \"function\")\n            return;\n        setHooks[key](c(key), key);\n    }\n};\n\nc.setConfigFile = function(fileName) {\n    fileName = fileName || Program.configFile;\n    if (!fileName)\n        fileName = __dirname + \"/../config.json\";\n    configFileName = Path.resolve(__dirname + \"/..\", fileName);\n    c.reload();\n};\n\nmodule.exports = c;\n"],"sourceRoot":"/source/"}