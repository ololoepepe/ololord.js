{"version":3,"sources":["helpers/tools.js"],"names":[],"mappings":"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","file":"helpers/tools.js","sourcesContent":["import _ from 'underscore';\nvar Address4 = require(\"ip-address\").Address4;\nvar Address6 = require(\"ip-address\").Address6;\nvar Crypto = require(\"crypto\");\nvar equal = require(\"deep-equal\");\nimport escapeHTML from 'escape-html';\nvar FS = require(\"q-io/fs\");\nvar FSSync = require(\"fs\");\nvar HTMLToText = require(\"html-to-text\");\nvar merge = require(\"merge\");\nvar mkpath = require(\"mkpath\");\nvar Multiparty = require(\"multiparty\");\nvar Path = require(\"path\");\nvar promisify = require(\"promisify-node\");\nvar Util = require(\"util\");\nvar UUID = require(\"uuid\");\nvar XRegExp = require(\"xregexp\");\n\nimport config from './config';\nimport FSWatcher from './fs-watcher';\nimport Logger from './logger';\n\nlet translate = require(\"cute-localize\")({\n    locale: config(\"site.locale\", \"en\"),\n    extraLocations: __dirname + \"/../translations/custom\",\n    silent: true\n});\n\nexport { translate as translate };\n\nvar flags = {};\nvar rootZones = require(\"../misc/root-zones.json\").reduce(function(acc, zone) {\n    acc[zone] = {};\n    return acc;\n}, {});\n\nmkpath.sync(config(\"system.tmpPath\", __dirname + \"/../tmp\") + \"/form\");\n\nconst NON_THEME_STYLESHEETS = new Set(['', 'custom-'].reduce((acc, prefix) => {\n  return acc.concat(['combined', 'desktop', 'mobile'].map(suffix => `${prefix}base-${suffix}`));\n}, []));\nconst STYLES_PATH = `${__dirname}/../public/css`;\nconst CODE_STYLES_PATH = `${__dirname}/../public/css/3rdparty/highlight.js`;\nconst JS_TYPES = new Set(['string', 'boolean', 'number', 'object']);\n\nexport const SECOND = 1000;\nexport const MINUTE = 60 * SECOND;\nexport const HOUR = 60 * MINUTE;\nexport const EXTERNAL_LINK_REGEXP_PATTERN = (function() {\n    var schema = \"https?:\\\\/\\\\/|ftp:\\\\/\\\\/\";\n    var ip = \"(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\\\.){3}\"\n        + \"(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])\";\n    var hostname = \"([\\\\w\\\\p{L}\\\\.\\\\-]+)\\\\.([\\\\p{L}]{2,17}\\\\.?)\";\n    var port = \":\\\\d+\";\n    var path = \"(\\\\/[\\\\w\\\\p{L}\\\\.\\\\-\\\\!\\\\?\\\\=\\\\+#~&%:;\\'\\\"\\\\,\\\\(\\\\)\\\\[\\\\]«»]*)*\\\\/?\";\n    return \"(\" + schema + \")?(\" + hostname + \"|\" + ip + \")(\" + port + \")?\" + path;\n})();\nexport const FILE_RATINGS = ['SFW', 'R-15', 'R-18', 'R-18G'];\nexport const NODE_CAPTCHA_ID = 'node-captcha';\nexport const REGISTERED_USER_LEVELS = ['USER', 'MODER', 'ADMIN', 'SUPERUSER'];\nexport const BAN_LEVELS = ['NONE', 'READ_ONLY', 'NO_ACCESS'];\nexport const STYLES = FSSync.readdirSync(STYLES_PATH).filter((fileName) => {\n  return fileName.split('.').pop() === 'css' && !NON_THEME_STYLESHEETS.has(fileName.split('.').shift());\n}).map((fileName) => {\n  let name = fileName.split('.').slice(0, -1).join('.');\n  let match = /\\/\\*\\s*([^\\*]+?)\\s*\\*\\//gi.exec(FSSync.readFileSync(`${STYLES_PATH}/${fileName}`, 'utf8'));\n  return {\n    name: name,\n    title: (match ? match[1] : name)\n  };\n});\n\nexport const CODE_STYLES = FSSync.readdirSync(CODE_STYLES_PATH).filter((fileName) => {\n  return fileName.split('.').pop() === 'css';\n}).map((fileName) => {\n  let name = fileName.split('.').slice(0, -1).join('.');\n  let match = /\\/\\*\\s*([^\\*]+?)\\s*\\*\\//gi.exec(FSSync.readFileSync(`${CODE_STYLES_PATH}/${fileName}`, 'utf8'));\n  return {\n    name: name,\n    title: (match ? match[1] : name)\n  };\n});\n\nexport let hashpass = function(req) {\n    var s = req.cookies.hashpass;\n    if (!mayBeHashpass(s))\n        return;\n    return s;\n};\n\nexport let setLocale = function(locale) {\n    translate.setLocale(locale);\n};\n\nexport let now = function() {\n    return new Date();\n};\n\nexport let externalLinkRootZoneExists = function(zoneName) {\n    return rootZones.hasOwnProperty(zoneName);\n};\n\nexport let toHtml = function(text, replaceSpaces) {\n    text = escapeHTML(text).split(\"\\n\").join(\"<br />\");\n    if (replaceSpaces)\n        text = text.split(\" \").join(\"&nbsp;\");\n    return text;\n};\n\nexport let splitCommand = function(cmd) {\n    var args = [];\n    var arg = \"\";\n    var quot = 0;\n    for (var i = 0; i < cmd.length; ++i) {\n        var c = cmd[i];\n        if (/\\s/.test(c)) {\n            if (quot) {\n                arg += c;\n            } else if (arg.length > 0) {\n                args.push(arg);\n                arg = \"\";\n            }\n        } else {\n            if (\"\\\"\" == c && (i < 1 || \"\\\\\" != cmd[i - 1])) {\n                switch (quot) {\n                case 1:\n                    quot = 0;\n                    break;\n                case -1:\n                    arg += c;\n                    break;\n                case 0:\n                default:\n                    quot = 1;\n                    break;\n                }\n            } else if (\"'\" == c && (i < 1 || \"\\\\\" != cmd[i - 1])) {\n                switch (quot) {\n                case 1:\n                    arg += c;\n                    break;\n                case -1:\n                    quot = 0;\n                    break;\n                case 0:\n                default:\n                    quot = -1;\n                    break;\n                }\n            } else {\n                if ((\"\\\"\" == c || \"'\" == c) && (i > 0 || \"\\\\\" == cmd[i - 1]) && arg.length > 0)\n                    arg = arg.substring(0, arg.length - 1);\n                arg += c;\n            }\n        }\n    }\n    if (arg.length > 0) {\n        if (quot)\n            return null;\n        args.push(arg);\n    }\n    var command = null;\n    if (args.length > 0)\n        command = args.shift();\n    return {\n        command: command,\n        arguments: args\n    };\n};\n\nexport function mayBeHashpass(password) {\n  return (typeof password === 'string') && password.match(/^([0-9a-fA-F]){40}$/);\n}\n\nexport let parseForm = function(req) {\n    if (req.formFields) {\n        return Promise.resolve({\n            fields: req.formFields,\n            files: req.formFiles || []\n        });\n    }\n    var form = new Multiparty.Form();\n    form.uploadDir = config(\"system.tmpPath\", __dirname + \"/../tmp\") + \"/form\";\n    form.autoFields = true;\n    form.autoFiles = true;\n    form.maxFieldsSize = 5 * 1024 * 1024;\n    return new Promise(function(resolve, reject) {\n        form.parse(req, function(err, fields, files) {\n            if (err)\n                return reject(err);\n            _(fields).each((val, key) => {\n                if (1 == val.length)\n                    fields[key] = val[0];\n            });\n            resolve({\n                fields: fields,\n                files: _(files).reduce((acc, files) => {\n                    return acc.concat(files);\n                }, []).map(function(file) {\n                    file.name = file.originalFilename;\n                    return file;\n                })\n            });\n        });\n    });\n};\n\nexport let proxy = function() {\n    var proxy = config(\"system.fileDownloadProxy\");\n    if (!proxy)\n        return null;\n    var parts = proxy.split(\":\");\n    var auth = config(\"system.fileDownloadProxyAuth\");\n    return {\n        host: parts[0],\n        port: (parts[1] ? +parts[1] : null),\n        auth: (auth ? (\"Basic \" + new Buffer(auth).toString(\"base64\")) : null)\n    };\n};\n\nexport let correctAddress = function(ip) {\n    if (!ip || typeof ip !== 'string')\n        return null;\n    if (\"::1\" == ip)\n        ip = \"127.0.0.1\";\n    var match = ip.match(/^\\:\\:ffff\\:(\\d+\\.\\d+\\.\\d+\\.\\d+)$/);\n    if (match)\n        ip = match[1];\n    if (ip.replace(\":\", \"\") == ip)\n        ip = \"::\" + ip;\n    try {\n        var address = new Address6(ip);\n        if (address.isValid())\n            return address.correctForm();\n    } catch (err) {\n        //\n    }\n    try {\n        var address = Address6.fromAddress4(ip);\n        if (address.isValid())\n            return address.correctForm();\n    } catch (err) {\n        //\n    }\n    return null;\n};\n\nexport let preferIPv4 = function(ip) {\n    if (!ip)\n        return null;\n    try {\n        var address = new Address6(ip);\n        var ipv4 = address.to4();\n        if (ipv4.isValid()) {\n            ipv4 = ipv4.correctForm();\n            return (\"0.0.0.1\" == ipv4) ? \"127.0.0.1\" : ipv4;\n        }\n        if (address.isValid())\n            return address.correctForm();\n        return ip;\n    } catch (err) {\n        //\n    }\n    return ip;\n};\n\nexport function sha1(data) {\n  if (!data || (typeof data !== 'string' && !Util.isBuffer(data))) {\n    return null;\n  }\n  let hash = Crypto.createHash('sha1');\n  hash.update(data);\n  return hash.digest('hex');\n}\n\nexport let sha256 = function(data) {\n    if (!data)\n        return null;\n    var sha256 = Crypto.createHash(\"sha256\");\n    sha256.update(data);\n    return sha256.digest(\"hex\");\n};\n\nexport let withoutDuplicates = function(arr) {\n    if (!arr || !Util.isArray(arr))\n        return arr;\n    return arr.filter(function(item, i) {\n        return arr.indexOf(item) == i;\n    });\n};\n\nexport let series = function(arr, f, container) {\n    if (container && typeof container != \"object\")\n        container = [];\n    var isArray = Util.isArray(container);\n    var isObject = (typeof container == \"object\");\n    var p = Promise.resolve();\n    if (Util.isArray(arr)) {\n        arr.forEach(function(el, index) {\n            p = p.then(function() {\n                return f(el, index);\n            }).then(function(result) {\n                if (isArray)\n                    container.push(result);\n                else if (isObject)\n                    container[el] = result;\n            });\n        });\n    } else if (Util.isObject(arr)) {\n        _(arr).each((el, key) => {\n            p = p.then(function() {\n                return f(el, key);\n            }).then(function(result) {\n                if (isArray)\n                    container.push(result);\n                else if (isObject)\n                    container[key] = result;\n            });\n        });\n    }\n    if (!container)\n        return p;\n    return p.then(function() {\n        return Promise.resolve(container);\n    });\n};\n\nexport let generateTripcode = function(source) {\n    var md5 = Crypto.createHash(\"md5\");\n    md5.update(source + config(\"site.tripcodeSalt\", \"\"));\n    return \"!\" + md5.digest(\"base64\").substr(0, 10);\n};\n\nexport let plainText = function(text, options) {\n    if (!text)\n        return \"\";\n    text = \"\" + text;\n    var uuid = UUID.v4();\n    if (options && options.brToNewline)\n        text = text.replace(/<br \\/>/g, uuid);\n    else\n        text = text.replace(/<br \\/>/g, \" \");\n    text = HTMLToText.fromString(text, {\n        wordwrap: null,\n        linkHrefBaseUrl: config(\"site.protocol\", \"http\") + \"://\" + config(\"site.domain\", \"localhost:8080\"),\n        hideLinkHrefIfSameAsText: true,\n        ignoreImages: true\n    });\n    if (options && options.brToNewline)\n        text = text.split(uuid).join(\"\\n\");\n    return text;\n};\n\nexport let ipList = function(s) {\n    var ips = (s || \"\").split(/\\s+/).filter(function(ip) {\n        return ip;\n    });\n    //TODO: IP ranges\n    var err = ips.some(function(ip, i) {\n        ip = correctAddress(ip);\n        if (!ip)\n            return true;\n        ips[i] = ip;\n    });\n    if (err)\n        return translate(\"Invalid IP address\");\n    return withoutDuplicates(ips);\n};\n\nexport function option(source, acceptable, def, { strict, invert, test } = {}) {\n  if (typeof source === 'undefined') {\n    return def;\n  }\n  if (!_(acceptable).isArray()) {\n    acceptable = [acceptable];\n  }\n  let converted = source;\n  let accepted = acceptable.filter((a) => { return typeof a === 'string' && JS_TYPES.has(a); }).some((a) => {\n    if (typeof source === a) {\n      return true;\n    }\n    if (strict) {\n      return false;\n    }\n    switch (a) {\n    case 'number':\n      converted = +source;\n      return !isNaN(converted);\n    case 'boolean':\n      converted = !!source;\n      return true;\n    case 'string':\n      converted = '' + source;\n      return true;\n    break;\n    }\n  });\n  if (invert) {\n    accepted = !accepted;\n  }\n  if (typeof test === 'function') {\n    accepted = accepted && test(converted);\n  } else if (_(test).isRegExp()) {\n    accepted = accepted && test.test(converted);\n  }\n  return accepted ? converted : def;\n}\n\nexport function testPostNumber(postNumber) {\n  return postNumber > 0;\n}\n\nexport function cloned(value) {\n  if (_(value).isArray()) {\n    return value.slice(0).map(val => cloned(val));\n  } else if (_(value).isObject()) {\n    return merge.recursive(true, value);\n  } else {\n    return value;\n  }\n}\n\nexport function addIPv4(object, ip) {\n  ip = ip || (object && object.ip);\n  if (!ip) {\n    return object;\n  }\n  let ipv4 = preferIPv4(ip);\n  if (ipv4 && ipv4 !== ip) {\n    object.ipv4 = ipv4;\n  }\n  return object;\n}\n\nexport function createWatchedResource(path, synchronous, asynchronous) {\n  if (!FSSync.existsSync(path)) {\n    return;\n  }\n  if (typeof asynchronous === 'function') {\n    (new FSWatcher(path)).on('change', async function() {\n      try {\n        let exists = await FS.exists(path);\n        if (exists) {\n          await asynchronous(path);\n        }\n      } catch (err) {\n        Logger.error(err.stack || err);\n      }\n    });\n  }\n  return synchronous(path);\n}\n\nexport function compareRegisteredUserLevels(l1, l2) {\n  return REGISTERED_USER_LEVELS.indexOf(l1) - REGISTERED_USER_LEVELS.indexOf(l2);\n}\n\nexport function postingSpeedString(launchDate, lastPostNumber) {\n  launchDate = +launchDate;\n    if (isNaN(launchDate))\n        return \"-\";\n    var zeroSpeedString = function(nonZero) {\n        if (lastPostNumber && launchDate)\n            return \"1 \" + nonZero;\n        else\n            return \"0 \" + translate(\"post(s) per hour.\", \"postingSpeed\");\n    };\n    var speedString = function(duptime) {\n        var d = lastPostNumber / duptime;\n        var ss = \"\" + d.toFixed(1);\n        return (ss.split(\".\").pop() != \"0\") ? ss : ss.split(\".\").shift();\n    };\n    var uptimeMsecs = _.now() - launchDate;\n    var duptime = uptimeMsecs / HOUR;\n    var uptime = Math.floor(duptime);\n    var shour = translate(\"post(s) per hour.\", \"postingSpeed\");\n    if (!uptime) {\n        return zeroSpeedString(shour);\n    } else if (Math.floor(lastPostNumber / uptime) > 0) {\n        return speedString(duptime) + \" \" + shour;\n    } else {\n        duptime /= 24;\n        uptime = Math.floor(duptime);\n        var sday = translate(\"post(s) per day.\", \"postingSpeed\");\n        if (!uptime) {\n            return zeroSpeedString(sday);\n        } else if (Math.floor(lastPostNumber / uptime) > 0) {\n            return speedString(duptime) + \" \" + sday;\n        } else {\n            duptime /= (365.0 / 12.0);\n            uptime = Math.floor(duptime);\n            var smonth = translate(\"post(s) per month.\", \"postingSpeed\");\n            if (!uptime) {\n                return zeroSpeedString(smonth);\n            } else if (Math.floor(lastPostNumber / uptime) > 0) {\n                return speedString(duptime) + \" \" + smonth;\n            } else {\n                duptime /= 12.0;\n                uptime = Math.floor(duptime);\n                var syear = translate(\"post(s) per year.\", \"postingSpeed\");\n                if (!uptime)\n                    return zeroSpeedString(syear);\n                else if (Math.floor(lastPostNumber / uptime) > 0)\n                    return speedString(duptime) + \" \" + syear;\n                else\n                    return \"0 \" + syear;\n            }\n        }\n    }\n}\n\nexport function requireWrapper(m) {\n  return (m && m.default) || m;\n}\n\nexport function loadPlugins(paths, filter) {\n  if (typeof filter !== 'function') {\n    if (typeof filter === 'undefined' || filter) {\n      filter = (fileName) => { return 'index.js' !== fileName; };\n    } else {\n      filter = () => true;\n    }\n  }\n  if (!_(paths).isArray()) {\n    paths = [paths];\n  }\n  let list = paths.map((path, pathIndex) => {\n    return FSSync.readdirSync(path).filter((fileName) => {\n      return fileName.split('.').pop() === 'js';\n    }).filter((fileName, index, fileNames) => {\n      return filter(fileName, index, fileNames, path, pathIndex);\n    }).map((fileName) => {\n      let id = require.resolve(`${path}/${fileName}`);\n      if (require.cache.hasOwnProperty(id)) {\n        delete require.cache[id];\n      }\n      let plugins = requireWrapper(require(id));\n      if (!_(plugins).isArray()) {\n        plugins = [plugins];\n      }\n      return plugins;\n    });\n  });\n  return _(list).flatten();\n}\n\nexport function toHashpass(password, notHashpass) {\n  if (notHashpass || !mayBeHashpass(password)) {\n    password = sha1(password);\n  }\n  return password;\n}\n\nexport function processError(err, dir) {\n  if ('ENOENT' === err.code) {\n    err.status = 404;\n  } else if (typeof dir !== 'undefined') {\n    if (dir && 'ENOTDIR' === err.code) {\n      err = new Error(Tools.translate('Not a directory'));\n    } else if (!dir && 'EISDIR' === err.code) {\n      err = new Error(Tools.translate('Not a file'));\n    }\n  }\n  return err;\n}\n\nexport function rerenderPostsTargetsFromString(string) {\n  if (!string || typeof string !== 'string') {\n    return {};\n  }\n  return string.split(/\\s+/).reduce((acc, part) => {\n    let [boardName, ...postNumbers] = part.split(':');\n    if (boardName) {\n      if (postNumbers.length > 0) {\n        acc[boardName] = postNumbers.map((postNumber) => {\n          return option(postNumber, 'number', 0, { test: testPostNumber })\n        }).filter(postNumber => !!postNumber);\n      } else {\n        acc[boardName] = '*';\n      }\n    }\n    return acc;\n  }, {});\n}\n\nexport function pad(what, length, ch) {\n  what = '' + what;\n  length = option(length, 'number', 2, { test: (l) => { return l > 0; } });\n  if (!length) {\n    return what;\n  }\n  if (length - what.length <= 0) {\n    return what;\n  }\n  return Array(length - what.length).join((ch || '0').toString()[0]) + what;\n}\n"],"sourceRoot":"/source/"}