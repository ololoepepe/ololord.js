{"version":3,"sources":["helpers/chat.js"],"names":[],"mappings":"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","file":"helpers/chat.js","sourcesContent":["var Crypto = require(\"crypto\");\n\nvar Database = require(\"./database\");\nvar config = require(\"./config\");\nvar Tools = require(\"./tools\");\n\nimport * as PostsModel from '../models/posts';\n\nvar createHash = function(user) {\n    var sha256 = Crypto.createHash(\"sha256\");\n    sha256.update(user.hashpass || user.ip);\n    return sha256.digest(\"hex\");\n};\n\nmodule.exports.sendMessage = function(user, boardName, postNumber, text) {\n    if (!text)\n        return Promise.reject(Tools.translate(\"Message is empty\"));\n    if (!boardName)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    postNumber = +postNumber;\n    if (!boardName || !postNumber || postNumber < 0)\n        return Promise.reject(Tools.translate(\"Invalid post number\"));\n    var c = {};\n    c.key = boardName + \":\" + postNumber;\n    c.senderHash = createHash(user);\n    c.date = Tools.now();\n    c.ttl = config(\"server.chat.ttl\", 10080) * 60; //NOTE: 7 days\n    return PostsModel.getPost(boardName, postNumber).then(function(post) {\n        if (!post)\n            return Promise.reject(Tools.translate(\"No such post\"));\n        c.receiverHash = createHash(post.user);\n        c.receiver = post.user;\n        return Database.db.zrange(\"chat:\" + c.key, 0, 0);\n    }).then(function(msg) {\n        if (msg && msg.length > 0 && JSON.parse(msg[0]).senderHash != c.senderHash\n            && JSON.parse(msg[0]).receiverHash != c.senderHash) {\n            return Promise.reject(Tools.translate(\"Somebody is chatting here already\"));\n        }\n        return Database.db.smembers(\"chatMembers:\" + c.key);\n    }).then(function(members) {\n        if (!members || members.length < 2) {\n            c.members = [\n                JSON.stringify({\n                    hash: c.senderHash,\n                    ip: user.ip,\n                    hashpass: user.hashpass\n                }),\n                JSON.stringify({\n                    hash: c.receiverHash,\n                    ip: c.receiver.ip,\n                    hashpass: c.receiver.hashpass\n                })\n            ];\n            return Database.db.sadd(\"chatMembers:\" + c.key, c.members);\n        }\n        c.members = members;\n        if (c.senderHash == c.receiverHash) {\n            c.members.some(function(member) {\n                member = JSON.parse(member);\n                if (member.hash == c.senderHash)\n                    return;\n                c.receiverHash = member.hash;\n                c.receiver = {\n                    ip: member.ip,\n                    hashpass: member.hashpass\n                };\n                return true;\n            });\n        }\n        return Database.db.sadd(\"chats:\" + c.senderHash, c.key);\n    }).then(function() {\n        return Database.db.sadd(\"chats:\" + c.receiverHash, c.key);\n    }).then(function() {\n        return Database.db.zadd(\"chat:\" + c.key, +c.date.valueOf(), JSON.stringify({\n            text: text,\n            date: c.date.toISOString(),\n            senderHash: c.senderHash,\n            receiverHash: c.receiverHash\n        }));\n    }).then(function() {\n        return Database.db.expire(\"chats:\" + c.senderHash, c.ttl);\n    }).then(function() {\n        return Database.db.expire(\"chats:\" + c.receiverHash, c.ttl);\n    }).then(function() {\n        return Database.db.expire(\"chat:\" + c.key, c.ttl);\n    }).then(function() {\n        return Database.db.expire(\"chatMembers:\" + c.key, c.ttl);\n    }).then(function() {\n        return Promise.resolve({\n            message: {\n                text: text,\n                date: c.date.toISOString()\n            },\n            senderHash: c.senderHash,\n            receiverHash: c.receiverHash,\n            receiver: c.receiver\n        });\n    });\n};\n\nmodule.exports.getMessages = function(user, lastRequestDate) {\n    lastRequestDate = +(new Date(lastRequestDate)).valueOf();\n    if (!lastRequestDate)\n        lastRequestDate = 0;\n    var hash = createHash(user);\n    var chats = {};\n    var date = Tools.now().toISOString();\n    return Database.db.smembers(\"chats:\" + hash).then(function(keys) {\n        return Tools.series(keys, function(key) {\n            return Database.db.zrangebyscore(\"chat:\" + key, lastRequestDate, Infinity).then(function(list) {\n                list = (list || []).map(function(msg) {\n                    return JSON.parse(msg);\n                }).map(function(msg) {\n                    return {\n                        text: msg.text,\n                        date: msg.date,\n                        type: ((hash == msg.senderHash) ? \"out\" : \"in\")\n                    };\n                });\n                if (list.length > 0)\n                    chats[key] = list;\n            });\n        });\n    }).then(function() {\n        return Promise.resolve({\n            lastRequestDate: date,\n            chats: chats\n        });\n    });\n};\n\nmodule.exports.deleteMessages = function(user, boardName, postNumber) {\n    if (!boardName)\n        return Promise.reject(Tools.translate(\"Invalid board\"));\n    postNumber = +postNumber;\n    if (!boardName || !postNumber || postNumber < 0)\n        return Promise.reject(Tools.translate(\"Invalid post number\"));\n    var hash = createHash(user);\n    return Database.db.del(\"chats:\" + hash).then(function() {\n        return Promise.resolve({});\n    });\n};\n"],"sourceRoot":"/source/"}