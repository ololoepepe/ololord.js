{"version":3,"sources":["middlewares/index.js"],"names":[],"mappings":"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","file":"middlewares/index.js","sourcesContent":["var cookieParser = require(\"cookie-parser\");\nvar DDDoS = require(\"dddos\");\nvar express = require(\"express\");\n\nvar config = require(\"../helpers/config\");\nvar OnlineCounter = require(\"../helpers/online-counter\");\nvar Tools = require(\"../helpers/tools\");\n\nimport Logger from '../helpers/logger';\n\nvar excludePaths = {};\nvar excludeRules = [];\n\nvar resetExcluded = function(val, key) {\n    excludePaths = {};\n    excludeRules = [];\n    (val || []).forEach(function(rule) {\n        if (rule.regexp)\n            excludeRules.push(new RegExp(rule.regexp, rule.flags));\n        else if (rule.string)\n            excludePaths[rule.string] = {};\n    });\n};\n\nconfig.installSetHook(\"system.log.middleware.exclude\", resetExcluded);\nresetExcluded(config(\"system.log.middleware.exclude\", []));\n\nvar exclude = function(path) {\n    if (excludePaths.hasOwnProperty(path))\n        return true;\n    for (var i = 0; i < excludeRules.length; ++i) {\n        if (path.match(excludeRules[i]))\n            return true;\n    }\n    return false;\n};\n\nvar log = function(req, res, next) {\n    if (exclude(req.path))\n        return next();\n    var args;\n    if (req.method.match(/^post|put|patch|delete$/i) && config(\"system.log.middleware.verbosity\", \"ip\") == \"all\") {\n        args = [Tools.preferIPv4(req.ip), req.path, req.query];\n        return Tools.parseForm(req).then(function(result) {\n            req.formFields = result.fields;\n            req.formFiles = result.files;\n            args.push(result.fields);\n            Logger.info(...args);\n            return Promise.resolve();\n        }).catch(function(err) {\n            Logger.error(err);\n            return Promise.resolve();\n        }).then(next);\n    }\n    switch (config(\"system.log.middleware.verbosity\", \"ip\")) {\n    case \"all\":\n    case \"query\":\n        args = [Tools.preferIPv4(req.ip), req.path, req.query];\n        break;\n    case \"path\":\n        args = [Tools.preferIPv4(req.ip), req.path];\n        break;\n    case \"ip\":\n        args = [Tools.preferIPv4(req.ip)];\n        break;\n    default:\n        break;\n    }\n    if (args)\n        Logger.info(...args);\n    next();\n};\n\nlet middlewares = [];\n\nif (config(\"system.log.middleware.before\", \"all\") == \"all\")\n    middlewares.push(log);\n\nmiddlewares.push(Tools.requireWrapper(require('./ip-fix')));\nmiddlewares.push(function(req, res, next) {\n    OnlineCounter.alive(req.ip);\n    next();\n});\n\nvar setupDdos = function() {\n    if (config(\"system.log.middleware.before\", \"all\") == \"ddos\")\n        middlewares.push(log);\n\n    if (config(\"server.ddosProtection.enabled\", true)) {\n        middlewares.push(new DDDoS({\n            errorData: config(\"server.ddosProtection.errorData\", \"Not so fast!\"),\n            errorCode: config(\"server.ddosProtection.errorCode\", 429),\n            weight: config(\"server.ddosProtection.weight\", 1),\n            maxWeight: config(\"server.ddosProtection.maxWeight\", 10),\n            checkInterval: config(\"server.ddosProtection.checkInterval\", 1000),\n            rules: config(\"server.ddosProtection.rules\", [\n                {\n                    string: \"/misc/base.json\",\n                    maxWeight: 6,\n                    queueSize: 4\n                },\n                {\n                    string: \"/api/chatMessages.json\",\n                    maxWeight: 4,\n                    queueSize: 2\n                },\n                {\n                    string: \"/api/lastPostNumbers.json\",\n                    maxWeight: 4,\n                    queueSize: 2\n                },\n                {\n                    string: \"/api/captchaQuota.json\",\n                    maxWeight: 4,\n                    queueSize: 2\n                },\n                {\n                    string: \"/api/lastPostNumber.json\",\n                    maxWeight: 4,\n                    queueSize: 2\n                },\n                {\n                    regexp: \"^/api.*\",\n                    maxWeight: 6,\n                    queueSize: 4\n                },\n                {\n                    string: \"/action/search\",\n                    maxWeight: 1\n                },\n                {\n                    regexp: \".*\",\n                    maxWeight: 10\n                }\n            ]),\n            logFunction: Logger.error.bind(Logger, \"DDoS detected:\")\n        }).express());\n    }\n};\n\nvar setupStatic = function() {\n    if (config(\"system.log.middleware.before\", \"all\") == \"static\")\n        middlewares.push(log);\n    middlewares.push(express.static(__dirname + \"/../public\"));\n};\n\nif (config(\"server.ddosProtection.static\", false)) {\n    setupDdos();\n    setupStatic();\n} else {\n    setupStatic();\n    setupDdos();\n}\n\nif (config(\"system.log.middleware.before\", \"all\") == \"middleware\")\n    middlewares.push(log);\n\nmiddlewares = middlewares.concat([\n    cookieParser(),\n    function(req, res, next) {\n        req.hashpass = Tools.hashpass(req);\n        next();\n    },\n    Tools.requireWrapper(require(\"./registered-user\"))\n]);\n\nif (config(\"system.log.middleware.before\", \"all\") == \"request\")\n    middlewares.push(log);\n\nmiddlewares.push(require(\"./cookies\"));\n\nexport default middlewares;\n"],"sourceRoot":"/source/"}