{"version":3,"sources":["controllers/action-moder.js"],"names":["Files","Tools","ThreadsModel","UsersModel","BoardsModel","router","Router","MIN_TIME_OFFSET","MAX_TIME_OFFSET","BAN_EXPIRES_FORMAT","MIN_SUBNET_IP_V4","MAX_SUBNET_IP_V4","MIN_SUBNET_IP_V6","MAX_SUBNET_IP_V6","getBans","fields","timeOffset","bans","pick","value","name","test","option","o","reduce","acc","expiresAt","hours","Math","floor","abs","minutes","tz","pad","now","SECOND","boardName","Date","level","reason","postNumber","testPostNumber","post","req","res","next","isModer","Error","translate","parseForm","userIp","subnet","correctAddress","isIPv4","r4","r6","t","ip","banLevels","BAN_LEVELS","slice","each","ban","board","indexOf","getBannedUser","bannedUser","oldBans","date","modifiedBanBoards","Set","newBans","boardNames","hasOwnProperty","createdAt","add","getRegisteredUserLevelsByIp","levels","forEach","isSuperuser","compareRegisteredUserLevels","banUser","json","filter","key","length","checkUserBan","write","delall","transaction","threadNumber","targetBoardName","password","checkUserPermissions","sha1","moveThread","result","rollback","fixed","setThreadFixed","closed","setThreadClosed","unbumpable","setThreadUnbumpable"],"mappings":"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","file":"action-moder.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport moment from 'moment';\n\nimport Board from '../boards/board';\nimport config from '../helpers/config';\nimport * as Files from '../core/files';\nimport PostCreationTransaction from '../helpers/post-creation-transaction';\nimport * as Tools from '../helpers/tools';\nimport * as ThreadsModel from '../models/threads';\nimport * as UsersModel from '../models/users';\nimport * as BoardsModel from '../models/boards';\n\nlet router = express.Router();\n\nconst MIN_TIME_OFFSET = -720;\nconst MAX_TIME_OFFSET = 840;\nconst BAN_EXPIRES_FORMAT = 'YYYY/MM/DD HH:mm ZZ';\nconst MIN_SUBNET_IP_V4 = 22;\nconst MAX_SUBNET_IP_V4 = 32;\nconst MIN_SUBNET_IP_V6 = 64;\nconst MAX_SUBNET_IP_V6 = 128;\n\nfunction getBans(fields) {\n  let { timeOffset } = fields;\n  let bans = _(fields).pick((value, name) => {\n    return /^banBoard_\\S+$/.test(name) && 'NONE' !== fields[`banLevel_${value}`];\n  });\n  timeOffset = Tools.option(timeOffset, 'number', config('site.timeOffset'), {\n    test: (o) => { return (o >= MIN_TIME_OFFSET) && (o <= MAX_TIME_OFFSET); }\n  });\n  return _(bans).reduce((acc, value, name) => {\n    let expiresAt = fields[`banExpires_${value}`];\n    if (expiresAt) {\n      let hours = Math.floor(Math.abs(timeOffset) / 60);\n      let minutes = Math.abs(timeOffset) % 60;\n      let tz = ((timeOffset > 0) ? '+' : '') + Tools.pad(hours, 2, '0') + ':' + Tools.pad(minutes, 2, '0');\n      expiresAt = +moment(`${expiresAt} ${tz}`, BAN_EXPIRES_FORMAT);\n      if (expiresAt < (_.now() + Tools.SECOND)) {\n        expiresAt = null;\n      }\n    } else {\n      expiresAt = null;\n    }\n    acc[value] = {\n      boardName: value,\n      expiresAt: (expiresAt ? new Date(expiresAt) : null),\n      level: fields[`banLevel_${value}`],\n      reason: fields[`banReason_${value}`],\n      postNumber: Tools.option(fields[`banPostNumber_${value}`], 'number', null, { test: Tools.testPostNumber })\n    };\n    return acc;\n  }, {});\n}\n\nrouter.post('/action/banUser', async function(req, res, next) {\n  try {\n    if (!req.isModer()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields } = await Files.parseForm(req);\n    let { userIp, subnet } = fields;\n    userIp = Tools.correctAddress(userIp);\n    if (!userIp) {\n      throw new Error(Tools.translate('Invalid IP address'));\n    }\n    subnet = Tools.subnet(userIp, subnet);\n    if (subnet) {\n      let isIPv4 = /^\\:\\:[0-9a-f]{1,4}\\:[0-9a-f]{1,4}$/.test(userIp);\n      if ((isIPv4 && (subnet.subnet < MIN_SUBNET_IP_V4)) || (!isIPv4 && (subnet.subnet < MIN_SUBNET_IP_V6))) {\n        let r4 = `${MIN_SUBNET_IP_V4}-${MAX_SUBNET_IP_V4}`;\n        let r6 = `${MIN_SUBNET_IP_V6}-${MAX_SUBNET_IP_V6}`;\n        let t = Tools.translate('Subnet is too large. $[1] for IPv4 and $[2] for IPv6 are allowed', '', r4, r6);\n        throw new Error(t);\n      }\n    }\n    if (userIp === req.ip) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let bans = getBans(fields);\n    let banLevels = Tools.BAN_LEVELS.slice(1);\n    _(bans).each((ban) => {\n      if (!Board.board(ban.boardName)) {\n        throw new Error(Tools.translate('Invalid board: $[1]', '', ban.boardName));\n      }\n      if (banLevels.indexOf(ban.level) < 0) {\n        throw new Error(Tools.translate('Invalid ban level: $[1]', '', ban.level));\n      }\n    });\n    let bannedUser = await UsersModel.getBannedUser(userIp);\n    let oldBans = bannedUser ? bannedUser.bans : {};\n    let date = Tools.now();\n    let modifiedBanBoards = new Set();\n    let newBans = Board.boardNames().reduce((acc, boardName) => {\n      if (req.isModer(boardName)) {\n        if (bans.hasOwnProperty(boardName)) {\n          let ban = bans[boardName];\n          ban.createdAt = date;\n          acc[boardName] = ban;\n          modifiedBanBoards.add(boardName);\n        } else if (oldBans.hasOwnProperty(boardName)) {\n          modifiedBanBoards.add(boardName);\n        }\n      } else if (oldBans.hasOwnProperty(boardName)) {\n        acc[boardName] = oldBans[boardName];\n      }\n      return acc;\n    }, {});\n    let levels = await UsersModel.getRegisteredUserLevelsByIp(userIp, subnet);\n    modifiedBanBoards.forEach((boardName) => {\n      let level = req.level(boardName);\n      if (!req.isSuperuser(boardName) && Tools.compareRegisteredUserLevels(level, levels[boardName]) <= 0) {\n        throw new Error(Tools.translate('Not enough rights'));\n      }\n    });\n    await UsersModel.banUser(userIp, newBans, subnet);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/delall', async function(req, res, next) {\n  try {\n    if (!req.isModer()) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let { fields } = await Files.parseForm(req);\n    let { userIp } = fields;\n    userIp = Tools.correctAddress(userIp);\n    if (!userIp) {\n      throw new Error(Tools.translate('Invalid IP address'));\n    }\n    if (userIp === req.ip) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    let boardNames = _(fields).filter((boardName, key) => {\n      return /^board_\\S+$/.test(key);\n    });\n    if (boardNames.length <= 0) {\n      throw new Error(Tools.translate('No board specified'));\n    }\n    boardNames.forEach((boardName) => {\n      if (!Board.board(boardName)) {\n        throw new Error(Tools.translate('Invalid board'));\n      }\n      if (!req.isModer(boardName)) {\n        throw new Error(Tools.translate('Not enough rights'));\n      }\n    });\n    await UsersModel.checkUserBan(req.ip, boardNames, { write: true });\n    await BoardsModel.delall(req, userIp, boardNames);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/moveThread', async function(req, res, next) {\n  let transaction;\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { boardName, threadNumber, targetBoardName, password } = fields;\n    if (!Board.board(boardName) || !Board.board(targetBoardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    if (boardName === targetBoardName) {\n      throw new Error(Tools.translate('Source and target boards are the same'));\n    }\n    threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!threadNumber) {\n      throw new Error(Tools.translate('Invalid thread number'));\n    }\n    if (!req.isModer(boardName) || !req.isModer(targetBoardName)) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    await UsersModel.checkUserBan(req.ip, [boardName, targetBoardName], { write: true });\n    await UsersModel.checkUserPermissions(req, boardName, threadNumber, 'moveThread', Tools.sha1(password));\n    transaction = new PostCreationTransaction(boardName);\n    let result = await ThreadsModel.moveThread(boardName, threadNumber, targetBoardName, transaction);\n    res.json(result);\n  } catch (err) {\n    if (transaction) {\n      transaction.rollback();\n    }\n    next(err);\n  }\n});\n\nrouter.post('/action/setThreadFixed', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { boardName, threadNumber, fixed, password } = fields;\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!threadNumber) {\n      throw new Error(Tools.translate('Invalid thread number'));\n    }\n    if (!req.isModer(boardName)) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    await UsersModel.checkUserBan(req.ip, boardName, { write: true });\n    await UsersModel.checkUserPermissions(req, boardName, threadNumber, 'setThreadFixed', Tools.sha1(password));\n    await ThreadsModel.setThreadFixed(boardName, threadNumber, 'true' === fixed);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/setThreadClosed', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { boardName, threadNumber, closed, password } = fields;\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!threadNumber) {\n      throw new Error(Tools.translate('Invalid thread number'));\n    }\n    if (!req.isModer(boardName)) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    await UsersModel.checkUserBan(req.ip, boardName, { write: true });\n    await UsersModel.checkUserPermissions(req, boardName, threadNumber, 'setThreadClosed', Tools.sha1(password));\n    await ThreadsModel.setThreadClosed(boardName, threadNumber, 'true' === closed);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/setThreadUnbumpable', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { boardName, threadNumber, unbumpable, password } = fields;\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!threadNumber) {\n      throw new Error(Tools.translate('Invalid thread number'));\n    }\n    if (!req.isModer(boardName)) {\n      throw new Error(Tools.translate('Not enough rights'));\n    }\n    await UsersModel.checkUserBan(req.ip, boardName, { write: true });\n    await UsersModel.checkUserPermissions(req, boardName, threadNumber, 'setThreadUnbumpable', Tools.sha1(password));\n    await ThreadsModel.setThreadUnbumpable(boardName, threadNumber, 'true' === unbumpable);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nexport default router;\n"]}