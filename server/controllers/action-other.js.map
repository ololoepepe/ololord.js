{"version":3,"sources":["controllers/action-other.js"],"names":["Files","Tools","ChatsModel","PostsModel","UsersModel","IPC","router","Router","post","req","res","next","parseForm","fields","boardName","postNumber","chatNumber","text","board","Error","translate","option","test","testPostNumber","ip","geolocationInfo","checkUserBan","write","addChatMessage","user","result","message","receiver","type","hashpass","send","ips","hashpasses","json","n","deleteChatMessages","key","data","JSON","parse","setSynchronizationData","query","page","length","p","phrases","match","model","searchQuery","map","phrase","replace","searchBoard","findPosts","maxSubjectLength","maxTextLength","searchResults","posts","plainText","substr","subject","number","threadNumber","archived","total","max","captchaIDs","forEach","id","captcha","actionRoutes","route","method","path","handler","boardNames","name","module","exports"],"mappings":"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","file":"action-other.js","sourcesContent":["import express from 'express';\n\nimport Board from '../boards/board';\nimport Captcha from '../captchas/captcha';\nimport * as Files from '../core/files';\nimport geolocation from '../core/geolocation';\nimport config from '../helpers/config';\nimport * as Tools from '../helpers/tools';\nimport * as ChatsModel from '../models/chats';\nimport * as PostsModel from '../models/posts';\nimport * as UsersModel from '../models/users';\nimport * as IPC from '../helpers/ipc';\n\nlet router = express.Router();\n\nrouter.post('/action/sendChatMessage', async function(req, res, next) {\n  try {\n    let { fields: { boardName, postNumber, chatNumber, text } } = await Files.parseForm(req);\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!postNumber) {\n      throw new Error(Tools.translate('Invalid post number'));\n    }\n    if (!text || typeof text !== 'string') {\n      throw new Error(Tools.translate('Message is empty'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    let result = await ChatsModel.addChatMessage({\n      user: req,\n      boardName: boardName,\n      postNumber: postNumber,\n      chatNumber: chatNumber,\n      text: text\n    });\n    let { message, receiver } = result;\n    message.type = 'in';\n    let ip = receiver.hashpass ? null : receiver.ip;\n    IPC.send('sendChatMessage', {\n      type: 'newChatMessage',\n      message: {\n        message: message,\n        boardName: boardName,\n        postNumber: postNumber,\n        chatNumber: result.chatNumber\n      },\n      ips: ip,\n      hashpasses: receiver.hashpass\n    });\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/deleteChatMessages', async function(req, res, next) {\n  try {\n    let { fields: { boardName, postNumber, chatNumber } } = await Files.parseForm(req);\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!postNumber) {\n      throw new Error(Tools.translate('Invalid post number'));\n    }\n    chatNumber = Tools.option(chatNumber, 'number', 0, { test: (n) => { return n > 0; } });\n    if (!chatNumber) {\n      throw new Error(Tools.translate('Invalid chat number'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await ChatsModel.deleteChatMessages({\n      user: req,\n      boardName: boardName,\n      postNumber: postNumber,\n      chatNumber: chatNumber\n    });\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/synchronize', async function(req, res, next) {\n  try {\n    let { fields: { key, data } } = await Files.parseForm(req);\n    if (!key || typeof key !== 'string') {\n      throw new Error(Tools.translate('No key specified'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    try {\n      data = JSON.parse(data);\n    } catch (err) {\n      throw new Error(Tools.translate('Failed to parse data'));\n    }\n    await UsersModel.setSynchronizationData(key, data);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/search', async function(req, res, next) {\n  try {\n    let { fields: { query, boardName, page } } = await Files.parseForm(req);\n    if (!query || typeof query !== 'string') {\n      throw new Error(Tools.translate('Search query is empty'));\n    }\n    if (query.length > config('site.maxSearchQueryLength')) {\n      throw new Error(Tools.translate('Search query is too long'));\n    }\n    if ('*' === boardName) {\n      boardName = '';\n    }\n    if (boardName && !Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    page = Tools.option(page, 'number', 0, { test: (p) => { return p >= 0; } });\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    let phrases = query.match(/\\w+|\"[^\"]+\"/g) || [];\n    let model = {\n      searchQuery: query,\n      phrases: phrases.map(phrase => phrase.replace(/(^\\-|^\"|\"$)/g, '')),\n      searchBoard: boardName\n    };\n    let result = await PostsModel.findPosts(query, boardName, page);\n    let maxSubjectLength = config('system.search.maxResultPostSubjectLengh');\n    let maxTextLength = config('system.search.maxResultPostTextLengh');\n    model.searchResults = result.posts.map((post) => {\n      let text = (post.plainText || '').replace(/\\r*\\n+/g, ' ');\n      if (text.length > maxTextLength) {\n        text = text.substr(0, maxTextLength - 1) + '…';\n      }\n      let subject = post.subject || text;\n      if (subject.length > maxSubjectLength) {\n        subject = subject.substr(0, maxSubjectLength - 1) + '…';\n      }\n      return {\n        boardName: post.boardName,\n        postNumber: post.number,\n        threadNumber: post.threadNumber,\n        archived: post.archived,\n        subject: subject,\n        text: text\n      };\n    });\n    model.total = result.total;\n    model.max = result.max;\n    res.json(model);\n  } catch (err) {\n    next(err);\n  }\n});\n\nCaptcha.captchaIDs().forEach((id) => {\n  Captcha.captcha(id).actionRoutes().forEach((route) => {\n    router[route.method](`/action${route.path}`, route.handler);\n  });\n});\n\nBoard.boardNames().forEach((name) => {\n  Board.board(name).actionRoutes().forEach((route) => {\n    router[route.method](`/action${route.path}`, route.handler);\n  });\n});\n\nmodule.exports = router;\n"]}