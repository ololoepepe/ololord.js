{"version":3,"sources":["controllers/index.js"],"names":["Tools","EXCLUDED_ROUTERS","Set","app","router","Router","routers","initialize","use","req","res","next","query","source","redirect","replace","loadPlugins","__dirname","fileName","_1","_2","path","has","split","slice","forEach","plugin","push","id","r","requireWrapper","require","create404Error","baseUrl","err","series","formFiles","file","exists","remove","error","stack","status","preferIPv4","ip","sendFile","root","hasOwnProperty","isError","message","json"],"mappings":"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","file":"index.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport FS from 'q-io/fs';\n\nimport config from '../helpers/config';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport middlewares from '../middlewares';\n\nconst EXCLUDED_ROUTERS = new Set(['index.js', 'home.js', 'board.js']);\n\nlet app = express();\nlet router = express.Router();\napp.routers = [];\n\nfunction initialize() {\n  app.use(middlewares);\n\n  router.use('/redirect', (req, res, next) => {\n    if (!req.query.source) {\n      return next();\n    }\n    res.redirect(307, `/${config('site.pathPrefix')}${req.query.source.replace(/^\\//, '')}`);\n  });\n\n  Tools.loadPlugins([__dirname, `${__dirname}/custom`], (fileName, _1, _2, path) => {\n    return !EXCLUDED_ROUTERS.has(fileName) || (path.split('/').slice(-2, -1)[0] === 'custom');\n  }).forEach((plugin) => {\n    router.use('/', plugin);\n    app.routers.push(plugin);\n  });\n\n  ['./board', './home'].forEach((id) => {\n    let r = Tools.requireWrapper(require(id));\n    router.use('/', r);\n    app.routers.push(r);\n  });\n\n  app.use(router);\n\n  app.use('*', (req, res, next) => {\n    next(Tools.create404Error(req.baseUrl));\n  });\n\n  app.use((err, req, res, next) => {\n    Tools.series(req.formFiles, async function(file) {\n      try {\n        let exists = FS.exists(file.path);\n        if (exists) {\n          await FS.remove(file.path);\n        }\n      } catch (err) {\n        Logger.error(err.stack || err);\n      }\n    });\n    switch (err.status) {\n    case 404: {\n      Logger.error(Tools.preferIPv4(req.ip), err.path, 404);\n      res.status(404).sendFile('notFound.html', { root: `${__dirname}/../../public` });\n      break;\n    }\n    default: {\n      Logger.error(Tools.preferIPv4(req.ip), req.path, err.stack || err);\n      if (err.hasOwnProperty('ban')) {\n      } else {\n        if (_(err).isError()) {\n          var message = err.message;\n        } else {\n          var message = (typeof err === 'string') ? err : '';\n        }\n      }\n      res.json({ message: message });\n      break;\n    }\n    }\n  });\n}\n\napp.initialize = initialize;\n\nexport default app;\n"]}