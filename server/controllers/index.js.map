{"version":3,"sources":["controllers/index.js"],"names":[],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;IAAY,K;;AACZ;;;;;;;;;;AAEA,IAAM,mBAAmB,IAAI,GAAJ,CAAQ,CAAC,UAAD,EAAa,SAAb,EAAwB,UAAxB,CAAR,CAAzB;;AAEA,IAAI,MAAM,wBAAV;AACA,IAAI,SAAS,kBAAQ,MAAR,EAAb;AACA,IAAI,OAAJ,GAAc,EAAd;;AAEA,SAAS,UAAT,GAAsB;AACpB,MAAI,GAAJ;;AAEA,SAAO,GAAP,CAAW,WAAX,EAAwB,UAAC,GAAD,EAAM,GAAN,EAAW,IAAX,EAAoB;AAC1C,QAAI,CAAC,IAAI,KAAJ,CAAU,MAAf,EAAuB;AACrB,aAAO,MAAP;AACD;AACD,QAAI,QAAJ,CAAa,GAAb,QAAsB,sBAAO,iBAAP,CAAtB,GAAkD,IAAI,KAAJ,CAAU,MAAV,CAAiB,OAAjB,CAAyB,KAAzB,EAAgC,EAAhC,CAAlD;AACD,GALD;;AAOA,QAAM,WAAN,CAAkB,CAAC,SAAD,EAAe,SAAf,aAAlB,EAAsD,UAAC,QAAD,EAAW,EAAX,EAAe,EAAf,EAAmB,IAAnB,EAA4B;AAChF,WAAO,CAAC,iBAAiB,GAAjB,CAAqB,QAArB,CAAD,IAAoC,KAAK,KAAL,CAAW,GAAX,MAAoB,QAA/D;AACD,GAFD,EAEG,OAFH,CAEW,UAAC,MAAD,EAAY;AACrB,WAAO,GAAP,CAAW,GAAX,EAAgB,MAAhB;AACA,QAAI,OAAJ,CAAY,IAAZ,CAAiB,MAAjB;AACD,GALD;;AAOA,GAAC,SAAD,EAAY,QAAZ,EAAsB,OAAtB,CAA8B,UAAC,EAAD,EAAQ;AACpC,QAAI,IAAI,MAAM,cAAN,CAAqB,QAAQ,EAAR,CAArB,CAAR;AACA,WAAO,GAAP,CAAW,GAAX,EAAgB,CAAhB;AACA,QAAI,OAAJ,CAAY,IAAZ,CAAiB,CAAjB;AACD,GAJD;;AAMA,MAAI,GAAJ,CAAQ,MAAR;;AAEA,MAAI,GAAJ,CAAQ,GAAR,EAAa,UAAC,GAAD,EAAM,GAAN,EAAW,IAAX,EAAoB;AAC/B,QAAI,MAAM,IAAI,KAAJ,EAAV;AACA,QAAI,MAAJ,GAAa,GAAb;AACA,QAAI,IAAJ,GAAW,IAAI,OAAf;AACA,SAAK,GAAL;AACD,GALD;;AAOA,MAAI,GAAJ,CAAQ,UAAC,GAAD,EAAM,GAAN,EAAW,GAAX,EAAgB,IAAhB,EAAyB;AAC/B,UAAM,MAAN,CAAa,IAAI,SAAjB;AAAA,0DAA4B,iBAAe,IAAf;AAAA,YAEpB,MAFoB;AAAA;AAAA;AAAA;AAAA;AAAA;AAEpB,sBAFoB,GAEX,aAAG,MAAH,CAAU,KAAK,IAAf,CAFW;;AAAA,qBAGpB,MAHoB;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAIhB,aAAG,MAAH,CAAU,KAAK,IAAf,CAJgB;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAOxB,iCAAO,KAAP,CAAa,YAAI,KAAJ,eAAb;;AAPwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAA5B;;AAAA;AAAA;AAAA;AAAA;AAUA,YAAQ,IAAI,MAAZ;AACA,WAAK,GAAL;AAAU;AACR,2BAAO,KAAP,CAAa,MAAM,UAAN,CAAiB,IAAI,EAArB,CAAb,EAAuC,IAAI,IAA3C,EAAiD,GAAjD;AACA,cAAI,MAAJ,CAAW,GAAX,EAAgB,QAAhB,CAAyB,eAAzB,EAA0C,EAAE,MAAS,SAAT,kBAAF,EAA1C;AACA;AACD;AACD;AAAS;AACP,2BAAO,KAAP,CAAa,MAAM,UAAN,CAAiB,IAAI,EAArB,CAAb,EAAuC,IAAI,IAA3C,EAAiD,IAAI,KAAJ,IAAa,GAA9D;AACA,cAAI,IAAI,cAAJ,CAAmB,KAAnB,CAAJ,EAA+B;AAC7B,gBAAI,QAAQ,EAAE,KAAK,IAAI,GAAX,EAAZ;AACD,WAFD,MAEO;AACL,gBAAI,0BAAE,GAAF,EAAO,OAAP,EAAJ,EAAsB;AACpB,kBAAI,UAAU,IAAI,OAAlB;AACD,aAFD,MAEO;AACL,kBAAI,UAAW,OAAO,GAAP,KAAe,QAAhB,GAA4B,GAA5B,GAAkC,EAAhD;AACD;AACF;AACD,cAAI,IAAJ,CAAS,EAAE,SAAS,OAAX,EAAT;AACA;AACD;AAnBD;AAqBD,GAhCD;AAiCD;;AAED,IAAI,UAAJ,GAAiB,UAAjB;;kBAEe,G","file":"controllers/index.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport FS from 'q-io/fs';\nimport FSSync from 'fs';\n\nimport config from '../helpers/config';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport middlewares from '../middlewares';\n\nconst EXCLUDED_ROUTERS = new Set(['index.js', 'home.js', 'board.js']);\n\nlet app = express();\nlet router = express.Router();\napp.routers = [];\n\nfunction initialize() {\n  app.use(middlewares);\n\n  router.use('/redirect', (req, res, next) => {\n    if (!req.query.source) {\n      return next();\n    }\n    res.redirect(307, `/${config('site.pathPrefix')}${req.query.source.replace(/^\\//, '')}`);\n  });\n\n  Tools.loadPlugins([__dirname, `${__dirname}/custom`], (fileName, _1, _2, path) => {\n    return !EXCLUDED_ROUTERS.has(fileName) || (path.split('/') === 'custom');\n  }).forEach((plugin) => {\n    router.use('/', plugin);\n    app.routers.push(plugin);\n  });\n\n  ['./board', './home'].forEach((id) => {\n    let r = Tools.requireWrapper(require(id));\n    router.use('/', r);\n    app.routers.push(r);\n  });\n\n  app.use(router);\n\n  app.use('*', (req, res, next) => {\n    let err = new Error();\n    err.status = 404;\n    err.path = req.baseUrl;\n    next(err);\n  });\n\n  app.use((err, req, res, next) => {\n    Tools.series(req.formFiles, async function(file) {\n      try {\n        let exists = FS.exists(file.path);\n        if (exists) {\n          await FS.remove(file.path);\n        }\n      } catch (err) {\n        Logger.error(err.stack || err);\n      }\n    });\n    switch (err.status) {\n    case 404: {\n      Logger.error(Tools.preferIPv4(req.ip), err.path, 404);\n      res.status(404).sendFile('notFound.html', { root: `${__dirname}/../../public` });\n      break;\n    }\n    default: {\n      Logger.error(Tools.preferIPv4(req.ip), req.path, err.stack || err);\n      if (err.hasOwnProperty('ban')) {\n        var model = { ban: err.ban };\n      } else {\n        if (_(err).isError()) {\n          var message = err.message;\n        } else {\n          var message = (typeof err === 'string') ? err : '';\n        }\n      }\n      res.json({ message: message });\n      break;\n    }\n    }\n  });\n};\n\napp.initialize = initialize;\n\nexport default app;\n"],"sourceRoot":"/source/"}