{"version":3,"sources":["storage/redis-client-factory.js"],"names":[],"mappings":";;;;;;;;kBAsCe,UAAS,EAAT,EAAa;AAC1B,MAAI,OAAO,QAAO,EAAP,yCAAO,EAAP,OAAc,QAAd,IAA0B,OAAO,EAAP,KAAc,SAA/C,CAAJ,EAA+D;AAC7D,WAAO,cAAP;AACD;AACD,MAAI,CAAC,EAAL,EAAS;AACP,QAAI,CAAC,aAAL,EAAoB;AAClB,sBAAgB,cAAhB;AACD;AACD,WAAO,aAAP;AACD;AACD,MAAI,SAAS,QAAQ,GAAR,CAAY,EAAZ,CAAb;AACA,MAAI,CAAC,MAAL,EAAa;AACX,aAAS,cAAT;AACA,YAAQ,GAAR,CAAY,EAAZ,EAAgB,MAAhB;AACD;AACD,SAAO,MAAP;AACD,C;;AAtDD;;;;AACA;;;;AAEA;;;;;;AAEA,IAAI,gBAAgB,IAApB;AACA,IAAI,UAAU,IAAI,GAAJ,EAAd;;AAEA,SAAS,aAAT,GAAyB;AACvB,SAAO;AACL,UAAM,sBAAO,mBAAP,CADD;AAEL,UAAM,sBAAO,mBAAP,CAFD;AAGL,YAAQ,sBAAO,qBAAP,CAHH;AAIL,cAAU,sBAAO,uBAAP,CAJL;AAKL,QAAI,sBAAO,iBAAP;AALC,GAAP;AAOD;;AAED,SAAS,YAAT,GAAwB;AACtB,MAAI,aAAa,sBAAO,oBAAP,CAAjB;AACA,MAAI,qBAAE,OAAF,CAAU,UAAV,KAAyB,WAAW,MAAX,GAAoB,CAAjD,EAAoD;AAClD,WAAO,IAAI,kBAAM,OAAV,CAAkB,UAAlB,EAA8B;AACnC,4BAAsB,sBAAO,mCAAP,EAA4C,UAAC,KAAD,EAAW;AACzE,eAAO,KAAK,GAAL,CAAS,MAAM,QAAQ,CAAvB,EAA0B,IAA1B,CAAP;AACH,OAFqB,CADa;AAInC,wBAAkB,sBAAO,+BAAP,CAJiB;AAKnC,kBAAY,sBAAO,yBAAP,CALuB;AAMnC,uBAAiB,sBAAO,8BAAP,CANkB;AAOnC,4BAAsB,sBAAO,mCAAP,CAPa;AAQnC,+BAAyB,sBAAO,sCAAP,CARU;AASnC,4BAAsB,sBAAO,mCAAP,CATa;AAUnC,oBAAc;AAVqB,KAA9B,CAAP;AAYD,GAbD,MAaO;AACL,WAAO,sBAAU,eAAV,CAAP;AACD;AACF","file":"storage/redis-client-factory.js","sourcesContent":["import _ from 'underscore';\nimport Redis from 'ioredis';\n\nimport config from '../helpers/config';\n\nlet defaultClient = null;\nlet clients = new Map();\n\nfunction createOptions() {\n  return {\n    host: config('system.redis.host'),\n    port: config('system.redis.port'),\n    family: config('system.redis.family'),\n    password: config('system.redis.password'),\n    db: config('system.redis.db')\n  }\n};\n\nfunction createClient() {\n  let redisNodes = config('system.redis.nodes');\n  if (_.isArray(redisNodes) && redisNodes.length > 0) {\n    return new Redis.Cluster(redisNodes, {\n      clusterRetryStrategy: config('system.redis.clusterRetryStrategy', (times) => {\n          return Math.min(100 + times * 2, 2000);\n      }),\n      enableReadyCheck: config('system.redis.enableReadyCheck'),\n      scaleReads: config('system.redis.scaleReads'),\n      maxRedirections: config('system.redis.maxRedirections'),\n      retryDelayOnFailover: config('system.redis.retryDelayOnFailover'),\n      retryDelayOnClusterDown: config('system.redis.retryDelayOnClusterDown'),\n      retryDelayOnTryAgain: config('system.redis.retryDelayOnTryAgain'),\n      redisOptions: createOptions()\n    });\n  } else {\n    return new Redis(createOptions());\n  }\n}\n\nexport default function(id) {\n  if (id && (typeof id === 'object' || typeof id === 'boolean')) {\n    return createClient();\n  }\n  if (!id) {\n    if (!defaultClient) {\n      defaultClient = createClient();\n    }\n    return defaultClient;\n  }\n  let client = clients.get(id);\n  if (!client) {\n    client = createClient();\n    clients.set(id, client);\n  }\n  return client;\n}\n"],"sourceRoot":"/source/"}