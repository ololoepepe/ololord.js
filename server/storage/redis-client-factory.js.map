{"version":3,"sources":["storage/redis-client-factory.js"],"names":["id","createClient","defaultClient","client","clients","get","set","Map","scripts","loadScripts","path","readdirSync","forEach","entry","entryPath","stat","statSync","isFile","match","numberOfKeys","lua","readFileSync","isDirectory","__dirname","createOptions","host","port","family","password","db","redisNodes","isArray","length","Cluster","clusterRetryStrategy","times","Math","min","enableReadyCheck","scaleReads","maxRedirections","retryDelayOnFailover","retryDelayOnClusterDown","retryDelayOnTryAgain","redisOptions","script","name","defineCommand"],"mappings":";;;;;;;;kBAiEe,UAASA,EAAT,EAAa;AAC1B,MAAIA,OAAO,QAAOA,EAAP,yCAAOA,EAAP,OAAc,QAAd,IAA0B,OAAOA,EAAP,KAAc,SAA/C,CAAJ,EAA+D;AAC7D,WAAOC,cAAP;AACD;AACD,MAAI,CAACD,EAAL,EAAS;AACP,QAAI,CAACE,aAAL,EAAoB;AAClBA,sBAAgBD,cAAhB;AACD;AACD,WAAOC,aAAP;AACD;AACD,MAAIC,SAASC,QAAQC,GAAR,CAAYL,EAAZ,CAAb;AACA,MAAI,CAACG,MAAL,EAAa;AACXA,aAASF,cAAT;AACAG,YAAQE,GAAR,CAAYN,EAAZ,EAAgBG,MAAhB;AACD;AACD,SAAOA,MAAP;AACD,C;;AAjFD;;;;AACA;;;;AACA;;;;AAEA;;;;;;AAEA,IAAID,gBAAgB,IAApB;AACA,IAAIE,UAAU,IAAIG,GAAJ,EAAd;AACA,IAAIC,UAAU,IAAID,GAAJ,EAAd;;AAEA,SAASE,WAAT,CAAqBC,IAArB,EAA2B;AACzB,eAAOC,WAAP,CAAmBD,IAAnB,EAAyBE,OAAzB,CAAiC,UAACC,KAAD,EAAW;AAC1C,QAAIC,YAAeJ,IAAf,SAAuBG,KAA3B;AACA,QAAIE,OAAO,aAAOC,QAAP,CAAgBF,SAAhB,CAAX;AACA,QAAIC,KAAKE,MAAL,EAAJ,EAAmB;AACjB,UAAIC,QAAQL,MAAMK,KAAN,CAAY,wBAAZ,CAAZ;AACA,UAAIA,KAAJ,EAAW;AACTV,gBAAQF,GAAR,CAAYY,MAAM,CAAN,CAAZ,EAAsB;AACpBC,wBAAcD,MAAM,CAAN,KAAY,CADN;AAEpBE,eAAK,aAAOC,YAAP,CAAoBP,SAApB,EAA+B,MAA/B;AAFe,SAAtB;AAID;AACF,KARD,MAQO,IAAIC,KAAKO,WAAL,EAAJ,EAAwB;AAC7Bb,kBAAYK,SAAZ;AACD;AACF,GAdD;AAeD;;AAEDL,YAAec,SAAf;;AAEA,SAASC,aAAT,GAAyB;AACvB,SAAO;AACLC,UAAM,sBAAO,mBAAP,CADD;AAELC,UAAM,sBAAO,mBAAP,CAFD;AAGLC,YAAQ,sBAAO,qBAAP,CAHH;AAILC,cAAU,sBAAO,uBAAP,CAJL;AAKLC,QAAI,sBAAO,iBAAP;AALC,GAAP;AAOD;;AAED,SAAS5B,YAAT,GAAwB;AACtB,MAAI6B,aAAa,sBAAO,oBAAP,CAAjB;AACA,MAAI3B,eAAJ;AACA,MAAI,qBAAE4B,OAAF,CAAUD,UAAV,KAAyBA,WAAWE,MAAX,GAAoB,CAAjD,EAAoD;AAClD7B,aAAS,IAAI,kBAAM8B,OAAV,CAAkBH,UAAlB,EAA8B;AACrCI,4BAAsB,sBAAO,mCAAP,EAA4C,UAACC,KAAD,EAAW;AACzE,eAAOC,KAAKC,GAAL,CAAS,MAAMF,QAAQ,CAAvB,EAA0B,IAA1B,CAAP;AACH,OAFqB,CADe;AAIrCG,wBAAkB,sBAAO,+BAAP,CAJmB;AAKrCC,kBAAY,sBAAO,yBAAP,CALyB;AAMrCC,uBAAiB,sBAAO,8BAAP,CANoB;AAOrCC,4BAAsB,sBAAO,mCAAP,CAPe;AAQrCC,+BAAyB,sBAAO,sCAAP,CARY;AASrCC,4BAAsB,sBAAO,mCAAP,CATe;AAUrCC,oBAAcpB;AAVuB,KAA9B,CAAT;AAYD,GAbD,MAaO;AACLrB,aAAS,sBAAUqB,eAAV,CAAT;AACD;AACDhB,UAAQI,OAAR,CAAgB,UAACiC,MAAD,EAASC,IAAT,EAAkB;AAChC3C,WAAO4C,aAAP,CAAqBD,IAArB,EAA2BD,MAA3B;AACD,GAFD;AAGA,SAAO1C,MAAP;AACD","file":"redis-client-factory.js","sourcesContent":["import _ from 'underscore';\nimport FSSync from 'fs';\nimport Redis from 'ioredis';\n\nimport config from '../helpers/config';\n\nlet defaultClient = null;\nlet clients = new Map();\nlet scripts = new Map();\n\nfunction loadScripts(path) {\n  FSSync.readdirSync(path).forEach((entry) => {\n    let entryPath = `${path}/${entry}`\n    let stat = FSSync.statSync(entryPath);\n    if (stat.isFile()) {\n      let match = entry.match(/^(.+?)\\.((\\d+)\\.)?lua$/);\n      if (match) {\n        scripts.set(match[1], {\n          numberOfKeys: match[3] || 0,\n          lua: FSSync.readFileSync(entryPath, 'utf8')\n        });\n      }\n    } else if (stat.isDirectory()) {\n      loadScripts(entryPath);\n    }\n  });\n}\n\nloadScripts(`${__dirname}/../../misc/lua`);\n\nfunction createOptions() {\n  return {\n    host: config('system.redis.host'),\n    port: config('system.redis.port'),\n    family: config('system.redis.family'),\n    password: config('system.redis.password'),\n    db: config('system.redis.db')\n  }\n}\n\nfunction createClient() {\n  let redisNodes = config('system.redis.nodes');\n  let client;\n  if (_.isArray(redisNodes) && redisNodes.length > 0) {\n    client = new Redis.Cluster(redisNodes, {\n      clusterRetryStrategy: config('system.redis.clusterRetryStrategy', (times) => {\n          return Math.min(100 + times * 2, 2000);\n      }),\n      enableReadyCheck: config('system.redis.enableReadyCheck'),\n      scaleReads: config('system.redis.scaleReads'),\n      maxRedirections: config('system.redis.maxRedirections'),\n      retryDelayOnFailover: config('system.redis.retryDelayOnFailover'),\n      retryDelayOnClusterDown: config('system.redis.retryDelayOnClusterDown'),\n      retryDelayOnTryAgain: config('system.redis.retryDelayOnTryAgain'),\n      redisOptions: createOptions()\n    });\n  } else {\n    client = new Redis(createOptions());\n  }\n  scripts.forEach((script, name) => {\n    client.defineCommand(name, script);\n  });\n  return client;\n}\n\nexport default function(id) {\n  if (id && (typeof id === 'object' || typeof id === 'boolean')) {\n    return createClient();\n  }\n  if (!id) {\n    if (!defaultClient) {\n      defaultClient = createClient();\n    }\n    return defaultClient;\n  }\n  let client = clients.get(id);\n  if (!client) {\n    client = createClient();\n    clients.set(id, client);\n  }\n  return client;\n}\n"]}