{"version":3,"sources":["storage/sql-client-factory.js"],"names":[],"mappings":";;;;;;kBAwDe,UAAS,IAAT,EAAe;AAC5B,MAAI,CAAC,IAAL,EAAW;AACT,WAAO,MAAP;AACD;AACD,MAAI,SAAS,QAAQ,GAAR,CAAY,IAAZ,CAAb;AACA,MAAI,CAAC,MAAL,EAAa;AACX,aAAS,aAAa,IAAb,CAAT;AACA,YAAQ,GAAR,CAAY,IAAZ,EAAkB,MAAlB;AACD;AACD,SAAO,MAAP;AACD,C;;AAlED;;;;AACA;;;;AAEA;;;;AACA;;IAAY,K;;;;;;AAEZ,IAAI,UAAU,IAAI,GAAJ,EAAd;;AAEA,SAAS,YAAT,CAAsB,IAAtB,EAA4B;AAC1B,SAAO,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAqB;AACtC,QAAI,KAAK,IAAI,iBAAQ,QAAZ,CAAwB,SAAxB,sBAAkD,IAAlD,cAAiE,UAAC,GAAD,EAAS;AACjF,UAAI,GAAJ,EAAS;AACP,eAAO,GAAP;AACA;AACD;AACD,SAAG,WAAH,GAAiB,YAAM;AACrB,eAAO,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAqB;AACtC,aAAG,GAAH,CAAO,mBAAP,EAA4B,EAA5B,EAAgC,UAAC,GAAD,EAAS;AACvC,gBAAI,GAAJ,EAAS;AACP,qBAAO,GAAP;AACD,aAFD,MAEO;AACL,iBAAG,iBAAH,GAAuB,IAAvB;AACA;AACD;AACF,WAPD;AAQD,SATM,CAAP;AAUD,OAXD;AAYA,SAAG,MAAH,GAAY,YAAM;AAChB,eAAO,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAqB;AACtC,aAAG,GAAH,CAAO,oBAAP,EAA6B,EAA7B,EAAiC,UAAC,GAAD,EAAS;AACxC,eAAG,iBAAH,GAAuB,KAAvB;AACA,gBAAI,GAAJ,EAAS;AACP,qBAAO,GAAP;AACD,aAFD,MAEO;AACL;AACD;AACF,WAPD;AAQD,SATM,CAAP;AAUD,OAXD;AAYA,SAAG,QAAH,GAAc,YAAM;AAClB,eAAO,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAqB;AACtC,aAAG,GAAH,CAAO,sBAAP,EAA+B,EAA/B,EAAmC,UAAC,GAAD,EAAS;AAC1C,eAAG,iBAAH,GAAuB,KAAvB;AACA,gBAAI,GAAJ,EAAS;AACP,qBAAO,GAAP;AACD,aAFD,MAEO;AACL;AACD;AACF,WAPD;AAQD,SATM,CAAP;AAUD,OAXD;AAYA,cAAQ,EAAR;AACD,KA1CQ,CAAT;AA2CD,GA5CM,CAAP;AA6CD","file":"storage/sql-client-factory.js","sourcesContent":["import FS from 'q-io/fs';\nimport SQLite3 from 'sqlite3';\n\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\n\nlet clients = new Map();\n\nfunction createClient(name) {\n  return new Promise((resolve, reject) => {\n    let db = new SQLite3.Database(`${__dirname}/../../sqlite/${name}.sqlite`, (err) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n      db.transaction = () => {\n        return new Promise((resolve, reject) => {\n          db.run('BEGIN TRANSACTION', [], (err) => {\n            if (err) {\n              reject(err);\n            } else {\n              db.manualTransaction = true;\n              resolve();\n            }\n          });\n        });\n      };\n      db.commit = () => {\n        return new Promise((resolve, reject) => {\n          db.run('COMMIT TRANSACTION', [], (err) => {\n            db.manualTransaction = false;\n            if (err) {\n              reject(err);\n            } else {\n              resolve();\n            }\n          });\n        });\n      };\n      db.rollback = () => {\n        return new Promise((resolve, reject) => {\n          db.run('ROLLBACK TRANSACTION', [], (err) => {\n            db.manualTransaction = false;\n            if (err) {\n              reject(err);\n            } else {\n              resolve();\n            }\n          });\n        });\n      };\n      resolve(db);\n    });\n  });\n}\n\nexport default function(name) {\n  if (!name) {\n    name = 'main';\n  }\n  let client = clients.get(name);\n  if (!client) {\n    client = createClient(name);\n    clients.set(name, client);\n  }\n  return client;\n}\n"],"sourceRoot":"/source/"}