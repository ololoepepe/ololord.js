{"version":3,"sources":["models/posts.js"],"names":["boardName","postNumber","options","board","Error","Tools","translate","option","test","testPostNumber","client","collection","Post","findOne","number","createPostProjection","getPost","threadNumber","lastPostNumber","query","$lt","count","getPostCount","oldPostCount","newPostCount","updateOne","$inc","sequenceNumber","adjustPostSequenceNumber","dateTime","Thread","$set","updatedAt","toISOString","matchedCount","setThreadUpdateTime","req","fields","files","transaction","date","unbumpable","archived","text","markupMode","name","subject","sage","signAsOp","tripcode","password","now","getPostBoard","postCount","postLimit","rawText","markupModes","referencedPosts","accessLevel","level","getPostExtraData","extraData","BoardsModel","nextPostNumber","fileInfos","FilesModel","createFileInfos","post","plainText","Renderer","brToNewline","markup","createPostOptions","user","createPostUser","geolocation","geolocationInfo","fileInfoCount","length","toArray","referringPosts","createdAt","addPostNumber","insertOne","postCountNew","bumpLimit","PostReferencesModel","addReferringPosts","IPC","render","rerenderReferencedPosts","createPost","oldReferencedPosts","editPostExtraData","findOneAndUpdate","projection","withFileInfos","withExtraData","withReferences","returnOriginal","result","value","removeReferringPosts","editPost","findOneAndDelete","$ne","updateMany","$gt","updateReferringPosts","refs","removeFiles","deletePost","targets","boardNames","isArray","reduce","acc","series","postNumbers","error","find","posts","map","filter","indexOf","flatten","undefined","markupPosts","sourceBoardName","sourceThreadNumber","targetBoardName","initialPostNumber","sourceBoard","targetBoard","_id","postNumberMap","index","replacePostLinks","transformPostExtraData","replacePostReferences","copyFiles","newFileInfos","copyPosts","limit","offset","sort","cursor","l","o","reverse","splice","getThreadPosts","page","q","$text","$search","score","$meta","skip","max","total","findPosts","postingEnabled","showTripcode","hashpass","bannedFor","ip","sha1"],"mappings":"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","file":"posts.js","sourcesContent":["import _ from 'underscore';\n\nimport * as BoardsModel from './boards';\nimport * as FilesModel from './files';\nimport * as PostReferencesModel from './post-references';\nimport Board from '../boards/board';\nimport * as Renderer from '../core/renderer';\nimport config from '../helpers/config';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport markup from '../markup';\nimport mongodbClient from '../storage/mongodb-client-factory';\n\nlet client = mongodbClient();\n\nfunction createPostProjection({ withExtraData, withFileInfos, withReferences } = {}) {\n  let projection = { _id: 0 };\n  if (!withExtraData) {\n    projection.extraData = 0;\n  }\n  if (!withFileInfos) {\n    projection.fileInfos = 0;\n  }\n  if (!withReferences) {\n    projection.referencedPosts = 0;\n    projection.referringPosts = 0;\n  }\n  return projection;\n}\n\nexport async function getPost(boardName, postNumber, options) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!postNumber) {\n    throw new Error(Tools.translate('Invalid post number'));\n  }\n  let Post = await client.collection('post');\n  return await Post.findOne({\n    boardName: boardName,\n    number: postNumber\n  }, createPostProjection(options));\n}\n\nfunction getPostBoard(boardName) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  if (!board.postingEnabled) {\n    throw new Error(Tools.translate('Posting is disabled at this board'));\n  }\n  return board;\n}\n\nasync function getPostCount(boardName, threadNumber, lastPostNumber) {\n  let Post = await client.collection('post');\n  let query = {\n    boardName: boardName,\n    threadNumber: threadNumber\n  };\n  if (lastPostNumber) {\n    query.number = { $lt: lastPostNumber };\n  }\n  return await Post.count(query);\n}\n\nfunction createPostOptions(req, sage, tripcode, signAsOp) {\n  return {\n    sage: sage,\n    showTripcode: !!req.hashpass && ('true' === tripcode),\n    signAsOp: ('true' === signAsOp),\n    bannedFor: false\n  };\n}\n\nexport function createPostUser(req, accessLevel, password) {\n  return {\n    hashpass: (req.hashpass || null),\n    ip: req.ip,\n    level: accessLevel,\n    password: Tools.sha1(password)\n  };\n}\n\nasync function adjustPostSequenceNumber(boardName, postNumber, oldPostCount, newPostCount) {\n  let Post = await client.collection('post');\n  await Post.updateOne({\n    boardName: boardName,\n    number: postNumber\n  }, {\n    $inc: { sequenceNumber: (newPostCount - oldPostCount) }\n  });\n}\n\nasync function setThreadUpdateTime(boardName, threadNumber, dateTime) {\n  let Thread = await client.collection('thread');\n  let { matchedCount } = await Thread.updateOne({\n    boardName: boardName,\n    number: threadNumber\n  }, {\n    $set: { updatedAt: dateTime.toISOString() }\n  });\n  if (matchedCount <= 0) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n}\n\nexport async function createPost(req, fields, files, transaction, { postNumber, date, unbumpable, archived } = {}) {\n  let { boardName, threadNumber, text, markupMode, name, subject, sage, signAsOp, tripcode, password } = fields;\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n  date = date || Tools.now();\n  unbumpable = !!unbumpable;\n  let board = getPostBoard(boardName);\n  if (postNumber) {\n    threadNumber = postNumber;\n  }\n  let Post = await client.collection('post');\n  let postCount = await getPostCount(boardName, threadNumber);\n  if (postCount >= board.postLimit) {\n    throw new Error(Tools.translate('Post limit reached'));\n  }\n  let rawText = text || null;\n  let markupModes = markup.markupModes(markupMode);\n  let referencedPosts = {};\n  sage = ('true' === sage);\n  let accessLevel = (name? req.level(boardName): null) || null;\n  text = await markup(boardName, rawText, {\n    markupModes: markupModes,\n    accessLevel: accessLevel,\n    referencedPosts: referencedPosts\n  });\n  let extraData = await board.getPostExtraData(req, fields, files);\n  if (!postNumber) {\n    postNumber = await BoardsModel.nextPostNumber(boardName);\n  }\n  let fileInfos = FilesModel.createFileInfos(files, boardName, postNumber);\n  let post = {\n    boardName: boardName,\n    number: postNumber,\n    threadNumber: threadNumber,\n    sequenceNumber: postCount + 1,\n    archived: !!archived,\n    name: name || null,\n    subject: subject || null,\n    rawText: rawText,\n    text: text || null,\n    plainText: (text ? Renderer.plainText(text, { brToNewline: true }) : null),\n    markup: markupModes,\n    options: createPostOptions(req, sage, tripcode, signAsOp),\n    user: createPostUser(req, accessLevel, password),\n    geolocation: req.geolocationInfo,\n    fileInfos: fileInfos,\n    fileInfoCount: fileInfos.length,\n    extraData: extraData,\n    referencedPosts: _(referencedPosts).toArray(),\n    referringPosts: [],\n    createdAt: date.toISOString(),\n    updatedAt: null\n  };\n  transaction.addPostNumber(postNumber);\n  await Post.insertOne(post);\n  let postCountNew = await getPostCount(boardName, threadNumber, postNumber);\n  if (postCountNew !== postCount) {\n    await adjustPostSequenceNumber(boardName, postNumber, postCount, postCountNew);\n    //TODO: Get new sequenceNumber\n  }\n  if (!sage && (postCount < board.bumpLimit) && !unbumpable) {\n    await setThreadUpdateTime(boardName, threadNumber, date);\n  }\n  await PostReferencesModel.addReferringPosts(referencedPosts, boardName, postNumber, threadNumber);\n  await IPC.render(boardName, threadNumber, postNumber, 'create');\n  (async function() {\n    await PostReferencesModel.rerenderReferencedPosts(boardName, threadNumber, referencedPosts);\n  })();\n  return post;\n}\n\nexport async function editPost(req, fields) {\n  let { boardName, postNumber, text, name, subject, sage, markupMode } = fields;\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!postNumber) {\n    throw new Error(Tools.translate('Invalid post number'));\n  }\n  let Post = await client.collection('post');\n  let query = {\n    boardName: boardName,\n    number: postNumber\n  };\n  let post = await Post.findOne(query, {\n    threadNumber: 1,\n    referencedPosts: 1,\n    extraData: 1\n  });\n  if (!post) {\n    throw new Error(Tools.translate('No such post'));\n  }\n  let threadNumber = post.threadNumber;\n  let oldReferencedPosts = post.referencedPosts;\n  let date = Tools.now();\n  let rawText = text || null;\n  let markupModes = markup.markupModes(markupMode);\n  let referencedPosts = {};\n  //sage = ('true' === sage);\n  text = await markup(boardName, rawText, {\n    markupModes: markupModes,\n    accessLevel: req.level(boardName),\n    referencedPosts: referencedPosts\n  });\n  let extraData = await board.editPostExtraData(req, fields, post.extraData);\n  let result = await Post.findOneAndUpdate(query, {\n    $set: {\n      markup: markupModes,\n      name: name || null,\n      rawText: rawText,\n      subject: subject || null,\n      text: text || null,\n      plainText: (text ? Renderer.plainText(text, { brToNewline: true }) : null),\n      referencedPosts: _(referencedPosts).toArray(),\n      updatedAt: date\n    }\n  }, {\n    projection: createPostProjection({\n      withFileInfos: true,\n      withExtraData: true,\n      withReferences: true\n    }),\n    returnOriginal: false\n  });\n  post = result.value;\n  if (!post) {\n    throw new Error(Tools.translate('No such post'));\n  }\n  await PostReferencesModel.removeReferringPosts(boardName, postNumber);\n  await PostReferencesModel.addReferringPosts(referencedPosts, boardName, postNumber, threadNumber);\n  (async function() {\n    await IPC.render(boardName, threadNumber, postNumber, 'edit');\n    await PostReferencesModel.rerenderReferencedPosts(boardName, threadNumber, referencedPosts, oldReferencedPosts);\n  })();\n  return post;\n}\n\nexport async function deletePost(boardName, postNumber) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!postNumber) {\n    throw new Error(Tools.translate('Invalid post number'));\n  }\n  let Post = await client.collection('post');\n  let result = await Post.findOneAndDelete({\n    boardName: boardName,\n    threadNumber: { $ne: postNumber },\n    number: postNumber,\n    archived: false\n  }, {\n    projection: {\n      threadNumber: 1,\n      referencedPosts: 1,\n      referringPosts: 1,\n      fileInfos: 1\n    }\n  });\n  let post = result.value;\n  if (!post) {\n    throw new Error(Tools.translate('No such post'));\n  }\n  let threadNumber = post.threadNumber;\n  let oldReferencedPosts = post.referencedPosts;\n  let referringPosts = post.referringPosts;\n  await Post.updateMany({\n    boardName: boardName,\n    threadNumber: threadNumber,\n    number: { $gt: postNumber }\n  }, {\n    $inc: { sequenceNumber: -1 }\n  });\n  await PostReferencesModel.removeReferringPosts(boardName, postNumber);\n  await IPC.render(boardName, threadNumber, postNumber, 'edit');\n  (async function() {\n    let refs = await PostReferencesModel.updateReferringPosts(referringPosts, boardName, postNumber, threadNumber);\n    await PostReferencesModel.rerenderReferencedPosts(boardName, threadNumber, refs, oldReferencedPosts);\n    await FilesModel.removeFiles(post.fileInfos);\n  })();\n}\n\nexport async function markupPosts(targets) {\n  if (typeof targets !== 'object') {\n    return;\n  }\n  if (_(targets).toArray().length <= 0) {\n    targets = Board.boardNames();\n  }\n  if (_(targets).isArray()) {\n    targets = targets.reduce((acc, boardName) => {\n      acc[boardName] = '*';\n      return acc;\n    }, {});\n  }\n  let Post = await client.collection('post');\n  let posts = await Tools.series(targets, async function(postNumbers, boardName) {\n    if (typeof postNumbers !== 'string' && !_(postNumbers).isArray()) {\n      return [];\n    }\n    if (!Board.board(boardName)) {\n      Logger.error(new Error(Tools.translate('Invalid board name: $[1]', '', boardName)));\n      return [];\n    }\n    let posts = await Post.find({ boardName: boardName }, {\n      number: 1,\n      threadNumber: 1\n    }).toArray();\n    posts = posts.map(({ number, threadNumber }) => {\n      return {\n        boardName: boardName,\n        postNumber: number,\n        threadNumber: threadNumber\n      };\n    });\n    if ('*' !== postNumbers) {\n      posts = posts.filter(({ postNumber }) => { return (postNumbers.indexOf(postNumber) >= 0); });\n    }\n    return posts;\n  }, true);\n  let refs = await PostReferencesModel.updateReferringPosts(_(posts).flatten());\n  await PostReferencesModel.rerenderReferencedPosts(undefined, undefined, refs);\n}\n\nexport async function copyPosts({ sourceBoardName, sourceThreadNumber, targetBoardName, initialPostNumber,\n  transaction }) {\n  let sourceBoard = Board.board(sourceBoardName);\n  if (!sourceBoard) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let targetBoard = Board.board(targetBoardName);\n  if (!targetBoard) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let Post = await client.collection('post');\n  let posts = await Post.find({\n    boardName: sourceBoardName,\n    threadNumber: sourceThreadNumber\n  }, { _id: 0 }).toArray();\n  let postNumberMap = posts.reduce((acc, post, index) => {\n    acc[post.number] = initialPostNumber + index;\n    return acc;\n  }, {});\n  posts = await Tools.series(posts, async function(post) {\n    post.number = postNumberMap[post.number];\n    post.boardName = targetBoardName;\n    post.threadNumber = initialPostNumber;\n    if (post.rawText) {\n      let text = PostReferencesModel.replacePostLinks(post.rawText, sourceBoardName, post.referencedPosts,\n        postNumberMap);\n      if (text !== post.rawText) {\n        post.rawText = text;\n        post.text = await markup(targetBoardName, text, {\n          markupModes: post.markup,\n          accessLevel: post.user.level\n        });\n        post.plainText = Renderer.plainText(post.text, { brToNewline: true });\n      }\n    }\n    post.extraData = await targetBoard.transformPostExtraData(post.extraData, sourceBoard);\n    post.referencedPosts = PostReferencesModel.replacePostReferences(post.referencedPosts, {\n      boardName: sourceBoardName,\n      threadNumber: post.threadNumber\n    }, {\n      boardName: targetBoardName,\n      threadNumber: initialPostNumber\n    }, postNumberMap);\n    posts.referringPosts = [];\n    await PostReferencesModel.addReferringPosts(post.referencedPosts, targetBoardName, post.number, post.threadNumber);\n    let newFileInfos = await FilesModel.copyFiles(post.fileInfos, sourceBoardName, targetBoardName, transaction);\n    post.fileInfos = FilesModel.createFileInfos(newFileInfos, targetBoardName, post.number);\n    transaction.addPostNumber(post.number);\n    await Post.insertOne(post);\n    return post;\n  }, true);\n}\n\nexport async function getThreadPosts(boardName, threadNumber, { limit, offset, sort } = {}) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    throw new Error(Tools.translate('Invalid thread number'));\n  }\n  let Post = await client.collection('post');\n  let cursor = Post.find({\n    boardName: boardName,\n    threadNumber: threadNumber\n  }, createPostProjection({\n    withExtraData: true,\n    withFileInfos: true,\n    withReferences: true\n  }));\n  if (sort) {\n    cursor = cursor.sort({ number: -1 });\n  }\n  limit = Tools.option(limit, 'number', 0, { test: (l) => { return l > 0; } });\n  offset = Tools.option(offset, 'number', 0, { test: (o) => { return o > 0; } });\n  if (limit || offset) {\n    cursor = cursor.limit(limit + offset);\n  }\n  let posts = await cursor.toArray();\n  if (sort) {\n    posts.reverse();\n  }\n  if (limit) {\n    if (posts.length > limit) {\n      posts.splice(0, posts.length - limit);\n    } else if (offset) {\n      posts.splice(0, offset);\n    }\n  }\n  return posts;\n}\n\nexport async function findPosts(query, boardName, page) {\n  let Post = await client.collection('post');\n  let q = {\n    $text: { $search: query }\n  };\n  if (boardName) {\n    q.boardName = boardName;\n  }\n  let limit = config('system.search.maxResultCount');\n  let score = { $meta: 'textScore' };\n  let posts = await Post.find(q, {\n    boardName: 1,\n    number: 1,\n    threadNumber: 1,\n    archived: 1,\n    subject: 1,\n    plainText: 1,\n    score: score\n  }).sort({\n    score: score,\n    boardName: 1,\n    number: 1\n  }).skip(page * limit).limit(limit).toArray();\n  let count = await Post.count(q);\n  return {\n    posts: posts,\n    max: limit,\n    total: count\n  };\n}\n"]}