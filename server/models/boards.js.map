{"version":3,"sources":["models/boards.js"],"names":["boardName","threadNumber","board","Error","Tools","translate","ThreadsModel","getThread","thread","PostsModel","getThreadPosts","posts","postCount","length","opPost","splice","lastPosts","title","postSubject","addDataToThread","pageNumber","option","test","n","pageCount","pageCounts","get","getThreads","sort","limit","threadsPerPage","offset","threads","client","collection","Post","series","getPost","number","withExtraData","withFileInfos","withReferences","maxLastPosts","getThreadPostCount","omittedPosts","filter","getLastPostNumber","lastPostNumber","currentPage","postingSpeed","Renderer","postingSpeedString","launchDate","getPage","sortMode","sortFunction","sortThreadsByCreationDate","toLowerCase","sortThreadsByDate","sortThreadsByPostCount","getCatalog","archived","getArchive","PostCounter","findOne","_id","result","boardNames","isArray","some","query","$in","find","toArray","reduce","acc","getLastPostNumbers","Thread","getThreadCount","threadCount","Math","ceil","set","getPageCount","incrementBy","i","findOneAndUpdate","$inc","projection","upsert","returnOriginal","value","skippedGetOrder","pow","nextPostNumber","clearDeletedThreads","initialize","req","ip","correctAddress","deletedThreads","updatedThreads","deletedPosts","forEach","post","hasOwnProperty","deleteOne","deleteThread","IPC","render","delall","Map","bumpLimit","postLimit","bumpLimitReached","postLimitReached","postingEnabled","closed","maxLength","subject","text","plainText","replace","l","substr"],"mappings":"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","file":"boards.js","sourcesContent":["import _ from 'underscore';\n\nimport * as PostsModel from './posts';\nimport * as ThreadsModel from './threads';\nimport Board from '../boards/board';\nimport * as Renderer from '../core/renderer';\nimport * as IPC from '../helpers/ipc';\nimport * as Tools from '../helpers/tools';\nimport mongodbClient from '../storage/mongodb-client-factory';\n\nlet client = mongodbClient();\nlet pageCounts = new Map();\n\nfunction addDataToThread(thread, board) {\n  thread.bumpLimit = board.bumpLimit;\n  thread.postLimit = board.postLimit;\n  thread.bumpLimitReached = (thread.postCount >= board.bumpLimit);\n  thread.postLimitReached = (thread.postCount >= board.postLimit);\n  thread.postingEnabled = (board.postingEnabled && !thread.closed);\n}\n\nexport function postSubject(post, maxLength) {\n  let subject = '';\n  if (post.subject) {\n    subject = post.subject;\n  } else if (post.text) {\n    subject = Renderer.plainText(post.text);\n  }\n  subject = subject.replace(/\\r*\\n+/gi, '');\n  maxLength = Tools.option(maxLength, 'number', 0, { test: (l) => { return l > 0; } });\n  if (maxLength > 1 && subject.length > maxLength) {\n    subject = subject.substr(0, maxLength - 1) + '…';\n  }\n  return subject;\n}\n\nexport async function getThread(boardName, threadNumber) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let thread = await ThreadsModel.getThread(boardName, threadNumber);\n  let posts = await PostsModel.getThreadPosts(boardName, threadNumber);\n  thread.postCount = posts.length;\n  if (thread.postCount <= 0) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  thread.opPost = posts.splice(0, 1)[0];\n  thread.lastPosts = posts;\n  thread.title = postSubject(thread.opPost, 50) || null;\n  addDataToThread(thread, board);\n  return thread;\n}\n\nexport async function getPage(boardName, pageNumber) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  pageNumber = Tools.option(pageNumber, 'number', -1, { test: (n) => { return n >= 0; } });\n  let pageCount = pageCounts.get(boardName);\n  if (pageNumber < 0 || pageNumber >= pageCount) {\n    throw new Error(Tools.translate('Invalid page number'));\n  }\n  let threads = await ThreadsModel.getThreads(boardName, {\n    sort: -1,\n    limit: board.threadsPerPage,\n    offset: pageNumber * board.threadsPerPage\n  });\n  let Post = await client.collection('post');\n  await Tools.series(threads, async function(thread) {\n    thread.opPost = await PostsModel.getPost(boardName, thread.number, {\n      withExtraData: true,\n      withFileInfos: true,\n      withReferences: true\n    });\n    thread.lastPosts = await PostsModel.getThreadPosts(boardName, thread.number, {\n      limit: board.maxLastPosts,\n      offset: 1,\n      sort: true\n    });\n    thread.postCount = await ThreadsModel.getThreadPostCount(boardName, thread.number);\n    addDataToThread(thread, board);\n    if (thread.postCount > (board.maxLastPosts + 1)) {\n      thread.omittedPosts = thread.postCount - board.maxLastPosts - 1;\n    } else {\n      thread.omittedPosts = 0;\n    }\n  });\n  threads = threads.filter((thread) => { return (thread.opPost && (thread.postCount > 0)); });\n  let lastPostNumber = await getLastPostNumber(boardName);\n  return {\n    threads: threads,\n    pageCount: pageCount,\n    currentPage: pageNumber,\n    lastPostNumber: lastPostNumber,\n    postingSpeed: Renderer.postingSpeedString(board.launchDate, lastPostNumber)\n  };\n}\n\nexport async function getCatalog(boardName, sortMode) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let threads = await ThreadsModel.getThreads(boardName);\n  let Post = await client.collection('post');\n  await Tools.series(threads, async function(thread) {\n    thread.opPost = await PostsModel.getPost(boardName, thread.number, {\n      withFileInfos: true,\n      withReferences: true\n    });\n    thread.postCount = await ThreadsModel.getThreadPostCount(boardName, thread.number);\n    addDataToThread(thread, board);\n  });\n  let sortFunction = ThreadsModel.sortThreadsByCreationDate;\n  switch ((sortMode || 'date').toLowerCase()) {\n  case 'recent':\n    sortFunction = ThreadsModel.sortThreadsByDate;\n    break;\n  case 'bumps':\n    sortFunction = ThreadsModel.sortThreadsByPostCount;\n    break;\n  default:\n    break;\n  }\n  let lastPostNumber = await getLastPostNumber(boardName);\n  return {\n    threads: threads.sort(sortFunction),\n    lastPostNumber: lastPostNumber,\n    postingSpeed: Renderer.postingSpeedString(board.launchDate, lastPostNumber)\n  };\n}\n\nexport async function getArchive(boardName) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let threads = await ThreadsModel.getThreads(boardName, { archived: true });\n  threads.sort(ThreadsModel.sortThreadsByDate);\n  let Post = await client.collection('post');\n  await Tools.series(threads, async function(thread) {\n    thread.opPost = await PostsModel.getPost(boardName, thread.number);\n    thread.title = postSubject(thread.opPost, 50) || null;\n  });\n  let lastPostNumber = await getLastPostNumber(boardName);\n  return {\n    threads: threads,\n    lastPostNumber: lastPostNumber,\n    postingSpeed: Renderer.postingSpeedString(board.launchDate, lastPostNumber)\n  };\n}\n\nexport async function getLastPostNumber(boardName) {\n  if (!Board.board(boardName)) {\n    throw new Error(Tools.translate('Invalid boardName'));\n  }\n  let PostCounter = await client.collection('postCounter');\n  let result = await PostCounter.findOne({ _id: boardName }, { lastPostNumber: 1 });\n  return result ? result.lastPostNumber : 0;\n}\n\nexport async function getLastPostNumbers(boardNames) {\n  if (!_(boardNames).isArray()) {\n    boardNames = [boardNames];\n  }\n  if (boardNames.some(boardName => !Board.board(boardName))) {\n    throw new Error(Tools.translate('Invalid boardName'));\n  }\n  let PostCounter = await client.collection('postCounter');\n  let query = {\n    _id: { $in: boardNames }\n  };\n  let result = await PostCounter.find(query).toArray();\n  return result.reduce((acc, { _id, lastPostNumber }) => {\n    acc[_id] = lastPostNumber;\n    return acc;\n  }, {});\n}\n\nexport async function getPageCount(boardName) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let Thread = await client.collection('thread');\n  let threadCount = await ThreadsModel.getThreadCount(boardName);\n  let pageCount = Math.ceil(threadCount / board.threadsPerPage) || 1;\n  pageCounts.set(boardName, pageCount);\n  return pageCount;\n}\n\nexport async function nextPostNumber(boardName, incrementBy) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  incrementBy = Tools.option(incrementBy, 'number', 1, { test: (i) => { return i >= 1; } });\n  let PostCounter = await client.collection('postCounter');\n  let result = await PostCounter.findOneAndUpdate({ _id: boardName }, {\n    $inc: { lastPostNumber: incrementBy }\n  }, {\n    projection: { lastPostNumber: 1 },\n    upsert: true,\n    returnOriginal: false\n  });\n  if (!result) {\n    return 0;\n  }\n  let { lastPostNumber } = result.value;\n  //TODO: improve get skipping\n  if ((1 === incrementBy) && (board.skippedGetOrder > 0) && !(lastPostNumber % Math.pow(10, board.skippedGetOrder))) {\n    return await nextPostNumber(boardName, incrementBy);\n  }\n  return lastPostNumber;\n}\n\nexport async function initialize() {\n  await Tools.series(Board.boardNames(), async function(boardName) {\n    await getPageCount(boardName);\n  });\n  await ThreadsModel.clearDeletedThreads();\n}\n\nexport async function delall(req, ip, boardNames) {\n  ip = Tools.correctAddress(ip);\n  if (!ip) {\n    throw new Error(Tools.translate('Invalid IP address'));\n  }\n  let deletedThreads = {};\n  let updatedThreads = {};\n  let deletedPosts = {};\n  let Post = await client.collection('post');\n  await Tools.series(boardNames, async function(boardName) {\n    let posts = await Post.find({\n      boardName: boardName,\n      'user.ip': ip\n    }, {\n      number: 1,\n      threadNumber: 1\n    }).toArray();\n    posts.forEach((post) => {\n      if (post.threadNumber === post.number) {\n        deletedThreads[`${boardName}:${post.threadNumber}`] = {\n          boardName: boardName,\n          number: post.threadNumber\n        };\n      }\n    });\n    posts.filter(post => !deletedThreads.hasOwnProperty(`${boardName}:${post.threadNumber}`)).forEach((post) => {\n      updatedThreads[`${boardName}:${post.threadNumber}`] = {\n        boardName: boardName,\n        number: post.threadNumber\n      };\n      deletedPosts[`${boardName}:${post.number}`] = {\n        boardName: boardName,\n        number: post.number,\n        threadNumber: post.threadNumber\n      };\n    });\n  });\n  await Tools.series(deletedPosts, async function(post) {\n    await Post.deleteOne({\n      boardName: post.boardName,\n      number: post.number\n    });\n    // NOTE: What's this?!\n    //await PostsModel.removePostData(post.boardName, post.number, post.threadNumber);\n  });\n  await Tools.series(deletedThreads, async function(thread) {\n    await ThreadsModel.deleteThread(thread.boardName, thread.number);\n  });\n  await Tools.series(updatedThreads, async function(thread) {\n    await IPC.render(thread.boardName, thread.number, thread.number, 'edit');\n  });\n  await Tools.series(deletedThreads, async function(thread) {\n    await IPC.render(thread.boardName, thread.number, thread.number, 'delete');\n  });\n}\n"]}