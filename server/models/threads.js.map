{"version":3,"sources":["models/threads.js"],"names":[],"mappings":"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","file":"models/threads.js","sourcesContent":["import _ from 'underscore';\nimport FS from 'q-io/fs';\nimport promisify from 'promisify-node';\n\nimport * as BoardsModel from './boards';\nimport * as PostsModel from './posts';\nimport Board from '../boards/board';\nimport BoardController from '../controllers/board';\nimport * as Search from '../core/search';\nimport * as Cache from '../helpers/cache';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport redisClient from '../storage/redis-client-factory';\nimport sqlClient from '../storage/sql-client-factory';\nimport Hash from '../storage/hash';\nimport UnorderedSet from '../storage/unordered-set';\n\nconst mkpath = promisify('mkpath');\n\nlet ArchivedThreadPostNumbers = new UnorderedSet(sqlClient(), 'archivedThreadPostNumbers', {\n  parse: number => +number,\n  stringify: number => number.toString()\n});\nlet ArchivedThreads = new Hash(sqlClient(), 'archivedThreads');\nlet ArchivedThreadUpdateTimes = new Hash(sqlClient(), 'archivedThreadUpdateTimes', {\n  parse: false,\n  stringify: false\n});\nlet DeletedThreads = new UnorderedSet(redisClient(), 'deletedThreads', {\n  parse: false,\n  stringify: false\n});\nlet ThreadFixedFlags = new Hash(redisClient(), 'threadFixedFlags', {\n  parse: flag => !!flag,\n  stringify: flag => +(!!flag)\n});\nlet ThreadPostNumbers = new UnorderedSet(redisClient(), 'threadPostNumbers', {\n  parse: number => +number,\n  stringify: number => number.toString()\n});\nlet Threads = new Hash(redisClient(), 'threads');\nlet ThreadsPlannedForDeletion = new UnorderedSet(redisClient(), 'threadsPlannedForDeletion', {\n  parse: false,\n  stringify: false\n});\nlet ThreadUpdateTimes = new Hash(redisClient(), 'threadUpdateTimes', {\n  parse: false,\n  stringify: false\n});\n\nexport function sortThreadsByDate(t1, t2) {\n  if (!!t1.fixed === !!t2.fixed) {\n    return t2.updatedAt.localeCompare(t1.updatedAt);\n  } else {\n    return t1.fixed ? -1 : 1;\n  }\n}\n\nexport function sortThreadsByCreationDate(t1, t2) {\n  return t2.createdAt.localeCompare(t1.createdAt);\n}\n\nexport function sortThreadsByPostCount(t1, t2) {\n  return t2.postCount - t1.postCount;\n}\n\nexport async function getThreadPostCount(boardName, threadNumber, { archived } = {}) {\n  let source = archived ? ArchivedThreadPostNumbers : ThreadPostNumbers;\n  return await source.count(`${boardName}:${threadNumber}`);\n}\n\nexport async function getThreadPostNumbers(boardName, threadNumber) {\n  let postNumbers = await ThreadPostNumbers.getAll(`${boardName}:${threadNumber}`);\n  if (!postNumbers || postNumbers.length <= 0) {\n    postNumbers = await ArchivedThreadPostNumbers.getAll(`${boardName}:${threadNumber}`);\n  }\n  return postNumbers.sort((a, b) => { return a - b; });\n}\n\nexport async function addThreadPostNumber(boardName, threadNumber, postNumber, { archived } = {}) {\n  let source = archived ? ArchivedThreadPostNumbers : ThreadPostNumbers;\n  await source.addOne(postNumber, `${boardName}:${threadNumber}`);\n}\n\nexport async function removeThreadPostNumber(boardName, threadNumber, postNumber, { archived } = {}) {\n  let source = archived ? ArchivedThreadPostNumbers : ThreadPostNumbers;\n  await source.deleteOne(postNumber, `${boardName}:${threadNumber}`);\n}\n\nasync function addDataToThread(thread, { withPostNumbers } = {}) {\n  let source = thread.archived ? ArchivedThreadUpdateTimes : ThreadUpdateTimes;\n  thread.updatedAt = await source.getOne(thread.number, thread.boardName);\n  if (withPostNumbers) {\n    thread.postNumbers = await getThreadPostNumbers(thread.boardName, thread.number);\n  }\n}\n\nexport async function getThreadPosts(boardName, threadNumber,\n  { reverse, limit, notOP, withExtraData, withFileInfos, withReferences } = {}) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let postNumbers = await getThreadPostNumbers(boardName, threadNumber);\n  if (notOP) {\n    postNumbers.splice(0, 1);\n  }\n  if (reverse) {\n    postNumbers.reverse();\n  }\n  limit = Tools.option(limit, 'number', 0, { test: (l) => { return l > 0; } });\n  if (limit) {\n    postNumbers.splice(limit);\n  }\n  return await PostsModel.getPosts(boardName, postNumbers, { withExtraData, withFileInfos, withReferences });\n}\n\nexport async function getThreadNumbers(boardName, { archived } = {}) {\n  let source = archived ? ArchivedThreads : Threads;\n  return await source.keys(boardName);\n}\n\nexport async function getThread(boardName, threadNumber, options) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let thread = await Threads.getOne(threadNumber, boardName);\n  if (!thread) {\n    thread = await ArchivedThreads.getOne(threadNumber, boardName);\n  }\n  if (!thread) {\n    return Promise.reject(new Error(Tools.translate('No such thread')));\n  }\n  await addDataToThread(thread, options);\n  return thread;\n}\n\nexport async function getThreads(boardName, threadNumbers, options) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  if (!_(threadNumbers).isArray()) {\n    threadNumbers = [threadNumbers];\n  }\n  threadNumbers = threadNumbers.map((threadNumber) => {\n    return Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  });\n  if (threadNumbers.some(threadNumber => !threadNumber)) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let threads = await Threads.getSome(threadNumbers, boardName);\n  threads = _(threads).toArray();\n  let mayBeArchivedThreadNumbers = threads.map((thread, index) => {\n    return {\n      thread: thread,\n      index: index\n    };\n  }).filter((thread) => !thread.thread).map((thread) => {\n    return {\n      index: thread.index,\n      threadNumber: threadNumbers[thread.index]\n    };\n  });\n  if (mayBeArchivedThreadNumbers.length > 0) {\n    let numbers = mayBeArchivedThreadNumbers.map(thread => thread.threadNumber);\n    let archivedThreads = await ArchivedThreads.getSome(numbers, boardName);\n    archivedThreads.forEach((thread, index) => {\n      threads[mayBeArchivedThreadNumbers[index].index] = thread;\n    });\n  }\n  if (threads.length <= 0) {\n    return [];\n  }\n  await Tools.series(threads, async function(thread) {\n    await addDataToThread(thread, options);\n  });\n  return threads;\n}\n\nexport async function getThreadInfo(boardName, threadNumber, { lastPostNumber }) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let thread = await getThread(boardName, threadNumber, { withPostNumbers: true });\n  if (!thread) {\n    return thread;\n  }\n  let postCount = thread.postNumbers.length;\n  lastPostNumber = Tools.option(lastPostNumber, 'number', 0, { test: Tools.testPostNumber });\n  let newPostCount = thread.postNumbers.filter((pn) => { return pn > lastPostNumber; }).length;\n  return {\n    number: thread.number,\n    bumpLimit: board.bumpLimit,\n    postLimit: board.postLimit,\n    bumpLimitReached: (postCount >= board.bumpLimit),\n    postLimitReached: (postCount >= board.postLimit),\n    closed: thread.closed,\n    fixed: thread.fixed,\n    unbumpable: thread.unbumpable,\n    postCount: postCount,\n    postingEnabled: (board.postingEnabled && !thread.closed),\n    lastPostNumber: thread.postNumbers.pop(),\n    newPostCount: newPostCount\n  };\n}\n\nexport async function getThreadLastPostNumber(boardName, threadNumber) {\n  if (!Board.board(boardName)) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let threadPostNumbers = await getThreadPostNumbers(boardName, threadNumber);\n  return (threadPostNumbers.length > 0) ? _(threadPostNumbers).last() : 0;\n}\n\nexport async function setThreadUpdateTime(boardName, threadNumber, dateTme, { archived } = {}) {\n  let source = archived ? ArchivedThreadUpdateTimes : ThreadUpdateTimes;\n  await source.setOne(threadNumber, dateTme, boardName);\n}\n\nexport async function isThreadDeleted(boardName, threadNumber) {\n  return DeletedThreads.contains(`${boardName}:${threadNumber}`);\n}\n\nexport async function setThreadDeleted(boardName, threadNumber) {\n  return DeletedThreads.addOne(`${boardName}:${threadNumber}`);\n}\n\nexport async function clearDeletedThreads() {\n  return DeletedThreads.delete();\n}\n\nexport async function removeThread(boardName, threadNumber, { archived } = {}) {\n  let source = archived ? ArchivedThreads : Threads;\n  let key = `${boardName}:${threadNumber}`\n  await ThreadsPlannedForDeletion.addOne(key);\n  await source.deleteOne(threadNumber, boardName);\n  if (!archived) {\n    await ThreadFixedFlags.deleteOne(threadNumber, boardName);\n  }\n  let updateTimeSource = archived ? ArchivedThreadUpdateTimes : ThreadUpdateTimes;\n  await updateTimeSource.deleteOne(threadNumber, boardName);\n  setTimeout(async function() {\n    try {\n      let postNumbers = await getThreadPostNumbers(boardName, threadNumber);\n      let postNumbersSource = archived ? ArchivedThreadPostNumbers : ThreadPostNumbers;\n      await postNumbersSource.delete(key);\n      await Tools.series(postNumbers, async function(postNumber) {\n        return await PostsModel.removePost(boardName, postNumber, { removingThread: true });\n      });\n      await ThreadsPlannedForDeletion.deleteOne(key);\n    } catch (err) {\n      Logger.error(err.stack || err);\n    }\n  }, 5000); //TODO: This is not OK\n}\n\nasync function pushOutOldThread(boardName) {\n  try {\n    let board = Board.board(boardName);\n    if (!board) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    let threadNumbers = await getThreadNumbers(boardName);\n    let threads = await getThreads(boardName, threadNumbers);\n    threads.sort(sortThreadsByDate);\n    if (threads.length < board.threadLimit) {\n      return;\n    }\n    let client = await sqlClient();\n    await client.transaction();\n    let archivedThreadNumbers = await getThreadNumbers(boardName, { archived: true });\n    let archivedThreads = await getThreads(boardName, archivedThreadNumbers);\n    archivedThreads.sort(sortThreadsByDate);\n    let removeLastArchivedThread = (archivedThreads.length > 0) && (archivedThreads.length >= board.archiveLimit);\n    if (removeLastArchivedThread) {\n      await removeThread(boardName, archivedThreads.pop().number, { archived: true });\n    }\n    let thread = threads.pop();\n    if (board.archiveLimit <= 0) {\n      await removeThread(boardName, thread.number);\n      await client.commit();\n      if (removeLastArchivedThread) {\n        await IPC.renderArchive(boardName);\n      }\n      return;\n    }\n    await Threads.deleteOne(thread.number, boardName);\n    await ThreadFixedFlags.deleteOne(thread.number, boardName);\n    (async function() {\n      try {\n        ArchivedThreadUpdateTimes.setOne(thread.number, thread.updatedAt, boardName);\n        ThreadUpdateTimes.deleteOne(thread.number, boardName);\n        thread.archived = true;\n        delete thread.updatedAt;\n        await ArchivedThreads.setOne(thread.number, thread, boardName);\n        let key = `${boardName}:${thread.number}`;\n        let postNumbers = await getThreadPostNumbers(boardName, thread.number);\n        await ArchivedThreadPostNumbers.addSome(postNumbers, key);\n        await ThreadPostNumbers.delete(key);\n        await Tools.series(postNumbers, async function(postNumber) {\n          await PostsModel.pushPostToArchive(boardName, postNumber);\n        });\n        await client.commit();\n        let archivePath = `${__dirname}/../../public/${boardName}/arch`;\n        let oldThreadNumber = thread.number;\n        await mkpath(archivePath);\n        let sourceId = `${boardName}/res/${oldThreadNumber}.json`;\n        let data = await Cache.readFile(sourceId);\n        let model = JSON.parse(data);\n        model.thread.archived = true;\n        await FS.write(`${archivePath}/${oldThreadNumber}.json`, JSON.stringify(model));\n        await BoardController.renderThreadHTML(model.thread, {\n          targetPath: `${archivePath}/${oldThreadNumber}.html`,\n          archived: true\n        });\n        await Cache.removeFile(sourceId);\n        await Cache.removeFile(`${boardName}/res/${oldThreadNumber}.html`);\n        await IPC.renderArchive(boardName);\n      } catch (err) {\n        client.rollback();\n        Logger.error(err.stack || err);\n      }\n    })();\n    //NOTE: This is for the sake of speed.\n  } catch (err) {\n    client.rollback();\n    Logger.error(err.stack || err);\n  }\n}\n\nexport async function createThread(req, fields, transaction) {\n  let { boardName, password } = fields;\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  if (!board.postingEnabled) {\n    return Promise.reject(new Error(Tools.translate('Posting is disabled at this board')));\n  }\n  await pushOutOldThread(boardName);\n  let date = Tools.now();\n  password = Tools.sha1(password);\n  let hashpass = (req.hashpass || null);\n  let threadNumber = await BoardsModel.nextPostNumber(boardName);\n  let thread = {\n    archived: false,\n    boardName: boardName,\n    closed: false,\n    createdAt: date.toISOString(),\n    unbumpable: false,\n    number: threadNumber,\n    user: {\n      hashpass: hashpass,\n      ip: req.ip,\n      level: req.level(boardName),\n      password: password\n    }\n  };\n  transaction.setThreadNumber(threadNumber);\n  await Threads.setOne(threadNumber, thread, boardName);\n  return thread;\n}\n\nexport async function moveThread(sourceBoardName, threadNumber, targetBoardName) {\n  let targetBoard = Board.board(targetBoardName);\n  if (!targetBoard || !Board.board(sourceBoardName)) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    throw new Error(Tools.translate('Invalid thread number'));\n  }\n  let thread = await getThread(sourceBoardName, threadNumber, { withPostNumbers: true });\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  let postNumbers = thread.postNumbers;\n  let fixed = thread.fixed;\n  delete thread.postNumbers;\n  delete thread.updatedAt;\n  delete thread.fixed;\n  thread.boardName = targetBoardName;\n  let lastPostNumber = await BoardsModel.nextPostNumber(targetBoardName, postNumbers.length);\n  let initialPostNumber = lastPostNumber - postNumbers.length + 1;\n  thread.number = initialPostNumber;\n  let { toRerender, toUpdate, postNumberMap } = await PostsModel.copyPosts({\n    sourceBoardName: sourceBoardName,\n    postNumbers: postNumbers,\n    targetBoardName: targetBoardName,\n    initialPostNumber: initialPostNumber\n  });\n  await ThreadPostNumbers.addSome(_(postNumberMap).toArray(), `${targetBoardName}:${thread.number}`);\n  await ThreadUpdateTimes.setOne(thread.number, Tools.now().toISOString(), targetBoardName);\n  await Threads.setOne(thread.number, thread, targetBoardName);\n  await ThreadFixedFlags.setOne(thread.number, fixed, targetBoardName);\n  await IPC.render(targetBoardName, thread.number, thread.number, 'create');\n  toRerender = toRerender.reduce((acc, ref) => {\n    acc[`${ref.boardName}:${ref.postNumber}`] = ref;\n    return acc;\n  }, {});\n  toUpdate = toUpdate.reduce((acc, ref) => {\n    acc[`${ref.boardName}:${ref.threadNumber}`] = ref;\n    return acc;\n  }, {});\n  await PostsModel.rerenderMovedThreadRelatedPosts({\n    posts: toRerender,\n    sourceBoardName: sourceBoardName,\n    targetBoardName: targetBoardName,\n    postNumberMap: postNumberMap\n  });\n  await PostsModel.updateMovedThreadRelatedPosts({\n    posts: toUpdate,\n    sourceBoardName: sourceBoardName,\n    targetBoardName: targetBoardName,\n    sourceThreadNumber: threadNumber,\n    targetThreadNumber: initialPostNumber,\n    postNumberMap: postNumberMap\n  });\n  await Tools.series(toRerender, async function(ref) {\n    return await IPC.render(ref.boardName, ref.threadNumber, ref.postNumber, 'edit');\n  });\n  await Tools.series(toUpdate, async function(ref) {\n    return await IPC.render(ref.boardName, ref.threadNumber, ref.threadNumber, 'create');\n  });\n  await removeThread(sourceBoardName, threadNumber);\n  await IPC.render(sourceBoardName, threadNumber, threadNumber, 'delete');\n  return {\n    boardName: targetBoardName,\n    threadNumber: thread.number\n  };\n}\n\nexport async function setThreadFixed(boardName, threadNumber, fixed) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  fixed = !!fixed;\n  if (fixed === !!thread.fixed) {\n    return;\n  }\n  await ThreadFixedFlags.setOne(threadNumber, fixed, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n\nexport async function setThreadClosed(boardName, threadNumber, closed) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  closed = !!closed;\n  if (closed === !!thread.closed) {\n    return;\n  }\n  delete thread.fixed;\n  thread.closed = closed;\n  await Threads.setOne(threadNumber, thread, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n\nexport async function setThreadUnbumpable(boardName, threadNumber, unbumpable) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  unbumpable = !!unbumpable;\n  if (unbumpable === !!thread.unbumpable) {\n    return;\n  }\n  thread.unbumpable = unbumpable;\n  await Threads.setOne(threadNumber, thread, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n"],"sourceRoot":"/source/"}