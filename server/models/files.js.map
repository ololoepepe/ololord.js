{"version":3,"sources":["models/files.js"],"names":["name","client","collection","Post","findOne","post","Error","Tools","translate","fileInfos","getFileInfoByName","hash","getFileInfoByHash","count","fileInfoExistsByName","fileInfoExistsByHash","hashes","isArray","length","find","$in","toArray","posts","fileInfosAll","map","fileInfo","getFileInfosByHashes","boardName","postNumber","files","findOneAndUpdate","number","$push","$each","createFileInfos","projection","threadNumber","returnOriginal","result","value","IPC","render","addFilesToPost","thumb","path","__dirname","remove","error","stack","removeFile","series","removeFiles","fileName","$pull","deleteFile","rating","FILE_RATINGS","indexOf","$set","editFileRating","fields","extraData","tagName","filter","reduce","acc","editAudioTags","fileInfoCount","getPostFileCount","sourceBoardName","targetBoardName","transaction","sourcePath","sourceThumbPath","targetPath","targetThumbPath","mkpath","oldFileName","oldThumbName","send","baseName","replace","newFilePath","newThumbPath","addFile","copy","copyFiles","createFileInfo","file"],"mappings":"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","file":"files.js","sourcesContent":["import _ from 'underscore';\nimport FS from 'q-io/fs';\nimport promisify from 'promisify-node';\n\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport mongodbClient from '../storage/mongodb-client-factory';\nimport { AUDIO_TAGS } from '../file-types/audio';\n\nconst mkpath = promisify('mkpath');\n\nlet client = mongodbClient();\n\nexport async function getFileInfoByName(name) {\n  let Post = await client.collection('post');\n  let post = await Post.findOne({ 'fileInfos.name': name }, { 'fileInfos.$': 1 });\n  if (!post) {\n    throw new Error(Tools.translate('No such file'));\n  }\n  return post.fileInfos[0];\n}\n\nexport async function getFileInfoByHash(hash) {\n  let Post = await client.collection('post');\n  let post = await Post.findOne({ 'fileInfos.hash': hash }, { 'fileInfos.$': 1 });\n  if (!post) {\n    throw new Error(Tools.translate('No such file'));\n  }\n  return post.fileInfos[0];\n}\n\nexport async function fileInfoExistsByName(name) {\n  let Post = await client.collection('post');\n  let count = await Post.count({ 'fileInfos.name': name });\n  return (count > 0);\n}\n\nexport async function fileInfoExistsByHash(hash) {\n  let Post = await client.collection('post');\n  let count = await Post.count({ 'fileInfos.hash': hash });\n  return (count > 0);\n}\n\nexport async function getFileInfosByHashes(hashes) {\n  if (!hashes) {\n    return [];\n  }\n  if (!_(hashes).isArray()) {\n    hashes = [hashes];\n  }\n  if (hashes.length <= 0) {\n    return [];\n  }\n  let Post = await client.collection('post');\n  let posts = await Post.find({\n    'fileInfos.hash': { $in: hashes }\n  }, { 'fileInfos.$': 1 }).toArray();\n  let fileInfosAll = _(posts.map(({ fileInfos }) => fileInfos[0]));\n  let fileInfos = [];\n  return hashes.map((hash) => {\n    let fileInfo = fileInfosAll.find((fileInfo) => {\n      return hash === fileInfo.hash;\n    });\n    if (!fileInfo) {\n      throw new Error(Tools.translate('No such file'));\n    }\n    return fileInfo;\n  });\n}\n\nfunction createFileInfo(file, boardName, postNumber) {\n  file.boardName = boardName;\n  file.postNumber = postNumber;\n  return file;\n}\n\nexport function createFileInfos(files, boardName, postNumber) {\n  return files.map((file) => { return createFileInfo(file, boardName, postNumber); });\n}\n\nexport async function addFilesToPost(boardName, postNumber, files) {\n  let Post = await client.collection('post');\n  let result = await Post.findOneAndUpdate({\n    boardName: boardName,\n    number: postNumber\n  }, {\n    $push: {\n      fileInfos: { $each: createFileInfos(files, boardName, postNumber) }\n    }\n  }, {\n    projection: { threadNumber: 1 },\n    returnOriginal: false\n  });\n  let post = result.value;\n  if (!post) {\n    throw new Error(Tools.translate('No such post'));\n  }\n  await IPC.render(boardName, post.threadNumber, postNumber, 'edit');\n}\n\nasync function removeFile({ boardName, name, thumb }) {\n  let path = `${__dirname}/../../public/${boardName}`;\n  try {\n    await FS.remove(`${path}/src/${name}`);\n  } catch (err) {\n    Logger.error(err.stack || err);\n  }\n  try {\n    await FS.remove(`${path}/thumb/${thumb.name}`);\n  } catch (err) {\n    Logger.error(err.stack || err);\n  }\n}\n\nexport async function removeFiles(fileInfos) {\n  await Tools.series(fileInfos, removeFile);\n}\n\nexport async function deleteFile(fileName) {\n  let Post = await client.collection('post');\n  let result = await Post.findOneAndUpdate({ 'fileInfos.name': fileName }, {\n    $pull: {\n      fileInfos: { name: fileName }\n    }\n  }, {\n    projection: {\n      boardName: 1,\n      number: 1,\n      threadNumber: 1,\n      'fileInfos.$': 1\n    },\n    returnOriginal: true\n  });\n  let post = result.value;\n  if (!post) {\n    throw new Error(Tools.translate('No such file'));\n  }\n  await IPC.render(post.boardName, post.threadNumber, post.number, 'edit');\n  removeFile(post.fileInfos[0]);\n}\n\nexport async function editFileRating(fileName, rating) {\n  let Post = await client.collection('post');\n  if (Tools.FILE_RATINGS.indexOf(rating) < 0) {\n    rating = Tools.FILE_RATINGS[0];\n  }\n  let result = await Post.findOneAndUpdate({ 'fileInfos.name': fileName }, {\n    $set: { 'fileInfos.$.rating': rating }\n  }, {\n    projection: {\n      boardName: 1,\n      number: 1,\n      threadNumber: 1\n    },\n    returnOriginal: false\n  });\n  let post = result.value;\n  if (!post) {\n    throw new Error(Tools.translate('No such file'));\n  }\n  await IPC.render(post.boardName, post.threadNumber, post.number, 'edit');\n}\n\nexport async function editAudioTags(fileName, fields) {\n  let Post = await client.collection('post');\n  let extraData = AUDIO_TAGS.map((tagName) => {\n    return {\n      tagName: tagName,\n      value: fields[tagName]\n    };\n  }).filter(({ value }) => {\n    return (value && (typeof value === 'string'));\n  }).reduce((acc, { tagName, value }) => {\n    acc[tagName] = value;\n    return acc;\n  }, {});\n  let result = await Post.findOneAndUpdate({ 'fileInfos.name': fileName }, {\n    $set: { 'fileInfos.$.extraData': extraData }\n  }, {\n    projection: {\n      boardName: 1,\n      number: 1,\n      threadNumber: 1\n    },\n    returnOriginal: false\n  });\n  let post = result.value;\n  if (!post) {\n    throw new Error(Tools.translate('No such file'));\n  }\n  await IPC.render(post.boardName, post.threadNumber, post.number, 'edit');\n}\n\nexport async function getPostFileCount(boardName, postNumber) {\n  let Post = await client.collection('post');\n  let post = await Post.findOne({\n    boardName: boardName,\n    number: postNumber\n  }, { fileInfoCount: 1 });\n  if (!post) {\n    throw new Error(Tools.translate('No such post'));\n  }\n  return post.fileInfoCount;\n}\n\nexport async function copyFiles(fileInfos, sourceBoardName, targetBoardName, transaction) {\n  let sourcePath = `${__dirname}/../../public/${sourceBoardName}/src`;\n  let sourceThumbPath = `${__dirname}/../../public/${sourceBoardName}/thumb`;\n  let targetPath = `${__dirname}/../../public/${targetBoardName}/src`;\n  let targetThumbPath = `${__dirname}/../../public/${targetBoardName}/thumb`;\n  await mkpath(targetPath);\n  await mkpath(targetThumbPath);\n  return await Tools.series(fileInfos, async function(fileInfo) {\n    let oldFileName = fileInfo.name;\n    let oldThumbName = fileInfo.thumb.name;\n    let baseName = await IPC.send('fileName');\n    fileInfo.name = fileInfo.name.replace(/^\\d+/, baseName);\n    fileInfo.thumb.name = fileInfo.thumb.name.replace(/^\\d+/, baseName);\n    let newFilePath = `${targetPath}/${fileInfo.name}`;\n    let newThumbPath = `${targetThumbPath}/${fileInfo.thumb.name}`;\n    transaction.addFile(newFilePath);\n    await FS.copy(`${sourcePath}/${oldFileName}`, newFilePath);\n    transaction.addFile(newThumbPath);\n    await FS.copy(`${sourceThumbPath}/${oldThumbName}`, newThumbPath);\n    return fileInfo;\n  }, true);\n}\n"]}