{"version":3,"sources":["middlewares/ip-fix.js"],"names":[],"mappings":";;;;;;kBAKe,UAAS,GAAT,EAAc,GAAd,EAAmB,IAAnB,EAAyB;AACtC,MAAI,SAAS,MAAM,cAAN,CAAqB,IAAI,EAAJ,IAAU,IAAI,UAAJ,CAAe,aAA9C,CAAb;AACA,MAAI,CAAC,MAAL,EAAa;AACX,WAAO,IAAI,UAAJ,CAAe,GAAf,CAAP;AACD;AACD,MAAI,sBAAO,qBAAP,CAAJ,EAAmC;AACjC,QAAI,KAAK,IAAI,OAAJ,CAAY,iBAAZ,CAAT;AACA,QAAI,CAAC,EAAL,EAAS;AACP,WAAK,IAAI,OAAJ,CAAY,aAAZ,CAAL;AACD;AACD,QAAI,EAAJ,EAAQ;AACN,UAAI,UAAU,MAAM,cAAN,CAAqB,EAArB,CAAd;AACA,UAAI,CAAC,OAAL,EAAc;AACZ,eAAO,IAAI,UAAJ,CAAe,GAAf,CAAP;AACD;AACD,eAAS,OAAT;AACD;AACF;AACD,MAAI,sBAAO,mBAAP,EAA4B,KAA5B,CAAJ,EAAwC;AACtC,QAAI,MAAK,IAAI,OAAJ,CAAY,WAAZ,CAAT;AACA,QAAI,WAAU,MAAM,cAAN,CAAqB,GAArB,CAAd;AACA,QAAI,CAAC,QAAL,EAAc;AACZ,aAAO,IAAI,UAAJ,CAAe,GAAf,CAAP;AACD;AACD,aAAS,QAAT;AACD;AACD,SAAO,cAAP,CAAsB,GAAtB,EAA2B,IAA3B,EAAiC,EAAE,OAAO,MAAT,EAAjC;AACA;AACD,C;;AAjCD;;AAEA;;;;AACA;;IAAY,K","file":"middlewares/ip-fix.js","sourcesContent":["import { Address4, Address6 } from 'ip-address';\n\nimport config from '../helpers/config';\nimport * as Tools from '../helpers/tools';\n\nexport default function(req, res, next) {\n  let trueIp = Tools.correctAddress(req.ip || req.connection.remoteAddress);\n  if (!trueIp) {\n    return res.sendStatus(500);\n  }\n  if (config('system.detectRealIp')) {\n    let ip = req.headers['x-forwarded-for'];\n    if (!ip) {\n      ip = req.headers['x-client-ip'];\n    }\n    if (ip) {\n      let address = Tools.correctAddress(ip);\n      if (!address) {\n        return res.sendStatus(500);\n      }\n      trueIp = address;\n    }\n  }\n  if (config('system.useXRealIp', false)) {\n    let ip = req.headers['x-real-ip'];\n    let address = Tools.correctAddress(ip);\n    if (!address) {\n      return res.sendStatus(500);\n    }\n    trueIp = address;\n  }\n  Object.defineProperty(req, 'ip', { value: trueIp });\n  next();\n}\n"],"sourceRoot":"/source/"}