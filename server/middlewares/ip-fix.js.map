{"version":3,"sources":["middlewares/ip-fix.js"],"names":["req","res","next","trueIp","Tools","correctAddress","ip","connection","remoteAddress","sendStatus","headers","address","Object","defineProperty","value"],"mappings":";;;;;;kBAKe,UAASA,GAAT,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AACtC,MAAIC,SAASC,MAAMC,cAAN,CAAqBL,IAAIM,EAAJ,IAAUN,IAAIO,UAAJ,CAAeC,aAA9C,CAAb;AACA,MAAI,CAACL,MAAL,EAAa;AACX,WAAOF,IAAIQ,UAAJ,CAAe,GAAf,CAAP;AACD;AACD,MAAI,sBAAO,qBAAP,CAAJ,EAAmC;AACjC,QAAIH,KAAKN,IAAIU,OAAJ,CAAY,iBAAZ,CAAT;AACA,QAAI,CAACJ,EAAL,EAAS;AACPA,WAAKN,IAAIU,OAAJ,CAAY,aAAZ,CAAL;AACD;AACD,QAAIJ,EAAJ,EAAQ;AACN,UAAIK,UAAUP,MAAMC,cAAN,CAAqBC,EAArB,CAAd;AACA,UAAI,CAACK,OAAL,EAAc;AACZ,eAAOV,IAAIQ,UAAJ,CAAe,GAAf,CAAP;AACD;AACDN,eAASQ,OAAT;AACD;AACF;AACD,MAAI,sBAAO,mBAAP,EAA4B,KAA5B,CAAJ,EAAwC;AACtC,QAAIL,MAAKN,IAAIU,OAAJ,CAAY,WAAZ,CAAT;AACA,QAAIC,WAAUP,MAAMC,cAAN,CAAqBC,GAArB,CAAd;AACA,QAAI,CAACK,QAAL,EAAc;AACZ,aAAOV,IAAIQ,UAAJ,CAAe,GAAf,CAAP;AACD;AACDN,aAASQ,QAAT;AACD;AACDC,SAAOC,cAAP,CAAsBb,GAAtB,EAA2B,IAA3B,EAAiC,EAAEc,OAAOX,MAAT,EAAjC;AACAD;AACD,C;;AAjCD;;AAEA;;;;AACA;;IAAYE,K","file":"ip-fix.js","sourcesContent":["import { Address4, Address6 } from 'ip-address';\n\nimport config from '../helpers/config';\nimport * as Tools from '../helpers/tools';\n\nexport default function(req, res, next) {\n  let trueIp = Tools.correctAddress(req.ip || req.connection.remoteAddress);\n  if (!trueIp) {\n    return res.sendStatus(500);\n  }\n  if (config('system.detectRealIp')) {\n    let ip = req.headers['x-forwarded-for'];\n    if (!ip) {\n      ip = req.headers['x-client-ip'];\n    }\n    if (ip) {\n      let address = Tools.correctAddress(ip);\n      if (!address) {\n        return res.sendStatus(500);\n      }\n      trueIp = address;\n    }\n  }\n  if (config('system.useXRealIp', false)) {\n    let ip = req.headers['x-real-ip'];\n    let address = Tools.correctAddress(ip);\n    if (!address) {\n      return res.sendStatus(500);\n    }\n    trueIp = address;\n  }\n  Object.defineProperty(req, 'ip', { value: trueIp });\n  next();\n}\n"]}