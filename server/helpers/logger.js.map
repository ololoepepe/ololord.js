{"version":3,"sources":["helpers/logger.js"],"names":["IPC","CODE","WinstonClusterTransport","options","name","level","msg","meta","callback","silent","stripColors","replace","message","cmd","worker","id","pid","process","send","console","error","stack","emit","data","Transport","transports","Cluster","MAIN_FILE_NAME","basename","require","main","filename","TRANSPORT_MAP","ctor","Console","opts","timestamp","colorize","__dirname","maxsize","maxFiles","map","filter","transport","length","toArray","Logger","isMaster","handleMessage","initialize","serverType","on","server","log"],"mappings":"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","file":"logger.js","sourcesContent":["import _ from 'underscore';\nimport Cluster from 'cluster';\nimport Path from 'path';\nimport Winston from 'winston';\nimport WinstonDailyRotateFileTransport from 'winston-daily-rotate-file';\n\nimport config from './config';\nimport * as IPC from './ipc';\n\nconst CODE = /\\u001b\\[(\\d+(;\\d+)*)?m/g;\n\nclass WinstonClusterTransport extends Winston.Transport {\n  constructor(options = {}) {\n    super(options);\n    this.name = 'cluster';\n  }\n\n  async log(level, msg, meta, callback) {\n    if (this.silent) {\n      return callback(null, true);\n    }\n    if (this.stripColors) {\n      msg = ('' + msg).replace(CODE, '');\n    }\n    let message = {\n      cmd: 'log',\n      worker: Cluster.worker.id || null,\n      pid: process.pid,\n      level: level,\n      msg: msg,\n      meta: meta\n    };\n    try {\n      await IPC.send('log', message);\n    } catch (err) {\n      console.error(err.stack || err);\n      return callback(err);\n    }\n    this.emit('logged');\n    callback(null, true);\n    return message;\n  }\n\n  _write(data, callback) { }\n\n  query(options, callback) { }\n\n  stream(options) { }\n\n  open(callback) {\n    callback();\n  }\n\n  close() { }\n\n  flush() { }\n}\n\nWinston.transports.Cluster = WinstonClusterTransport;\n\nconst MAIN_FILE_NAME = Path.basename(require.main.filename, '.js');\nconst TRANSPORT_MAP = {\n  'console': {\n    ctor: Winston.transports.Console,\n    opts: {\n      timestamp: true,\n      colorize: true\n    }\n  },\n  'file': {\n    ctor: WinstonDailyRotateFileTransport,\n    opts: {\n      filename: `${__dirname}/../../logs/${MAIN_FILE_NAME}/${MAIN_FILE_NAME}.log`,\n      maxsize: config('system.log.maxSize'),\n      maxFiles: config('system.log.maxFiles')\n    }\n  }\n};\n\nlet transports = config('system.log.transports').map((name) => {\n  return TRANSPORT_MAP[name];\n}).filter(transport => !!transport);\n\nif (transports.length <= 0) {\n  transports = _(TRANSPORT_MAP).toArray();\n}\n\nlet Logger;\n\nif (Cluster.isMaster) {\n  Logger = new Winston.Logger({ transports: transports.map(({ ctor, opts }) => new ctor(opts)) });\n} else {\n  Logger = new Winston.Logger({ transports: [new WinstonClusterTransport()] });\n}\n\nfunction handleMessage(msg) {\n\n}\n\nLogger.initialize = (serverType) => {\n  if (Cluster.isMaster) {\n    IPC.on('log', (msg) => {\n      msg.meta.server = serverType;\n      msg.meta.pid = msg.pid;\n      msg.meta.worker = msg.worker;\n      Logger.log(msg.level, msg.msg, msg.meta);\n    });\n  }\n}\n\nexport default Logger;\n"]}