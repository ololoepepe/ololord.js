{"version":3,"sources":["helpers/config.js"],"names":[],"mappings":"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","file":"helpers/config.js","sourcesContent":["import _ from 'underscore';\nimport FSSync from 'fs';\nimport OS from 'os';\nimport Path from 'path';\n\nimport Program from './program';\nimport FSWatcher from './fs-watcher';\n\nconst DEFAULT_CONFIG_FILE_NAME_1 = `${__dirname}/../../config.json`;\nconst DEFAULT_CONFIG_FILE_NAME_2 = `${__dirname}/../../config.js`;\nconst DEFAULT_DDOS_PROTECTION_RULES = [{\n  string: '/misc/base.json',\n  maxWeight: 6,\n  queueSize: 4\n}, {\n  string: '/api/chatMessages.json',\n  maxWeight: 4,\n  queueSize: 2\n}, {\n  string: '/api/lastPostNumbers.json',\n  maxWeight: 4,\n  queueSize: 2\n}, {\n  string: '/api/captchaQuota.json',\n  maxWeight: 4,\n  queueSize: 2\n}, {\n  string: '/api/lastPostNumber.json',\n  maxWeight: 4,\n  queueSize: 2\n}, {\n  regexp: '^/api.*',\n  maxWeight: 6,\n  queueSize: 4\n}, {\n  string: '/action/search',\n  maxWeight: 1\n}, {\n  regexp: '.*',\n  maxWeight: 10\n}];\nconst DEFAULT_VALUES = new Map([\n  ['board.useDefaultBoards', true],\n  ['server.chat.ttl', 10080], //NOTE: 7 days\n  ['server.ddosProtection.checkInterval', 1000], //NOTE: 1 second\n  ['server.ddosProtection.enabled', true],\n  ['server.ddosProtection.errorCode', 429],\n  ['server.ddosProtection.errorData', 'Not so fast!'],\n  ['server.ddosProtection.maxWeight', 10],\n  ['server.ddosProtection.rules', DEFAULT_DDOS_PROTECTION_RULES],\n  ['server.ddosProtection.static', false],\n  ['server.ddosProtection.weight', 1],\n  ['server.ddosProtection.ws.connectionLimit', 10],\n  ['server.ddosProtection.ws.maxMessageLength', 20480], //NOTE: 20 KB\n  ['server.ddosProtection.ws.maxMessageRate', 6],\n  ['server.port', 8080],\n  ['server.rss.enabled', true],\n  ['server.rss.postCount', 500],\n  ['server.rss.ttl', 60], //NOTE: 1 hour\n  ['server.statistics.enabled', true],\n  ['server.statistics.ttl', 60], //NOTE: 1 hour\n  ['server.synchronizationData.ttl', 300], //NOTE: 5 minutes\n  ['server.youtubeApiKey', ''],\n  ['site.protocol', 'http'],\n  ['site.domain', 'localhost:8080'],\n  ['site.pathPrefix', ''],\n  ['site.locale', 'en'],\n  ['site.dateFormat', 'MM/DD/YYYY hh:mm:ss'],\n  ['site.timeOffset', 0],\n  ['site.tripcodeSalt', ''],\n  ['site.vkontakte.accessToken', ''],\n  ['site.vkontakte.appId', ''],\n  ['site.vkontakte.integrationEnabled', false],\n  ['site.twitter.integrationEnabled', true],\n  ['site.ws.transports', ''],\n  ['site.maxSearchQueryLength', 50],\n  ['system.detectRealIp', true],\n  ['system.elasticsearch.host', 'localhost:9200'],\n  ['system.httpRequestTimeout', 60 * 1000], //NOTE: 1 minute\n  ['system.log.maxFiles', 100],\n  ['system.log.maxSize', 104857600], //NOTE: 100 MB\n  ['system.log.middleware.before', 'all'],\n  ['system.log.middleware.verbosity', 'ip'],\n  ['system.log.transports', ['console', 'file']],\n  ['system.maxFormFieldsSize', 5 * 1024 * 1024], //NOTE: 5 MB\n  ['system.mimeTypeRetrievingTimeout', 5 * 1000], //NOTE: 5 seconds\n  ['system.mongodb.uri_decode_auth', false],\n  ['system.mongodb.url', 'mongodb://127.0.0.1:27017/ololordjs'],\n  ['system.onlineCounter.interval', 60 * 1000], //NOTE: 1 minute\n  ['system.onlineCounter.quota', 5 * 60 * 1000], //NOTE: 5 minutes\n  ['system.phash.enabled', true],\n  ['system.redis.host', '127.0.0.1'],\n  ['system.redis.port', 6379],\n  ['system.redis.family', 4],\n  ['system.redis.password', ''],\n  ['system.redis.db', 0],\n  ['system.redis.enableReadyCheck', false],\n  ['system.redis.maxRedirections', 16],\n  ['system.redis.scaleReads', 'master'],\n  ['system.redis.retryDelayOnFailover', 100],\n  ['system.redis.retryDelayOnClusterDown', 100],\n  ['system.redis.retryDelayOnTryAgain', 100],\n  ['system.rendererWorkerCount', OS.cpus().length],\n  ['system.rerenderCacheOnStartup', true],\n  ['system.rerenderArchive', false],\n  ['system.search.maxResultCount', 100],\n  ['system.search.maxResultPostSubjectLengh', 100],\n  ['system.search.maxResultPostTextLengh', 300],\n  ['system.tmpPath', `${__dirname}/../../tmp`],\n  ['system.useXRealIp', false],\n  ['system.workerCount', OS.cpus().length]\n]);\n\nlet configFileName = Program.configFile;\nif (configFileName) {\n  configFileName = Path.resolve(`${__dirname}/../..${configFileName}`);\n} else {\n  if (FSSync.existsSync(DEFAULT_CONFIG_FILE_NAME_1)) {\n    configFileName = Path.resolve(DEFAULT_CONFIG_FILE_NAME_1);\n  } else if (FSSync.existsSync(DEFAULT_CONFIG_FILE_NAME_2)) {\n    configFileName = Path.resolve(DEFAULT_CONFIG_FILE_NAME_2);\n  }\n}\n\nlet config = {};\nlet hooks = {};\n\nif (configFileName && FSSync.existsSync(configFileName)) {\n  console.log(`[${process.pid}] Using config file: \"${configFileName}\"…`);\n  config = FSWatcher.createWatchedResource(configFileName, (path) => {\n    return require(path);\n  }, async function(path) {\n    let oldConfig = config;\n    let id = require.resolve(path);\n    if (require.cache.hasOwnProperty(id)) {\n      delete require.cache[id];\n    }\n    let keys = _(oldConfig).reduce((acc, _1, key) => {\n      acc[key] = true;\n      return acc;\n    }, {});\n    _(config).each((_1, key) => { keys[key] = true; });\n    keys = _(keys).pick((_1, key) => { return hooks.hasOwnProperty(key); });\n    oldConfig = _(keys).reduce((acc, _1, key) => {\n      acc[key] = c(key);\n      return acc;\n    }, {});\n    config = require(id);\n    _(keys).each((_1, key) => {\n      hooks[key].forEach((hook) => {\n        hook(c[key], oldConfig[key], key);\n      });\n    });\n  }) || {};\n} else {\n  console.log(`[${process.pid}] Using default (empty) config…`);\n}\n\nfunction c(key, def) {\n  if (typeof def === 'undefined') {\n    def = DEFAULT_VALUES.get(key);\n  }\n  let parts = key.split('.');\n  let o = config;\n  while (parts.length > 0) {\n    if (typeof o !== 'object') {\n      return def;\n    }\n    o = o[parts.shift()];\n  }\n  return (typeof o !== 'undefined') ? o : def;\n}\n\nc.on = function(key, hook) {\n  if (typeof hook !== 'function') {\n    return this;\n  }\n  let list = hooks[key];\n  if (!list) {\n    list = [];\n    hooks[key] = list;\n  }\n  list.push(hook);\n  return this;\n};\n\nc.proxy = function() {\n  let proxy = c('system.fileDownloadProxy');\n  if (!proxy) {\n    return null;\n  }\n  let parts = proxy.split(':');\n  let auth = c('system.fileDownloadProxyAuth');\n  return {\n    host: parts[0],\n    port: (parts[1] ? +parts[1] : null),\n    auth: (auth ? `Basic ${new Buffer(auth).toString('base64')}` : null)\n  };\n}\n\nexport default c;\n"],"sourceRoot":"/source/"}