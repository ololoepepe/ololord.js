{"version":3,"sources":["helpers/config.js"],"names":["DEFAULT_CONFIG_FILE_NAME_1","__dirname","DEFAULT_CONFIG_FILE_NAME_2","DEFAULT_DDOS_PROTECTION_RULES","string","maxWeight","queueSize","regexp","DEFAULT_VALUES","Map","cpus","length","configFileName","configFile","resolve","existsSync","config","hooks","console","log","process","pid","createWatchedResource","path","require","oldConfig","id","cache","hasOwnProperty","keys","reduce","acc","_1","key","each","pick","c","forEach","hook","def","get","parts","split","o","shift","on","list","push","proxy","auth","host","port","Buffer","toString"],"mappings":"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","file":"config.js","sourcesContent":["import _ from 'underscore';\nimport FSSync from 'fs';\nimport OS from 'os';\nimport Path from 'path';\n\nimport Program from './program';\nimport FSWatcher from './fs-watcher';\n\nconst DEFAULT_CONFIG_FILE_NAME_1 = `${__dirname}/../../config.json`;\nconst DEFAULT_CONFIG_FILE_NAME_2 = `${__dirname}/../../config.js`;\nconst DEFAULT_DDOS_PROTECTION_RULES = [{\n  string: '/misc/base.json',\n  maxWeight: 6,\n  queueSize: 4\n}, {\n  string: '/api/chatMessages.json',\n  maxWeight: 4,\n  queueSize: 2\n}, {\n  string: '/api/lastPostNumbers.json',\n  maxWeight: 4,\n  queueSize: 2\n}, {\n  string: '/api/captchaQuota.json',\n  maxWeight: 4,\n  queueSize: 2\n}, {\n  string: '/api/lastPostNumber.json',\n  maxWeight: 4,\n  queueSize: 2\n}, {\n  regexp: '^/api.*',\n  maxWeight: 6,\n  queueSize: 4\n}, {\n  string: '/action/search',\n  maxWeight: 1\n}, {\n  regexp: '.*',\n  maxWeight: 10\n}];\nconst DEFAULT_VALUES = new Map([\n  ['board.useDefaultBoards', true],\n  ['server.chat.ttl', 10080], //NOTE: 7 days\n  ['server.ddosProtection.checkInterval', 1000], //NOTE: 1 second\n  ['server.ddosProtection.enabled', true],\n  ['server.ddosProtection.errorCode', 429],\n  ['server.ddosProtection.errorData', 'Not so fast!'],\n  ['server.ddosProtection.maxWeight', 10],\n  ['server.ddosProtection.rules', DEFAULT_DDOS_PROTECTION_RULES],\n  ['server.ddosProtection.static', false],\n  ['server.ddosProtection.weight', 1],\n  ['server.ddosProtection.ws.connectionLimit', 10],\n  ['server.ddosProtection.ws.maxMessageLength', 20480], //NOTE: 20 KB\n  ['server.ddosProtection.ws.maxMessageRate', 6],\n  ['server.port', 8080],\n  ['server.rss.enabled', true],\n  ['server.rss.postCount', 500],\n  ['server.rss.ttl', 60], //NOTE: 1 hour\n  ['server.statistics.enabled', true],\n  ['server.statistics.ttl', 60], //NOTE: 1 hour\n  ['server.synchronizationData.ttl', 300], //NOTE: 5 minutes\n  ['server.youtubeApiKey', ''],\n  ['site.protocol', 'http'],\n  ['site.domain', 'localhost:8080'],\n  ['site.pathPrefix', ''],\n  ['site.locale', 'en'],\n  ['site.dateFormat', 'MM/DD/YYYY hh:mm:ss'],\n  ['site.timeOffset', 0],\n  ['site.tripcodeSalt', ''],\n  ['site.vkontakte.accessToken', ''],\n  ['site.vkontakte.appId', ''],\n  ['site.vkontakte.integrationEnabled', false],\n  ['site.twitter.integrationEnabled', true],\n  ['site.ws.transports', ''],\n  ['site.maxSearchQueryLength', 50],\n  ['system.detectRealIp', true],\n  ['system.httpRequestTimeout', 60 * 1000], //NOTE: 1 minute\n  ['system.log.maxFiles', 100],\n  ['system.log.maxSize', 104857600], //NOTE: 100 MB\n  ['system.log.middleware.before', 'all'],\n  ['system.log.middleware.verbosity', 'ip'],\n  ['system.log.transports', ['console', 'file']],\n  ['system.maxFormFieldsSize', 5 * 1024 * 1024], //NOTE: 5 MB\n  ['system.mimeTypeRetrievingTimeout', 5 * 1000], //NOTE: 5 seconds\n  ['system.mongodb.uri_decode_auth', false],\n  ['system.mongodb.url', 'mongodb://127.0.0.1:27017/ololordjs'],\n  ['system.onlineCounter.interval', 60 * 1000], //NOTE: 1 minute\n  ['system.onlineCounter.quota', 5 * 60 * 1000], //NOTE: 5 minutes\n  ['system.phash.enabled', true],\n  ['system.redis.host', '127.0.0.1'],\n  ['system.redis.port', 6379],\n  ['system.redis.family', 4],\n  ['system.redis.password', ''],\n  ['system.redis.db', 0],\n  ['system.redis.enableReadyCheck', false],\n  ['system.redis.maxRedirections', 16],\n  ['system.redis.scaleReads', 'master'],\n  ['system.redis.retryDelayOnFailover', 100],\n  ['system.redis.retryDelayOnClusterDown', 100],\n  ['system.redis.retryDelayOnTryAgain', 100],\n  ['system.rendererWorkerCount', OS.cpus().length],\n  ['system.rerenderCacheOnStartup', false],\n  ['system.search.maxResultCount', 100],\n  ['system.search.maxResultPostSubjectLengh', 100],\n  ['system.search.maxResultPostTextLengh', 300],\n  ['system.tmpPath', `${__dirname}/../../tmp`],\n  ['system.useXRealIp', false],\n  ['system.workerCount', OS.cpus().length]\n]);\n\nlet configFileName = Program.configFile;\nif (configFileName) {\n  configFileName = Path.resolve(`${__dirname}/../..${configFileName}`);\n} else {\n  if (FSSync.existsSync(DEFAULT_CONFIG_FILE_NAME_1)) {\n    configFileName = Path.resolve(DEFAULT_CONFIG_FILE_NAME_1);\n  } else if (FSSync.existsSync(DEFAULT_CONFIG_FILE_NAME_2)) {\n    configFileName = Path.resolve(DEFAULT_CONFIG_FILE_NAME_2);\n  }\n}\n\nlet config = {};\nlet hooks = {};\n\nif (configFileName && FSSync.existsSync(configFileName)) {\n  console.log(`[${process.pid}] Using config file: \"${configFileName}\"…`);\n  config = FSWatcher.createWatchedResource(configFileName, (path) => {\n    return require(path);\n  }, async function(path) {\n    let oldConfig = config;\n    let id = require.resolve(path);\n    if (require.cache.hasOwnProperty(id)) {\n      delete require.cache[id];\n    }\n    let keys = _(oldConfig).reduce((acc, _1, key) => {\n      acc[key] = true;\n      return acc;\n    }, {});\n    _(config).each((_1, key) => { keys[key] = true; });\n    keys = _(keys).pick((_1, key) => { return hooks.hasOwnProperty(key); });\n    oldConfig = _(keys).reduce((acc, _1, key) => {\n      acc[key] = c(key);\n      return acc;\n    }, {});\n    config = require(id);\n    _(keys).each((_1, key) => {\n      hooks[key].forEach((hook) => {\n        hook(c(key), oldConfig[key], key);\n      });\n    });\n  }) || {};\n} else {\n  console.log(`[${process.pid}] Using default (empty) config…`);\n}\n\nfunction c(key, def) {\n  if (typeof def === 'undefined') {\n    def = DEFAULT_VALUES.get(key);\n  }\n  let parts = key.split('.');\n  let o = config;\n  while (parts.length > 0) {\n    if (typeof o !== 'object') {\n      return def;\n    }\n    o = o[parts.shift()];\n  }\n  return (typeof o !== 'undefined') ? o : def;\n}\n\nc.on = function(key, hook) {\n  if (typeof hook !== 'function') {\n    return this;\n  }\n  let list = hooks[key];\n  if (!list) {\n    list = [];\n    hooks[key] = list;\n  }\n  list.push(hook);\n  return this;\n};\n\nc.proxy = function() {\n  let proxy = c('system.fileDownloadProxy');\n  if (!proxy) {\n    return null;\n  }\n  let parts = proxy.split(':');\n  let auth = c('system.fileDownloadProxyAuth');\n  return {\n    host: parts[0],\n    port: (parts[1] ? +parts[1] : null),\n    auth: (auth ? `Basic ${new Buffer(auth).toString('base64')}` : null)\n  };\n};\n\nexport default c;\n"]}