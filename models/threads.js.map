{"version":3,"sources":["models/threads.js"],"names":[],"mappings":"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","file":"models/threads.js","sourcesContent":["import _ from 'underscore';\nimport FS from 'q-io/fs';\nimport mkpath from 'mkpath';\n\nimport * as BoardsModel from './boards';\nimport * as PostsModel from './posts';\nimport Board from '../boards/board';\nimport BoardController from '../controllers/board';\nimport * as Search from '../core/search';\nimport * as Cache from '../helpers/cache';\nimport * as Tools from '../helpers/tools';\nimport redisClient from '../storage/redis-client-factory';\nimport Hash from '../storage/hash';\nimport UnorderedSet from '../storage/unordered-set';\n\nlet ArchivedThreads = new Hash(redisClient(), 'archivedThreads');\nlet DeletedThreads = new UnorderedSet(redisClient(), 'deletedThreads', {\n  parse: false,\n  stringify: false\n});\nlet ThreadPostNumbers = new UnorderedSet(redisClient(), 'threadPostNumbers', {\n  parse: number => +number,\n  stringify: number => number.toString()\n});\nlet Threads = new Hash(redisClient(), 'threads');\nlet ThreadsPlannedForDeletion = new UnorderedSet(redisClient(), 'threadsPlannedForDeletion', {\n  parse: false,\n  stringify: false\n});\nlet ThreadUpdateTimes = new Hash(redisClient(), 'threadUpdateTimes', {\n  parse: false,\n  stringify: false\n});\n\nexport function sortThreadsByDate(t1, t2) {\n  if (!!t1.fixed === !!t2.fixed) {\n    return t2.updatedAt.localeCompare(t1.updatedAt);\n  } else {\n    return t1.fixed ? -1 : 1;\n  }\n}\n\nexport function sortThreadsByCreationDate(t1, t2) {\n  return t2.createdAt.localeCompare(t1.createdAt);\n}\n\nexport function sortThreadsByPostCount(t1, t2) {\n  return t2.postCount - t1.postCount;\n}\n\nexport async function getThreadPostCount(boardName, threadNumber) {\n  return await ThreadPostNumbers.count(`${boardName}:${threadNumber}`);\n}\n\nexport async function getThreadPostNumbers(boardName, threadNumber) {\n  let postNumbers = await ThreadPostNumbers.getAll(`${boardName}:${threadNumber}`);\n  return postNumbers.sort((a, b) => { return a - b; });\n}\n\nexport async function addThreadPostNumber(boardName, threadNumber, postNumber) {\n  await ThreadPostNumbers.addOne(postNumber, `${boardName}:${threadNumber}`);\n}\n\nexport async function removeThreadPostNumber(boardName, threadNumber, postNumber) {\n  await ThreadPostNumbers.deleteOne(postNumber, `${boardName}:${threadNumber}`);\n}\n\nasync function addDataToThread(thread, { withPostNumbers } = {}) {\n  thread.updatedAt = await ThreadUpdateTimes.getOne(thread.number, thread.boardName);\n  if (withPostNumbers) {\n    thread.postNumbers = await getThreadPostNumbers(thread.boardName, thread.number);\n  }\n}\n\nexport async function getThreadPosts(boardName, threadNumber,\n  { reverse, limit, notOP, withExtraData, withFileInfos, withReferences } = {}) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let threadPostNumbers = await getThreadPostNumbers(boardName, threadNumber);\n  let postNumbers = Tools.cloned(threadPostNumbers);\n  if (notOP) {\n    postNumbers.splice(0, 1);\n  }\n  if (reverse) {\n    postNumbers.reverse();\n  }\n  limit = Tools.option(limit, 'number', 0, { test: (l) => { return l > 0; } });\n  if (limit) {\n    postNumbers.splice(limit);\n  }\n  return await PostsModel.getPosts(boardName, postNumbers, { withExtraData, withFileInfos, withReferences });\n}\n\nexport async function getThreadNumbers(boardName, { archived } = {}) {\n  let source = archived ? ArchivedThreads : Threads;\n  return await source.keys(boardName);\n}\n\nexport async function getThread(boardName, threadNumber, options) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let thread = await Threads.getOne(threadNumber, boardName);\n  if (!thread) {\n    thread = await ArchivedThreads.getOne(threadNumber, boardName);\n  }\n  if (!thread) {\n    return Promise.reject(new Error(Tools.translate('No such thread')));\n  }\n  await addDataToThread(thread, options);\n  return thread;\n}\n\nexport async function getThreads(boardName, threadNumbers, options) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  if (!_(threadNumbers).isArray()) {\n    threadNumbers = [threadNumbers];\n  }\n  threadNumbers = threadNumbers.map((threadNumber) => {\n    return Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  });\n  if (threadNumbers.some(threadNumber => !threadNumber)) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let threads = await Threads.getSome(threadNumbers, boardName);\n  threads = _(threads).toArray();\n  let mayBeArchivedThreadNumbers = threads.map((thread, index) => {\n    return {\n      thread: thread,\n      index: index\n    };\n  }).filter((thread) => !thread.thread).map((thread) => {\n    return {\n      index: thread.index,\n      threadNumber: threadNumbers[thread.index]\n    };\n  });\n  if (mayBeArchivedThreadNumbers.length > 0) {\n    let numbers = mayBeArchivedThreadNumbers.map(thread => thread.threadNumber);\n    let archivedThreads = await ArchivedThreads.getSome(numbers, boardName);\n    archivedThreads.forEach((thread, index) => {\n      threads[mayBeArchivedThreadNumbers[index].index] = thread;\n    });\n  }\n  if (threads.length <= 0) {\n    return [];\n  }\n  await Tools.series(threads, async function(thread) {\n    await addDataToThread(thread, options);\n  });\n  return threads;\n}\n\nexport async function getThreadInfo(boardName, threadNumber, { lastPostNumber }) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let thread = await getThread(boardName, threadNumber, { withPostNumbers: true });\n  if (!thread) {\n    return thread;\n  }\n  let postCount = thread.postNumbers.length;\n  lastPostNumber = Tools.option(lastPostNumber, 'number', 0, { test: Tools.testPostNumber });\n  let newPostCount = thread.postNumbers.filter((pn) => { return pn > lastPostNumber; }).length;\n  return {\n    number: thread.number,\n    bumpLimit: board.bumpLimit,\n    postLimit: board.postLimit,\n    bumpLimitReached: (postCount >= board.bumpLimit),\n    postLimitReached: (postCount >= board.postLimit),\n    closed: thread.closed,\n    fixed: thread.fixed,\n    unbumpable: thread.unbumpable,\n    postCount: postCount,\n    postingEnabled: (board.postingEnabled && !thread.closed),\n    lastPostNumber: thread.postNumbers.pop(),\n    newPostCount: newPostCount\n  };\n}\n\nexport async function getThreadLastPostNumber(boardName, threadNumber) {\n  if (!Board.board(boardName)) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let threadPostNumbers = await getThreadPostNumbers(boardName, threadNumber);\n  return (threadPostNumbers.length > 0) ? _(threadPostNumbers).last() : 0;\n}\n\nexport async function getThreadUpdateTime(boardName, threadNumber) {\n  return await ThreadUpdateTimes.getOne(threadNumber, boardName);\n}\n\nexport async function getThreadsUpdateTimes(boardName, threadNumbers) {\n  return await ThreadUpdateTimes.getSome(threadNumbers, boardName);\n}\n\nexport async function setThreadUpdateTime(boardName, threadNumber, dateTme) {\n  await ThreadUpdateTimes.setOne(threadNumber, boardName, dateTme);\n}\n\nexport async function isThreadDeleted(boardName, threadNumber) {\n  return DeletedThreads.contains(`${boardName}:${threadNumber}`);\n}\n\nexport async function setThreadDeleted(boardName, threadNumber) {\n  return DeletedThreads.addOne(`${boardName}:${threadNumber}`);\n}\n\nexport async function clearDeletedThreads() {\n  return DeletedThreads.delete();\n}\n\nasync function removeThread(boardName, threadNumber, { archived, leaveFileInfos, leaveReferences } = {}) {\n  let source = archived ? ArchivedThreads : Threads;\n  let key = `${boardName}:${threadNumber}`\n  await ThreadsPlannedForDeletion.addOne(key);\n  await source.deleteOne(threadNumber, boardName);\n  await ThreadUpdateTimes.deleteOne(threadNumber, boardName);\n  setTimeout(async function() {\n    try {\n      let postNumbers = await getThreadPostNumbers(boardName, threadNumber);\n      await ThreadPostNumbers.delete(key);\n      await Tools.series(postNumbers, async function(postNumber) {\n        return await PostsModel.removePost(boardName, postNumber, {\n          leaveFileInfos: leaveFileInfos,\n          leaveReferences: leaveReferences,\n          removingThread: true\n        });\n      });\n      await ThreadsPlannedForDeletion.deleteOne(key);\n    } catch (err) {\n      Logger.error(err.stack || err);\n    }\n  }, 5000); //TODO: magic numbers\n}\n\nasync function pushOutOldThread(boardName) {\n  let threadNumbers = await getThreadNumbers(boardName);\n  let threads = await getThreads(boardName, threadNumbers);\n  threads.sort(sortThreadsByDate);\n  if (threads.length < board.threadLimit) {\n    return;\n  }\n  let archivedThreadNumbers = await getThreadNumbers(boardName, { archived: true });\n  let archivedThreads = await getThreads(boardName, archivedThreadNumbers);\n  archivedThreads.sort(sortThreadsByDate);\n  if (archivedThreads.length > 0 && archivedThreads.length >= board.archiveLimit) {\n    await removeThread(boardName, archivedThreads.pop().number, { archived: true });\n  }\n  let thread = threads.pop();\n  if (board.archiveLimit <= 0) {\n    await removeThread(boardName, thread.number);\n    return;\n  }\n  thread.archived = true;\n  await ArchivedThreads.setOne(thread.number, thread, boardName);\n  await Threads.deleteOne(thread.number, boardName);\n  let postNumbers = await getThreadPostNumbers(boardName, thread.number);\n  await Tools.series(postNumbers, async function(postNumber) {\n    await Search.updatePostIndex((body) => {\n      body.archived = true;\n      return body;\n    });\n  });\n  //NOTE: This is for the sake of speed.\n  (async function() {\n    try {\n      let archivePath = `${__dirname}/../public/${boardName}/arch`;\n      let oldThreadNumber = thread.number;\n      await mkpath(archivePath);\n      let sourceId = `${boardName}/res/${oldThreadNumber}.json`;\n      let data = await Cache.readFile(sourceId);\n      let model = JSON.parse(data);\n      model.thread.archived = true;\n      await FS.write(`${archivePath}/${oldThreadNumber}.json`, JSON.stringify(model));\n      await BoardController.renderThreadHTML(model.thread, {\n        targetPath: `${archivePath}/${oldThreadNumber}.html`,\n        archived: true\n      });\n      await Cache.removeFile(sourceId);\n      await Cache.removeFile(`${boardName}/res/${oldThreadNumber}.html`);\n    } catch (err) {\n      Logger.error(err.stack || err);\n    }\n  })();\n}\n\nexport async function createThread(req, fields, files, transaction) {\n  let { boardName, password } = fields;\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  if (!board.postingEnabled) {\n    return Promise.reject(new Error(Tools.translate('Posting is disabled at this board')));\n  }\n  date = date || Tools.now();\n  password = Tools.sha1(password);\n  hashpass = (req.hashpass || null);\n  let threadNumber = await BoardsModel.nextPostNumber(boardName);\n  let thread = {\n    archived: false,\n    boardName: boardName,\n    closed: false,\n    createdAt: date.toISOString(),\n    fixed: false,\n    unbumpable: false,\n    number: threadNumber,\n    user: {\n      hashpass: hashpass,\n      ip: req.ip,\n      level: req.level(boardName),\n      password: password\n    }\n  };\n  transaction.setThreadNumber(threadNumber);\n  await Threads.setOne(threadNumber, thread, boardName);\n  return thread;\n}\n\nexport async function moveThread(sourceBoardName, threadNumber, targetBoardName) {\n  let targetBoard = Board.board(targetBoardName);\n  if (!targetBoard || !Board.board(sourceBoardName)) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    throw new Error(Tools.translate('Invalid thread number'));\n  }\n  let thread = await getThread(sourceBoardName, threadNumber, { withPostNumbers: true });\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  let sourcePath = `${__dirname}/../public/${sourceBoardName}/src`;\n  let sourceThumbPath = `${__dirname}/../public/${sourceBoardName}/thumb`;\n  let targetPath = `${__dirname}/../public/${targetBoardName}/src`;\n  let targetThumbPath = `${__dirname}/../public/${targetBoardName}/thumb`;\n  await mkpath(targetPath);\n  await mkpath(targetThumbPath);\n  delete thread.updatedAt;\n  let posts = await PostsModel.getPosts(sourceBoardName, thread.postNumbers, {\n    withFileInfos: true,\n    withReferences: true,\n    withExtraData: true\n  });\n  delete thread.postNumbers;\n  let lastPostNumber = await BoardsModel.nextPostNumber(targetBoardName, posts.length);\n  lastPostNumber = lastPostNumber - posts.length + 1;\n  thread.number = lastPostNumber;\n  let postNumberMap = posts.reduce((acc, post) => {\n    acc.set(post.number, lastPostNumber++);\n    return acc;\n  }, new Map());\n  let { toRerender, toUpdate } = await PostsModel.processMovedThreadPosts({\n    posts: posts,\n    postNumberMap: postNumberMap,\n    threadNumber: thread.number,\n    targetBoard: targetBoard,\n    sourceBoardName: sourceBoardName,\n    sourcePath: sourcePath,\n    sourceThumbPath: sourceThumbPath,\n    targetPath: targetPath,\n    targetThumbPath: targetThumbPath\n  });\n  await Threads.setOne(thead.number, thread, targetBoardName);\n  let threadKey = `${targetBoardName}:${thread.number}`;\n  await ThreadUpdateTimes.setOne(threadKey, Tools.now().toISOString());\n  await ThreadPostNumbers.addSome(_(postNumberMap).toArray(), threadKey);\n  await PostsModel.processMovedThreadRelatedPosts({\n    posts: toRerender,\n    sourceBoardName: sourceBoardName,\n    postNumberMap: postNumberMap\n  });\n  await Tools.series(toUpdate, async function(o) {\n    return await IPC.render(o.boardName, o.threadNumber, o.threadNumber, 'create');\n  });\n  await removeThread(sourceBoardName, threadNumber, {\n    leaveFileInfos: true,\n    leaveReferences: true\n  });\n  IPC.render(sourceBoardName, threadNumber, threadNumber, 'delete');\n  await IPC.render(targetBoardName, thread.number, thread.number, 'create');\n  return {\n    boardName: targetBoardName,\n    threadNumber: thread.number\n  };\n}\n\nexport async function setThreadFixed(boardName, threadNumber, fixed) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  fixed = !!fixed;\n  if (fixed === !!thread.fixed) {\n    return;\n  }\n  thread.fixed = fixed;\n  await Threads.setOne(threadNumber, thread, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n\nexport async function setThreadClosed(boardName, threadNumber, closed) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  closed = !!closed;\n  if (closed === !!thread.closed) {\n    return;\n  }\n  thread.closed = closed;\n  await Threads.setOne(threadNumber, thread, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n\nexport async function setThreadUnbumpable(boardName, threadNumber, unbumpable) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  unbumpable = !!unbumpable;\n  if (unbumpable === !!thread.unbumpable) {\n    return;\n  }\n  thread.unbumpable = unbumpable;\n  await Threads.setOne(threadNumber, thread, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n"],"sourceRoot":"/source/"}