{"version":3,"sources":["models/chats.js"],"names":[],"mappings":";;;;;;;;sDA4BO,kBAA+B,IAA/B,EAAqC,eAArC;AAAA,QAED,IAFC,EAGD,IAHC,EAID,IAJC,EAKD,KALC;AAAA;AAAA;AAAA;AAAA;AACL,8BAAkB,CAAE,IAAI,IAAJ,CAAS,eAAT,CAAF,IAAgC,CAAlD;AACI,gBAFC,GAEM,eAAe,IAAf,CAFN;AAGD,gBAHC,GAGM,MAAM,GAAN,GAAY,WAAZ,EAHN;AAAA;AAAA,mBAIY,MAAM,MAAN,CAAa,IAAb,CAJZ;;AAAA;AAID,gBAJC;AAAA;AAAA,mBAKa,MAAM,MAAN,CAAa,IAAb;AAAA,kEAAmB,iBAAe,GAAf;AAAA,oBAC/B,IAD+B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAClB,KAAK,cAAL,CAAoB,eAApB,EAAqC,QAArC,EAA+C,GAA/C,CADkB;;AAAA;AAC/B,4BAD+B;AAAA,yDAE5B,CAAC,QAAQ,EAAT,EAAa,GAAb,CAAiB,UAAC,GAAD,EAAS;AAC/B,iCAAO;AACL,kCAAM,IAAI,IADL;AAEL,kCAAM,IAAI,IAFL;AAGL,kCAAQ,SAAS,IAAI,UAAd,GAA4B,KAA5B,GAAoC;AAHtC,2BAAP;AAKD,yBANM,CAF4B;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAAnB;;AAAA;AAAA;AAAA;AAAA,iBASf,EATe,CALb;;AAAA;AAKD,iBALC;AAAA,8CAeE;AACL,+BAAiB,IADZ;AAEL,qBAAO,0BAAE,KAAF,EAAS,IAAT,CAAc,UAAC,IAAD,EAAU;AAAE,uBAAO,KAAK,MAAL,GAAc,CAArB;AAAyB,eAAnD;AAFF,aAfF;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;kBAAe,e;;;;;AA5BtB;;;;AACA;;;;AAEA;;;;AAGA;;;;AACA;;;;AAEA;;IAAY,K;;;;;;;;;;;;;;AAGZ,IAAI,OAAO,yBAAe,mCAAf,EAA8B,MAA9B,CAAX;AACA,IAAI,QAAQ,2BAAiB,mCAAjB,EAAgC,OAAhC,EAAyC;AACnD,SAAO,KAD4C;AAEnD,aAAW;AAFwC,CAAzC,CAAZ;;;;;;AASA,SAAS,cAAT,CAAwB,IAAxB,EAA8B;AAC5B,MAAI,SAAS,iBAAO,UAAP,CAAkB,QAAlB,CAAb;AACA,SAAO,MAAP,CAAc,KAAK,QAAL,IAAiB,KAAK,EAApC;AACA,SAAO,OAAO,MAAP,CAAc,KAAd,CAAP;AACD","file":"models/chats.js","sourcesContent":["import _ from 'underscore';\nimport Crypto from 'crypto';\n\nimport redisClient from '../storage/redis-client-factory';\n//import Hash from '../storage/hash';\n//import Key from '../storage/key';\nimport OrderedSet from '../storage/ordered-set';\nimport UnorderedSet from '../storage/unordered-set';\n//import Board from '../boards';\nimport * as Tools from '../helpers/tools';\n\n//let FileInfos = new Hash(redisClient(), 'fileInfos');\nlet Chat = new OrderedSet(redisClient(), 'chat');\nlet Chats = new UnorderedSet(redisClient(), 'chats', {\n  parse: false,\n  stringify: false\n});\n/*let Posts = new Hash(redisClient(), 'posts');\nlet ReferringPosts = new Hash(redisClient(), 'referringPosts');\nlet ReferencedPosts = new Hash(redisClient(), 'referencedPosts');\nlet UserBans = new Key(redisClient(), 'userBans');*/\n\nfunction createUserHash(user) {\n  let sha256 = Crypto.createHash('sha256');\n  sha256.update(user.hashpass || user.ip);\n  return sha256.digest('hex');\n}\n\nexport async function getChatMessages(user, lastRequestDate) {\n  lastRequestDate = +(new Date(lastRequestDate)) || 0;\n  let hash = createUserHash(user);\n  let date = Tools.now().toISOString();\n  let keys = await Chats.getAll(hash);\n  let chats = await Tools.series(keys, async function(key) {\n    let list = await Chat.getSomeByScore(lastRequestDate, Infinity, key);\n    return (list || []).map((msg) => {\n      return {\n        text: msg.text,\n        date: msg.date,\n        type: ((hash === msg.senderHash) ? 'out' : 'in')\n      };\n    });\n  }, {});\n  return {\n    lastRequestDate: date,\n    chats: _(chats).pick((list) => { return list.length > 0; })\n  };\n}\n"],"sourceRoot":"/source/"}