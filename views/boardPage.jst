<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
{{#def.head}}
<body {{#def.baseData}} data-current-page="{{=it.currentPage}}" data-page-count="{{=it.pageCount}}">
<script id="model-postformRules" type="application/json">{{ out += JSON.stringify(it.postformRules); }}</script>
{{? it.site.vkontakte.integrationEnabled }}
    <script type="text/javascript">
        VK.init({ apiId: {{=it.site.vkontakte.appId}} });
    </script>
{{?}}
<div id="hiddenPostForm" style="display: none;"></div>
{{? it.board.captchaEnabled}}
    <div id="hiddenCaptcha" style="display: none;"></div>
{{?}}
{{~["top", "bottom"] :target}}
    {{#def.navigationButton}}
{{~}}
{{~["previous", "next"] :target}}
    {{#def.leafButton}}
{{~}}
<a id="top"></a>
{{#def.toolbar}}
{{#def.player}}
{{#def.customHeader}}
{{#def.searchAction}}
{{#def.banner}}
<div class="theTitle">
    <h1>
        {{=it.board.title}}
        <a href="/{{=it.site.pathPrefix}}{{=it.board.name}}/catalog.html"
           title="{{=it.tr.boardCatalogLinkText}}"><img src="/{{=it.site.pathPrefix}}img/catalog.png"
                                                        class="buttonImage" width="24" height="24"></a>
        <a href="/{{=it.site.pathPrefix}}{{=it.board.name}}/archive.html"
           title="{{=it.tr.boardArchiveLinkText}}"><img src="/{{=it.site.pathPrefix}}img/archive.png"
                                                        class="buttonImage" width="24" height="24"></a>
        <a href="/{{=it.site.pathPrefix}}{{=it.board.name}}/rss.xml" target="_blank"
           title="{{=it.tr.boardRssLinkText}}"><img src="/{{=it.site.pathPrefix}}img/rss.png" class="buttonImage"
                                                    width="24" height="24"></a>
    </h1>
</div>
<script type="text/javascript">
    (function() {
        var model = lord.model(["tr", "board/" + lord.data("boardName")]);
        model.settings = lord.settings();
        document.open();
        document.write(lord.template("boardPageUpper", model, true));
        document.close();
    })();
</script>
<div id="threads">
    {{~it.threads :thread}}
        <hr />
        <div id="thread{{=thread.opPost.number}}" class="thread"{{? thread.expanded}} data-expanded="true"{{?}}>
            {{~[thread.opPost] :post}}
                {{#def.post}}
            {{~}}
            {{? thread.omittedPosts > 0}}
                <div class="omittedPosts">
                    {{=it.tr.omittedPostsText}} {{=thread.omittedPosts}}   
                </div>
            {{?}}
            <div class="threadPosts">
                {{~thread.lastPosts :post}}
                    {{#def.post}}
                {{~}}
            </div>
        </div>
    {{~}}
</div>
<script type="text/javascript">
    (function() {
        var infScroll = lord.getLocalObject("infiniteScroll", lord.deviceType("mobile"));
        if (infScroll) {
            var w = $(window);
            var loading = false;
            var infiniteScrollPage;
	        w.scroll(function() {
	            if (loading)
	                return;
	            var pageCount = +lord.data("pageCount");
	            if (isNaN(infiniteScrollPage))
    	            infiniteScrollPage = +lord.data("currentPage");
    	        if (infiniteScrollPage >= pageCount - 1)
    	            return;
    		    if ($(document).height() - w.height() == w.scrollTop()) {
    		        loading = true;
    		        ++infiniteScrollPage;
                    $("#infiniteScrollLoading").show();
                    lord.api(infiniteScrollPage, {}, lord.data("boardName")).then(function(pageModel) {
                        var threads = pageModel.threads.filter(function(thread) {
                            return !lord.id("thread" + thread.opPost.number);
                        });
                        var model = lord.model(["base", "tr", "boards", "board/" + lord.data("boardName")]);
                        var html = threads.map(function(thread) {
                            model.thread = thread;
                            return "<hr />" + lord.template("thread", model, true);
                        }).join("");
                        $("#infiniteScrollLoading").hide();
                        lord.id("threads").innerHTML += html;
                        return lord.series(threads.map(function(thread) {
                            return lord.id("thread" + thread.opPost.number);
                        }), function(thread) {
                            return lord.processPosts(thread);
                        });
                    }).then(function() {
                        lord.initFiles();
                        $("#infiniteScrollLoading").hide();
                        loading = false;
                    }).catch(function(err) {
                        $("#infiniteScrollLoading").hide();
                        loading = false;
                        lord.handleError(err);
                    });
		        }
	        });
        }
        var model = lord.model(["tr", "board/" + lord.data("boardName")]);
        model.settings = lord.settings();
        document.open();
        var s = lord.template("boardPageLower", model, true);
        if (infScroll) {
            s += '<div id="infiniteScrollLoading" class="loadingMessage" style="display: none;">'
                + '<img src="/{{=it.site.pathPrefix}}img/loading_big.gif">'
                + '<h1 style="display: inline;">{{=it.tr.loadingThreadsMessage}}</h1>'
                + '</div>';
        }
        document.write(s);
        document.close();
    })();
</script>
<hr />
<script type="text/javascript">
    (function() {
        var model = lord.model(["base", "tr", "board/" + lord.data("boardName")]);
        model.pageCount = +lord.data("pageCount");
        model.currentPage = +lord.data("currentPage");
        document.open();
        document.write(lord.template("pagination", model, true));
        document.close();
    })();
</script>
{{#def.navbar}}
<hr />
{{#def.postingSpeed}}
<a id="bottom"></a>
{{#def.customFooter}}
</body>
</html>
